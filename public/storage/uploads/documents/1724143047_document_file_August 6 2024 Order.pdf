entationCommon.QFPERFPING_INVALID_MEASURE);t._clientTelemetry&&t._clientTelemetry.logNewKeystrokeMeasure(f,u,r);t.updatePageIG(i);t.fireKeystrokeTimelineUpdatedHandlers(s);(n.config.enableMRUFilesAndFoldersTelemetry||n.config.disableMRUFilesAndFoldersWildCards)&&(n.Host.setMRUFilesAndFoldersDefinedCount(0),n.Host.setMRUFilesAndFoldersUndefinedCount(0))}static setSearchServiceStatus(n){t._searchServiceStatus=n}static instrumentResponseReceived(i,r,u,f,e,o){t.safeInstrumentPerf(i,i=>{if(!e){let u=t.getOffsettedNow();typeof i.ResponseReceived[r]!="number"?(i.ResponseReceived[r]=u,n.config.useWhereId&&r=="IFF"):(i.MultipleResponsesReceived[r]||(i.MultipleResponsesReceived[r]=[i.ResponseReceived[r]]),i.MultipleResponsesReceived[r].push(u))}u&&(i.DataSourcesState=i.DataSourcesState||{},i.DataSourcesState[r]=u);f&&(i.ResponseFromCache[r]=f)},"instrumentResponseReceived",r);n.config.perfInstV2&&t.safeInstrumentPerf(i,n=>{o||(n.DataProvidersFinished[r]=t.getOffsettedNow(),n.DataProviderFetchFinish<n.DataProvidersFinished[r]&&(n.DataProviderFetchFinish=n.DataProvidersFinished[r])),u&&(n.DataSourcesState=n.DataSourcesState||{},n.DataSourcesState[r]=u),f&&(n.ResponseFromCache[r]=f)},"instrumentResponseReceived",r)}static instrumentTopResultRendered(i,r,u){t.safeInstrumentPerf(i,f=>{let e=t.getOffsettedNow(),o="T"+r.join(",");if(f.renderGroupFinished[o])u||(f.renderGroupFinished[o].iconsFinished=e);else{if(f.TopResultRendered.push({V:e,T:r.join(",")}),t._clientTelemetry){let n=e-f.RequestBegin;t._clientTelemetry.logTopResultsRenderedMeasure(f.RawImpressionGuid,r,n)}f.renderGroupFinished[o]={iconsFinished:e,suggestionsFinished:e}}t.tryInstrumentRenderStopped(i,f);n.MockUrlParameters&&n.safeFireEvent("TopResultRendered")},"instrumentTopResultRendered")}static instrumentRenderedLocalSuggestion(n,i){let u=t._keystrokesInstrumentationData[n];if(u){let n={},t={};for(var r=0;r<i.length;r++)i[r].type=="FV"?n[r]="TBD":i[r].type=="HU"&&(t[r]="TBD");u.FvSug=n;u.HuSug=t}}static instrumentAggregatorCall(i){t.safeInstrument(i,i=>{let r={fastRankModelId:t._instrumentationProvider.getRankerModelId()};for(let n in i.RankerExtraInfo)r[n]=i.RankerExtraInfo[n];i.RankerExtraInfo={};let u={T:"D.Aggregator",Service:n.InstrumentationCommon.DEFAULT_SERVICE_NAME,Scenario:"Aggregator",AppNS:n.InstrumentationCommon.DEFAULT_APP_NAMESPACE,DS:[],rankerModelIds:r};i.DataSources.aggregator=u},"instrumentAggregatorCall")}static instrumentDSB(){t.safeInstrument(n.SequenceNumberManager.getSequenceNumber(),t=>{let r=n.dsbManager.getInstrumentedProps(),u=[],i=null;if(r){for(let t=0;t<r.length;t++){let e=r[t],f=e===null||e===void 0?void 0:e.instrumentedItem,o=e===null||e===void 0?void 0:e.subItemInstrumentedItems;if(o&&o.length>0)for(let t=0;t<o.length;t++){let i=o[t],r={T:"D.url",Val:i===null||i===void 0?void 0:i.getQsCode(),Ho:i===null||i===void 0?void 0:i.getHandoffType(),Gr:n.GroupType.DSBGroup,K:i===null||i===void 0?void 0:i.getKValue()};(i===null||i===void 0?void 0:i.getProperties())&&(r.Properties=i.getProperties());u.push(r)}i===null&&(i=f===null||f===void 0?void 0:f.getWorkflow());let s=f===null||f===void 0?void 0:f.getProperties(),h={T:"D.url",Val:f===null||f===void 0?void 0:f.getQsCode(),Ho:f===null||f===void 0?void 0:f.getHandoffType(),Gr:n.GroupType.DSBGroup,K:f===null||f===void 0?void 0:f.getKValue()};s&&(h.Properties=s);u.push(h)}let f=Object.assign(Object.assign({T:"D.DSB",Service:n.InstrumentationCommon.DEFAULT_SERVICE_NAME,Scenario:n.shouldShowDSBFullWidth()?"DSBFW":"DSBSC",AppNS:n.InstrumentationCommon.DEFAULT_APP_NAMESPACE},i?{Workflow:i}:undefined),{DS:u});t.DataSources.dsb=f}},"instrumentDSB")}static addDuplicatesDataSource(t){let i=Object.keys(t.DuplicateDS).map(n=>t.DuplicateDS[n]);i.length>0&&(t.DataSources.duplicates={T:"D.Duplicates",Service:n.InstrumentationCommon.DEFAULT_SERVICE_NAME,Scenario:"Duplicates",AppNS:n.InstrumentationCommon.DEFAULT_APP_NAMESPACE,DS:i})}static instrumentDuplicate(i,r,u){t.safeInstrument(i,t=>{let i=t.DuplicateDS[r.instItem.getHValue()];i||(i={T:"D.Duplicate",DS:[{T:"D.DSRef",KRef:r.instItem.getKValue()}]},r.instItem.getAppNS()!=n.InstrumentationCommon.DEFAULT_APP_NAMESPACE&&(i.DS[0].AppNS=r.instItem.getAppNS()),t.DuplicateDS[r.instItem.getHValue()]=i);let f={T:"D.DSRef",KRef:u.instItem.getKValue()};u.instItem.getAppNS()!=n.InstrumentationCommon.DEFAULT_APP_NAMESPACE&&(f.AppNS=u.instItem.getAppNS());i.DS.push(f)},"instrumentDuplicate")}static renderingStopped(n){return n.PendingIcons==0&&n.AllDataSourcesProcessed&&n.PreviewPanePendingInfo==null}static notifyAllDataSourcesProcessed(n){t.safeInstrumentPerf(n,i=>{i.AllDataSourcesProcessed=!0,t.tryInstrumentRenderStopped(n,i)},"notifyAllDataSourcesProcessed")}static notifyIconPending(n,i,r){t.safeInstrumentPerf(n,n=>{n.PendingIcons++},"notifyIconPending",(i?"TR":"SUG")+" From "+(r?r:"unknown"))}static notifyIconReadyOrFailed(n,i,r){t.safeInstrumentPerf(n,n=>{n.PendingIcons--},"notifyIconReadyOrFailed",(i?"TR":"SUG")+" From "+(r?r:"unknown"))}static notifyPreviewPaneStartRender(i){n.config.perfInstV2&&t.safeInstrumentPerf(i,n=>{n.PreviewPaneStart=t.getOffsettedNow()},"previewPaneStart")}static notifyPreviewPanePending(n,i,r){let u=t._keystrokesPerfPingData[n];u&&(u.PreviewPanePendingInfo={previewPaneType:i,suggestionType:r})}static tryInstrumentRenderStopped(i,r){t.renderingStopped(r)&&(t.finalizeKeystrokeLog(i,2),t.logMemoryUsageInWSBClient(i,"RenderStopped"),n.TestHookUrlParameters&&n.safeFireEvent("RenderStopped"))}static logMemoryUsageInWSBClient(i,r){var u;if(SearchAppWrapper.CortanaApp.systemInfo){let f=SearchAppWrapper.CortanaApp.systemInfo;const s=typeof BingAtWork=="undefined"?"":(u=BingAtWork.context)===null||u===void 0?void 0:u.midgardVersion,e=t._instrumentationProvider.getWebView2Info(),o=f.totalCommitMB;let h="TotalCommitMB:"+o+",TotalWorkingSetMB:"+f.totalWorkingSetMB+",SnrVersion:"+n.config.snrVersion+",MsbVersion:"+s+",IsWebView2:"+(e.isWebView2?1:0)+",WebView2Version:"+e.webView2Version;n.Host.setSearchAppMemoryCommitMB(o);t._instrumentationProvider.logProfilerMarker(1,0,r,t.getRawImpressionGuid(i),h)}}static isLayoutLogged(n){return t._keystrokesInstrumentationData[n].MasterPageImpressionCreated}static finalizeKeystrokeLog(n,i=0){t._finalizeKeystrokeHandlers.forEach(n=>n(i==0));let r=t._keystrokesInstrumentationData[n];if(r&&t.logKeystrokeData(r,n),i!=1){let i=t._keystrokesPerfPingData[n];i&&(t.logPerfPingEvent(t.createKeystrokePerfPingEvent(n,i)),t._clientTelemetry&&t._clientTelemetry.logDataSourcePerformancesMeasure(i),t.fireKeystrokeTimelineUpdatedHandlers(i))}}static instrumentZiRendered(i,r,u){r&&t.logMemoryUsageInWSBClient(i,"ZiRendered");n!==undefined&&n.config.perfLogging&&n.WSBPerformance&&n.WSBPerformance.getInstance().endMark("RenderZeroInput");let f=u?u:null;t.safeInstrumentPerf(i,n=>{n.SearchHomeRenderEvent=t.getOffsettedNow()},"instrumentSearchHomeRender",f)}static instrumentRenderFinished(i,r,u,f,e){if(n.config.perfInstV2&&(t===null||t===void 0?void 0:t._currentRender)<0)n.LogWSBError("instrumentRenderFinished","sequenceNumber: "+i,new Error("Invalid current render for sequence number"),undefined,undefined,"WindowsTelemetry");else if(n.config.perfInstV2&&t._keystrokesPerfPingData[i]==undefined)n.LogWSBError("instrumentRenderFinished","sequenceNumber: "+i+" currentRender: "+t._currentRender,new Error("No keystrokesPerfPingData for sequence number"),undefined,undefined,"WindowsTelemetry");else if(e||t._keystrokesPerfPingData[i].FirstRenderTime||(t._keystrokesPerfPingData[i].FirstRenderTime=t.getOffsettedNow()),n.config.perfInstV2){if(t._keystrokesPerfPingData[i].RendersCompleted[t._currentRender]=t.getOffsettedNow(),(n.config.disableMRUFilesAndFoldersWildCards||n.config.enableMRUFilesAndFoldersTelemetry)&&(n.Host.getMRUFilesAndFoldersDefinedCount()>-1&&(t._keystrokesPerfPingData[i].MRUFilesAndFoldersDefinedCount=n.Host.getMRUFilesAndFoldersDefinedCount()),n.Host.getMRUFilesAndFoldersUndefinedCount()>-1&&(t._keystrokesPerfPingData[i].MRUFilesAndFoldersUndefinedCount=n.Host.getMRUFilesAndFoldersUndefinedCount())),n.isAnaheimDataEnabled(!0)||n.isAnaheimDataEnabled(!1)){if(n.AnaheimDataProvider&&n.AnaheimDataProvider.InstrumentStringNumber){let r=n.AnaheimDataProvider.InstrumentStringNumber;for(let n in r)t._keystrokesPerfPingData[i].AnaheimDataIndexCount[n]=r[n]}if(n.AnaheimDataProviderV2&&n.AnaheimDataProviderV2.InstrumentStringNumber){let r=n.AnaheimDataProviderV2.InstrumentStringNumber;for(let n in r)t._keystrokesPerfPingData[i].AnaheimDataIndexCount[n]=r[n]}if(n.AnaheimDataParser===null||n.AnaheimDataParser===void 0?void 0:n.AnaheimDataParser.getANANumberMap){let r=n.AnaheimDataParser.getANANumberMap();for(let n in r)t._keystrokesPerfPingData[i].AnaheimDataIndexCount[n]=r[n]}}t._currentRender++}t.safeInstrumentPerf(i,n=>{let e=t.getOffsettedNow(),o="S"+r.join(",");n.renderGroupFinished[o]?f||(n.renderGroupFinished[o].iconsFinished=e):(r.forEach(t=>n.RenderFinished[t]=e),n.renderGroupFinished[o]={iconsFinished:e,suggestionsFinished:e});t.tryInstrumentRenderStopped(i,n);t._clientTelemetry&&t._clientTelemetry.logGroupsRenderedMeasure(u)},"instrumentRenderFinished",r.join(","));let o=t._keystrokesPerfPingData[i];o&&t.fireKeystrokeTimelineUpdatedHandlers(o)}static instrumentSyntheticInstrumentedItem(i,r,u){let f=t._keystrokesInstrumentationData[i];f?f.PendingInstrumentedItems[r]=u:n.LogWSBError("instrumentSyntheticInstrumentedItem",r,new Error("keystrokesInstrumentationData not found"),undefined,undefined,"WindowsTelemetry")}static instrumentSyntheticSuggestion(i,r){let u=t._keystrokesInstrumentationData[i];u?u.PendingSyntheticSuggestions[r.type]=r:n.LogWSBError("instrumentSyntheticSuggestion",r.type,new Error("Instrumentation synthetic suggestion after flush"),undefined,undefined,"WindowsTelemetry")}static getInstrumentedSyntheticSuggestion(n,i){return t._keystrokesInstrumentationData[n].PendingSyntheticSuggestions[i]}static instrumentDataSource(i,r,u,f){t.safeInstrument(i,t=>{if(f&&f.rankerExtraInfo)for(let n in f.rankerExtraInfo)t.RankerExtraInfo[n]=f.rankerExtraInfo[n];let i=u||[];if(n.config.splitWindowsDataInstrumentation&&n.config.pruneImpression)for(let u of i){if(n.isWindowsData(u.type))return;t.PendingDataSources[r]?t.PendingDataSources[r].push(u):t.PendingDataSources[r]=[u]}else{let n=t.PendingDataSources[r];t.PendingDataSources[r]=n?n.concat(i):i}},"instrumentDataSource",r)}static processPendingDataSources(i){for(let r in i.PendingDataSources){let u=i.PendingDataSources[r];if(u.length>0){let f=[];for(let n of u){f.push(t._instrumentationProvider.createDataSourceObject(n));for(let i of n.subInstItems||[])f.push(t._instrumentationProvider.createDataSourceObject(n,i))}r=="Web"&&(r="WebAS");f.length>0&&(i.DataSources[r]={T:"D."+r,AppNS:n.InstrumentationCommon.DEFAULT_APP_NAMESPACE,Service:n.InstrumentationCommon.DEFAULT_SERVICE_NAME,Scenario:r,SC:f.length,DS:f})}}i.PendingDataSources={}}static instrumentDwell(i){var r;const f=n.SequenceNumberManager.getSequenceNumber();let u=n.InstrumentedItem.createInstrumentedItem(f,"WSNR"),e=n.isZeroInputAllScope(n.Host.getQuery())?"ZI":"QF";u.setUserEngagementContent({engagementType:"Dwell",engagementSurface:e,dwellTime:i});(r=t._clientTelemetry)===null||r===void 0?void 0:r.logItemDwellMeasure(n.Host.getRawImpressionGuid(),u)}static instrumentSnRProviderFetchUrl(n,i){t.safeInstrument(n,n=>{n.SnRProviderFetchUrl=i},"instrumentSnRProviderFetchUrl")}static onConversationStart(){if(t._conversationStartTimestamp=n.getCurrentTime(),t._searchServiceStatus=null,t._clientTelemetry){let i=n.Host.getConversationId();t._clientTelemetry.logConversationStartMeasure(i)}t._keystrokesPerfPingData=[];t._currentRender=0}static getConversationStartTimestamp(){return t._conversationStartTimestamp}static logDataSourceTimeout(n,i){t._instrumentationProvider.logDataSourceTimeout(n,i)}static getPpoFromPpi(n){return typeof n.latency=="number"?{L:n.latency,T:n.previewPaneType}:{}}static createKeystrokePerfPingEvent(i,r){let u={I:i,PL:r.PrefixLength,K:r.RequestBegin,F:r.DataSourcesFetchEnd,PPO:t.getPpoFromPpi(r.PreviewPaneOpened),PPC:t.getPpoFromPpi(r.PreviewPaneCanceled),RRT:r.ResponseReceived,RPT:r.ResponseParsed,MRT:r.MultipleResponsesReceived,RFT:r.RenderFinished,TRR:r.TopResultRendered,RS:undefined,PLT:undefined,HLT:undefined,FRT:undefined,IRFT:{},TRIR:[],MPT:r.MultipleResponsesParsed,CS:n.config.perfInstV2?r.ConversationStart:undefined,KS:n.config.perfInstV2?r.SequenceStart:undefined,RB:n.config.perfInstV2?r.RequestBegin:undefined,FS:n.config.perfInstV2?r.DataProviderFetchStart:undefined,FF:n.config.perfInstV2?r.DataProviderFetchFinish:undefined,PST:n.config.perfInstV2?r.DataProvidersStarted:undefined,PFT:n.config.perfInstV2?r.DataProvidersFinished:undefined,RC:n.config.perfInstV2?r.RendersCompleted:undefined,RCR:undefined,PS:n.config.perfInstV2?r.PreviewPaneStart:undefined,PF:n.config.perfInstV2?r.PreviewPaneFinish:undefined,ANA:n.config.perfInstV2&&(n.config.enableAnaheimDataSH||n.config.enableAnaheimDataQF)?r.AnaheimDataIndexCount:undefined,MRUFAF:n.config.perfInstV2&&(n.config.enableMRUFilesAndFoldersTelemetry||n.config.disableMRUFilesAndFoldersWildCards)?r.MRUFilesAndFoldersDefinedCount:undefined,MRUFAFU:n.config.perfInstV2&&(n.config.enableMRUFilesAndFoldersTelemetry||n.config.disableMRUFilesAndFoldersWildCards)?r.MRUFilesAndFoldersUndefinedCount:undefined};for(let n in r.renderGroupFinished){let t=r.renderGroupFinished[n];if(t.iconsFinished!=t.suggestionsFinished){let i=n.substr(1);if(n.startsWith("T"))u.TRIR.push({T:i,V:t.iconsFinished});else{let n=i.split(",");for(let i of n)u.IRFT[i]=Math.max(t.iconsFinished,u.IRFT[i]||0)}}}if(t.renderingStopped(r)){let t=0;for(let n in r.renderGroupFinished)t=Math.max(t,r.renderGroupFinished[n].iconsFinished);r.FirstRenderTime&&(u.FRT=r.FirstRenderTime);t&&(r.AllRenderFinished=t,u.RS=t,t=Math.max(t,r.PreviewPaneOpened.latency||r.PreviewPaneCanceled.latency||0),r.PageLoadTime=t,u.PLT=t);r.SearchHomeRenderEvent!=n.InstrumentationCommon.QFPERFPING_INVALID_MEASURE&&(u.HLT=Math.max(u.PLT-u.K,r.SearchHomeRenderEvent))}else{let n=t.getOffsettedNow();u.RS=n;u.PLT=n}return n.InstrumentationCommon.createPerfPingEvent(r.ImpressionGuid,[u],"Keystroke",r.ConversationId,r.DataSourcesState,r.ResponseFromCache)}static updatePageIG(n){_G.IG=t.getImpressionGuid(n)}static createMasterPageImpression(r,u,f,e,o){let c=n.AccessTokenManager===null||n.AccessTokenManager===void 0?void 0:n.AccessTokenManager.getWindowsAccountType();const l=c===1||c===0;let s={dataSources:o||[],layoutNodes:[],pageName:r,rawQuery:l?"":e?e.queryToFetch:"",isQuery:!1,impressionUrl:t.createVirtualImpressionURL(u,f),appName:t._instrumentationProvider.getApplicationName(),enrichedClientInfo:{FDPartnerEntry:i,nclid:_G.nclid,isOffline:n.isBrowserOnline()?0:1,webRequested:f?1:0}},h=n.safeExecute(()=>t._instrumentationProvider.getEnrichedClientInfo(e),"getEnrichedClientInfo");if(h)for(let n in h)s.enrichedClientInfo[n]=h[n];if(n.config.addExtraInstLoad){if(n.config.extraInstLoadSize&&!t.extraInstPayload){let i="";while(i.length<n.config.extraInstLoadSize)i+="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";t.extraInstPayload=i}n.config.addExtraInstLoadPercentage&&Date.now()%100<=n.config.addExtraInstLoadPercentage&&(s.enrichedClientInfo.exInst=t.extraInstPayload)}return s}static logKeystrokeData(i,u){var s,e,h,c;t.processPendingDataSources(i);n.TestHookUrlParameters&&t.addDuplicatesDataSource(i);let o=Object.keys(i.DataSources).map(n=>i.DataSources[n]).concat(t.createNonSuggestionsDataSource(i.PendingInstrumentedItems,i.PendingSyntheticSuggestions));if(i.DataSources={},i.PendingSyntheticSuggestions={},i.PendingInstrumentedItems={},o.length!=0||!i.MasterPageImpressionCreated){let f;if(i.RenderingStarted&&(f=DsLManager.CreateLayoutNode(_d.body,n.InstrumentationCommon.DEFAULT_APP_NAMESPACE,!1,!0,i.MasterPageImpressionCreated,!0)),i.MasterPageImpressionCreated)if(n.Host.getSplitDataUploadEndpointEnabled()){let[s,h]=t.splitDataSource(o),r=[],u=[];for(const n of f)e=this.splitLayoutNodes(n),e.length>=2&&(e[0]&&r.push(e[0]),e[1]&&u.push(e[1]));n.shouldWindowsAndBingLogToBing()?t.logEvent("ClientInst",null,null,o,f,i.ImpressionGuid,null,null,null):n.shouldBingLogToBing()&&t.logEvent("ClientInst",null,null,h,u,i.ImpressionGuid,null,null,null,"BingTelemetry",33554432);n.shouldWindowsLogToWindows()&&t.logEvent("ClientInst",null,null,s,r,i.ImpressionGuid,null,null,null,"WindowsTelemetry",33554432)}else t.logEvent("ClientInst",null,null,o,f,i.ImpressionGuid,null,null,null);else{let e=t.createMasterPageImpression(t._instrumentationProvider.getSuggestionsPageName(),r,i.SnRProviderFetchUrl?i.SnRProviderFetchUrl.substring(i.SnRProviderFetchUrl.indexOf("?")+1):"",i.Query,o);if(f&&(e.layoutNodes=f),i.FvSug&&Object.keys(i.FvSug).length>0&&(e.enrichedClientInfo.FvSug=i.FvSug),i.HuSug&&Object.keys(i.HuSug).length>0&&(e.enrichedClientInfo.HuSug=i.HuSug),e.clientTimestamp=i.OriginalTimestamp,n.Host.getSplitDataUploadEndpointEnabled()){if(n.config.splitImpression){const n=t.splitWindowsMasterPageImpression(e);n.length>=2&&(h=n[0],c=n[1])}n.shouldWindowsAndBingLogToBing()?t.logMasterPageImpression(i.ImpressionGuid,e):n.shouldBingLogToBing()&&(n.config.splitImpression&&c&&t.logMasterPageImpression(i.ImpressionGuid,c),n.config.pruneImpression&&t.logMasterPageImpression(i.ImpressionGuid,e));const r={eventType:n.LogEventType.Impression,type:n.DataComplianceTypeDefaultEmptyValue,subType:n.DataComplianceTypeDefaultEmptyValue,eventData:JSON.stringify(h)},f=[r.eventType,r.type,r.subType].join(n.DataComplianceEventNameSeparator);if(n.shouldWindowsLogToWindows()&&n.config.splitImpression&&h&&SearchAppWrapper.CortanaApp.wsbTelemetry.logEvent(f,n.DataComplianceSchemaVersion_1_0,i.ImpressionGuid,i.ConversationId,i.OriginalTimestamp,JSON.stringify(r),4,33554432,2),n.isWebXTFlightsTelemetry()){let n=this._keystrokesFlightAssignment[u];n&&i.ImpressionGuid&&((s=SearchAppWrapper===null||SearchAppWrapper===void 0?void 0:SearchAppWrapper.CortanaApp)===null||s===void 0?void 0:s.logCriticalFlightsTelemetry(n,i.ImpressionGuid))}}else t.logMasterPageImpression(i.ImpressionGuid,e);i.MasterPageImpressionCreated=!0}}}static splitLayoutNodes(t){if(t){let i=Object.assign({},t),r=Object.assign({},t);if(t.hasOwnProperty("L")){i.L=[];r.L=[];for(const n of t.L){let t=this.splitLayoutNodes(n);t[0]&&i.L.push(t[0]);t[1]&&r.L.push(t[1])}return i.L.length==0&&delete i.L,r.L.length==0&&delete r.L,[i,r]}if(t.hasOwnProperty("K")){let u=t.K.toString(),f=u.split(".",1)[0];return Number(f)>=n.InstrumentationCommon.KVALUE_HIDDEN?[i,null]:[null,r]}}return[null,null]}static splitDataSource(t){let i=[],r=[];for(const u of t){let s=u.DS,e=[],o=[],t=JSON.parse(JSON.stringify(u)),f=JSON.parse(JSON.stringify(u));t.DS=[];f.DS=[];for(const t of s)n.isWindowsData(t===null||t===void 0?void 0:t.Val)?e.push(t):o.push(t);t.DS=e;f.DS=o;i.push(t);r.push(f)}return[i,r]}static splitWindowsMasterPageImpression(n){if(n){let r=JSON.parse(JSON.stringify(n)),u=JSON.parse(JSON.stringify(n)),f=n.dataSources,[e,o]=t.splitDataSource(f);r.dataSources=e;u.dataSources=o;let s=n.layoutNodes;r.layoutNodes=[];u.layoutNodes=[];for(const n of s){var i=this.splitLayoutNodes(n);i.length>=2&&(i[0]&&r.layoutNodes.push(i[0]),i[1]&&u.layoutNodes.push(i[1]))}return[r,u]}return[]}static logPerfPingEvent(i){t.logEvent(i.EventType,i.Data,n.InstrumentationCommon.QFPERFPING_EVENT_NAME,null,null,i.ImpressionGuid,null,null,null,"WindowsTelemetry",16777216);n.ClientTestHooks&&n.ClientTestHooks.DebugLogNoConsole("perfPingEvent",[i])}static logMasterPageImpression(i,r){if(r){if(!i){n.LogWSBError("logMasterPageImpression",null,new Error("Missing impressionGuid"),undefined,undefined,"WindowsTelemetry");return}if(n.config.disableWSBServerTelemetry&&n.isThirdPartySearchAllowed()&&(r===null||r===void 0?void 0:r.pageName)!="Page.SmartSearch.AS.DSB")return;r.impressionGuid=i;t._instrumentationProvider.logMasterPageImpression(r,n.Host.getConversationId());n.ClientTestHooks&&n.ClientTestHooks.DebugLogNoConsole("masterPageImpression",r,i)}}static instrumentAppVisibleFinish(i){let r=n.getCurrentTime();t._conversationTimeline.AppVisibleStart=i;t._conversationTimeline.AppVisibleFinish=r}static instrumentAppShownFinish(i){let r=n.getCurrentTime();t._conversationTimeline.AppShownStart=i;t._conversationTimeline.AppShownFinish=r}static instrumentConversationTimelineFinish(){let i=_G.ServerIG;if(!i){n.LogWSBError("instrumentConversationTimelineFinish","Could not instrument as server IG not known",new Error("Could not instrument initilization finish"),undefined,undefined,"WindowsTelemetry");return}t._conversationTimeline.RawImpressionGuid=n.Host.getRawImpressionGuid();t._conversationTimeline.ImpressionGuid=n.cleanGuid(t._conversationTimeline.RawImpressionGuid);t._conversationTimeline.ConversationId=n.Host.getConversationId();let r={CID:t._conversationTimeline.ConversationId,ASB:t._conversationTimeline.AppShownStart,ASF:t._conversationTimeline.AppShownFinish,AVB:t._conversationTimeline.AppVisibleStart,AVF:t._conversationTimeline.AppVisibleFinish},u=n.InstrumentationCommon.createPerfPingEvent(i,[r],"ConversationTimeline",t._conversationTimeline.ConversationId);t.logPerfPingEvent(u)}static instrumentPerformance(i,r){try{let e=_G.ServerIG;if(!e){n.LogWSBError("instrumentPerformance "+i,"Could not instrument as server IG not known",new Error("Could not instrument performance "+i),undefined,undefined,"WindowsTelemetry");return}let u=_w.performance,f=new window.Map;if(r){let t=n.InstrumentationCommon.QFPERFPING_INVALID_MEASURE;if(u&&u.timing&&(t=u.timing.navigationStart),t<=0)return;let i=r.getTime()-t,e=n.getCurrentTime()-t;f.BLT=i;f.ILT=e}this.addNavigationPerformanceInfo(u,f);"LoadError"!==i&&r||this.addResourcePerformanceInfo(u,f);let o=[f],s=n.InstrumentationCommon.createPerfPingEvent(e,o,i);t.logPerfPingEvent(s)}catch(u){typeof SharedLogHelper!="undefined"&&n.LogWSBError("instrumentPerformanceException",i,u,undefined,undefined,"WindowsTelemetry")}}static addNavigationPerformanceInfo(n,t){if(n&&t){let i=n.getEntriesByType("navigation");if(i&&i.length>0){let n=i[0];n&&(t.WST=Math.round(n.workerStart),t.FST=Math.round(n.fetchStart),t.RQST=Math.round(n.requestStart),t.RPST=Math.round(n.responseStart),t.RPET=Math.round(n.responseEnd),t.DCLST=Math.round(n.domContentLoadedEventStart),t.DCLET=Math.round(n.domContentLoadedEventEnd),t.DCT=Math.round(n.domComplete),t.LEST=Math.round(n.loadEventStart),t.LEET=Math.round(n.loadEventEnd),t.ECBS=n.encodedBodySize?Math.round(n.encodedBodySize):"",t.DCBS=n.decodedBodySize?Math.round(n.decodedBodySize):"")}}}static addResourcePerformanceInfo(n,t){if(n&&t){let r=n.getEntriesByType("resource"),i=[];r.forEach(n=>{if(n.duration>0&&n.duration>2e3){let t=n,r=new window.Map;r.NAME=t.name;r.ENTYPE=t.entryType;r.INITYPE=t.initiatorType;r.NHPL=t.nextHopProtocol;r.ST=Math.round(t.startTime);r.RDET=Math.round(t.redirectEnd);r.FST=Math.round(t.fetchStart);r.DLST=Math.round(t.domainLookupStart);r.DLET=Math.round(t.domainLookupEnd);r.CST=Math.round(t.connectStart);r.SCST=Math.round(t.secureConnectionStart);r.CET=Math.round(t.connectEnd);r.RQST=Math.round(t.requestStart);r.RPST=Math.round(t.responseStart);r.RPET=Math.round(t.responseEnd);r.DURN=Math.round(t.duration);r.ECBS=t.encodedBodySize?Math.round(t.encodedBodySize):"";r.DCBS=t.decodedBodySize?Math.round(t.decodedBodySize):"";r.TFS=t.transferSize?Math.round(t.transferSize):"";i.push(r)}});i.length>0&&(t.RS=i)}}static instrumentDSBEvent(r){let f={dataSources:[],layoutNodes:[],pageName:"Page.SmartSearch.AS.DSB",rawQuery:"",isQuery:!1,impressionUrl:"",appName:t._instrumentationProvider.getApplicationName(),enrichedClientInfo:{FDPartnerEntry:i,nclid:_G.nclid,isOffline:n.isBrowserOnline()?0:1},impressionGuid:t.createCleanGuid()},u={};if(u=n.safeExecute(()=>t._instrumentationProvider.getEnrichedClientInfoForDSB(),".instrumentDSBEvent.getEnrichedClientInfoForDSB"),u)for(let n in u)f.enrichedClientInfo[n]=u[n];for(const n in r)f.enrichedClientInfo[n]=r[n];t._instrumentationProvider.logMasterPageImpression(f,null)}static instrumentGleamClickEvent(t){var u,f,e;try{if((u=n===null||n===void 0?void 0:n.config)===null||u===void 0?void 0:u.disableWSBServerTelemetry)return}catch(w){}let o=typeof sj_cook!="undefined"?sj_cook===null||sj_cook===void 0?void 0:sj_cook.get("MUID","MUID"):(e=(f=_G===null||_G===void 0?void 0:_G.CID)!==null&&f!==void 0?f:_G===null||_G===void 0?void 0:_G.nclid)!==null&&e!==void 0?e:"",r=this.createCleanGuid();if(o&&r){const c=navigator===null||navigator===void 0?void 0:navigator.userAgent,s=n.Host.getConversationId(),i=(new Date).getTime();let h=n.getWindowProtocol()+"//"+n.getWindowHost()+"/QF_KEYSTROKE_VIRTUAL_URL?ASInitIG="+encodeURIComponent(r);s&&(h+="&cvid="+s);let l={CurUrl:window.location.href,Pivot:"QF",IsNonSuggestion:!0,EnrichedClientInfo:{FDPartnerEntry:"autosuggest",ImpressionUrl:h,DC:(_G===null||_G===void 0?void 0:_G.DA)||undefined,isWebView2:c.includes("IsWebView2/True")?1:undefined},TS:i,UTS:i,UxClassification:{client:"windows"}},a={CurUrl:window.location.href,Pivot:"QF",AppNS:n.InstrumentationCommon.DEFAULT_APP_NAMESPACE,Properties:t,TS:i,UTS:i},v=`<M><IG>${r}</IG><D><![CDATA[${JSON.stringify(l)}]]></D><Page><Name>Page.SmartSearch.AS.SearchAppearance</Name><L><![CDATA[[]]]></L></Page><TS>${i}</TS></M>`,y=`<E><T>Event.Click</T><IG>${r}</IG><D><![CDATA[${JSON.stringify(a)}]]></D><TS>${i}</TS></E>`,p=`<ClientInstRequest><CID>${o}</CID><Group>${v}</Group><Events>${y}</Events></ClientInstRequest>`;fetch("/threshold/xls.aspx",{body:p,method:"POST",headers:{"Content-Type":"text/xml"}})}}static getOffsettedNow(i=n.getCurrentTime()){return i-t._conversationStartTimestamp}static createNonSuggestionsDataSource(i,r){let u=[];for(let n in i)u.push(t._instrumentationProvider.createNonSuggestionDataSourceObject(n,i[n]));for(let i in r)(r[i].staticGroupType!=n.GroupType.MsbOnRampButton||r[i].suppressed!=!0)&&u.push(t._instrumentationProvider.createDataSourceObject(r[i]));if(u.length){let t={T:"D.ContentGroup",AppNS:n.InstrumentationCommon.DEFAULT_APP_NAMESPACE,Service:n.InstrumentationCommon.DEFAULT_SERVICE_NAME,Scenario:"NonSuggestions",SC:u.length,DS:u};return[t]}return[]}static createVirtualImpressionURL(t,i){let r=n.getWindowProtocol()+"//"+n.getWindowHost()+t;return r+=i?i:n.Service.QueryParams.ConversationId+"="+n.encodeQueryParameter(n.Host.getConversationId()),_G.ServerIG&&(r+="&ASInitIG="+n.encodeQueryParameter(_G.ServerIG)),r}static createCleanGuid(n){return n?(n^Math.random()*16>>n/4).toString(16):"10000000100040008000100000000000".replace(/[018]/g,t.createCleanGuid)}static createCodexClickItemProps(n,t){return n.setProperty("FID","Codex"),n.setProperty("Namespace","WindowsSearchBox"),n.setProperty("EventType","ConversationViewEnter"),n.setProperty("source",t),n}static updateMessageBannerClickItemProps(n,t){return n.setProperty("FID","ReclaimSearchbox"),n.setProperty("Namespace","WindowsSearchBox"),n.setProperty("EventType","RecleamSearchBoxEventEnter"),n.setProperty("source",t),n}static updateItemDataTypeProps(t,i){return t.setProperty("DataType",n.isWindowsData(i)?"WindowsData":"BingData"),t}static logFlightState(n,i){t._clientTelemetry.logFlightState(n,i)}static logEvent(t,i,r,u,f,e,o,s,h,c,l){var a,v,y;if(!n.config.disableWSBServerTelemetry||!n.isThirdPartySearchAllowed())if(n.Host.getSplitDataUploadEndpointEnabled()){if(n.shouldWindowsAndBingLogToBing()?Log2.LogEvent(t,i,r,u,f,e,o,s,h):n.shouldBingLogToBing()&&c==="BingTelemetry"&&Log2.LogEvent(t,i,r,u,f,e,o,s,h),n.shouldWindowsLogToWindows()&&c==="WindowsTelemetry"){const u={eventType:n.isNullOrUndefined(t)?n.LogEventType.ClientInst:t,type:n.isNullOrUndefined(r)?n.DataComplianceTypeDefaultEmptyValue:r,subType:n.DataComplianceTypeDefaultEmptyValue};if(typeof i=="string")u.eventData=i;else for(a in i)a=="ST"?u.subType=n.isNullOrUndefined(i[a])?n.DataComplianceTypeDefaultEmptyValue:i[a]:a=="T"?u.type=n.isNullOrUndefined(i[a])?n.DataComplianceTypeDefaultEmptyValue:i[a]:u[a]=i[a];const f=[u.eventType,u.type,u.subType].join(n.DataComplianceEventNameSeparator);v=n.Host.getConversationId();let o=n.getCurrentTime();y=JSON.stringify(u);SearchAppWrapper.CortanaApp.wsbTelemetry.logEvent(f,n.DataComplianceSchemaVersion_1_0,e,v,o,y,4,l,2)}}else Log2.LogEvent(t,i,r,u,f,e,o,s,h)}}t._clientShownTimestamp=n.InstrumentationCommon.QFPERFPING_INVALID_MEASURE;t._conversationStartTimestamp=n.InstrumentationCommon.QFPERFPING_INVALID_MEASURE;t._currentRender=0;t._keyDownTimeStamp=n.InstrumentationCommon.QFPERFPING_INVALID_MEASURE;t._keystrokesPerfPingData={};t._keystrokesInstrumentationData={};t._keystrokesFlightAssignment={};t._keystrokeTimelineUpdatedHandlers=[];t._finalizeKeystrokeHandlers=[];n.InstrumentationHelper=t}(WSB||(WSB={})),function(n){const t="&nclid=",i="&ts=",r="&nclidts=",u="&tsms=",f="&elv=",e="&cc=",o="&setlang=",s="&cvid=",h="&qs=",c="&ao=",l="&wsso=";class a{constructor(t=Date.now,i=n.getWindowProtocol()+"//"+n.getWindowHost()){if(this.getNowTimestamp=t,this._baseUrl=i,n.config.enableOfflineWithWeb&&n.config.webHost&&n.isBrowserOnline()&&(this._baseUrl=n.config.webHost),n.config.overrideHost){let t=n.getWindowHost();t.startsWith("www.")&&(this._baseUrl=n.getWindowProtocol()+"//"+n.config.overrideHost+t.substring(3))}}getSearchUrl(t,i,r,u,e,o,s,h,a,v,y){if(!u)if(e===21&&(!n.config.disableMsbBundle||n.msbHost))u=(n.msbHost.features.isEduScopeApplicable()?"/school":"/work")+"/search?q="+n.encodeQueryParameter(i),v&&(u+="&inithash="+v),o=n.mapOSFormCode((v===null||v===void 0?void 0:v.includes("Connectors"))?"WSBWSC":"WSBWS0");else{let t=this.getVerticalFromHandoffType(e);u=(t?"/"+t:"")+"/search?q="+n.encodeQueryParameter(i)}let p=this._baseUrl+u;p+=(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.isWindowsTest)?"&form=MONITR&traffictype=wintest":"&form="+n.encodeQueryParameter(o!==null&&o!==void 0?o:n.Host.getFormCode());a&&(p+=c+"1");p=this.enrichUrlWithSuggestionType(p,h?"P":r);p=this.enrichUrlWithCvid(p);n.config.suppressPqParameter||(p+="&pq="+n.encodeQueryParameter(t));let w=n.Host.getMSNRefIg();if(w&&(p+="&refig="+w),p=this.enrichUrlWithMarketInfo(p),p=this.enrichUrlWithDeviceInfo(p),!s){p=this.enrichUrlWithMuidInfo(p);let t=n.Host.getElToken();t&&this._baseUrl.startsWith("https:")&&(p+=f+n.encodeQueryParameter(t));p=this.enrichUrlWithSafeSearchInfo(p)}let b=n.Host.getSafeSearchSetting();return b&&(p+=l+b),n.config.propagateFiltersToMiniserpUrl&&(p+="&"+y),p}getImageSearchUrl(){let t=this._baseUrl+"/images/detail/upload?FORM="+n.mapOSFormCode("SBIWSB");return(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.isWindowsTest)&&(t+="&isWindowsTest=1&traffictype=Test"),t}getVerticalFromHandoffType(n){return n===13?"images":n===14?"videos":n===15?"shop":""}enrichUrlWithDeviceInfo(t){n.Host.isEducationEnvironment()&&(t+="&DAF0=1");n.Host.isWindowsS()&&(t+="&DAF1=1");let i=n.Host.getPartnerSearchCode();return i&&(t+="&PC="+i),t}enrichUrlWithMarketInfo(t){let i=n.Host.getRegion(),r=n.Host.getLanguage();return i&&(t+=e+i),r&&(t+=o+r),t}enrichUrlWithSafeSearchInfo(t){return n.Host.getSafeSearchSetting()=="Strict"?t+"&adlt=strict":t}enrichUrlWithMuidInfo(f){if(_G.nclid){f+=t+n.encodeQueryParameter(_G.nclid);let e=this.getNowTimestamp().toString();f+=i+n.encodeQueryParameter(e);let o=e.substring(0,e.length-3);f+=r+n.encodeQueryParameter(o);let s=e.substring(e.length-3);f+=u+n.encodeQueryParameter(s)}return f}enrichUrlWithCvid(t){return t+(s+n.encodeQueryParameter(n.Host.getConversationId()))}enrichUrlWithSuggestionType(t,i){return t+(h+n.encodeQueryParameter(i))}getChatUrl(t){return"https://www.bing.com/search?q="+n.encodeQueryParameter(t)+"&showconv=1&sendquery=1&form=WSBMSC"}enrichUrlWithWorkScopeHash(n,t){return n===21&&t?"#"+t:""}}n.NavigationHelper=a}(WSB||(WSB={})),function(n){class t{constructor(t){this._selectableItemsContainer=t;n.Host.bindKeyDown((i,r,u)=>{this.selectedItem=this.getSelectedItem();let f=!1;if(i==9)f=this.selectFirstItemInNextGroup(r&&r.shiftKey);else if((n.isUpOrDownKey(i)||n.isLeftOrRightKey(i))&&this.isMsbDsbSelected(this.selectedItem)){const t=n.isUpKey(i)||n.isLeftKey(i);f=this.selectNextItemInGroup(t)}else n.isUpOrDownKey(i)&&(f=this.selectNextItem(n.isUpKey(i)));t.onAfterKeyDown(i,r,u,f)})}selectFirstItemInNextGroup(t){var s,e,o;const r=this._selectableItemsContainer.getSelectableItemsByGroup();if(r.length==0)return!1;const i=r.findIndex(n=>!!n.find(n=>{var t,i;return n.reactKey?n.reactKey===((t=this.selectedItem)===null||t===void 0?void 0:t.reactKey):n.id===((i=this.selectedItem)===null||i===void 0?void 0:i.id)}));let f;f=i<0?-1:this.isMsbDsbSelected(this.selectedItem)?r[i].findIndex(n=>{var t;return n.id===((t=this.selectedItem)===null||t===void 0?void 0:t.id)}):r[i].findIndex(n=>n==this.selectedItem);this.selectedItem&&(this.selectedItem.selected=!1,(e=(s=this.selectedItem).onUnselected)===null||e===void 0?void 0:e.call(s));let u;return(i<0&&!t?u=r[0][0]:t?!this.isMsbDsbSelected(this.selectedItem)&&f>0?u=r[i][0]:i>0?(u=r[i-1][0],u.hiddenAfterFocus&&i>=2&&(u=r[i-2][0])):i===0&&n.RuntimeConfig.AllowKeyboardNavCycling?u={id:"SearchBox",selected:!1,text:"SearchBox"}:i<0&&n.RuntimeConfig.AllowKeyboardNavCycling&&(u=r[r.length-1][0]):i+1<r.length?u=r[i+1][0]:f+1<r[i].length&&((o=this.selectedItem)===null||o===void 0?void 0:o.scope)==n.Scope.Work&&(u=r[i][f+1]),u)?(this._selectableItemsContainer.select(u,!0),u.onSelected&&u.onSelected(),!0):!1}selectNextItem(t){var o,f,s,e;const i=this._selectableItemsContainer.getSelectableItems();if(i.length==0)return!1;const r=this.selectedItem?i.findIndex(n=>{var t,i;return n.reactKey?n.reactKey===((t=this.selectedItem)===null||t===void 0?void 0:t.reactKey):n.id===((i=this.selectedItem)===null||i===void 0?void 0:i.id)}):-1;this.selectedItem&&(this.selectedItem.selected=!1,(f=(o=this.selectedItem).onUnselected)===null||f===void 0?void 0:f.call(o));const h=t?r==0:r==i.length-1;if(h&&n.RuntimeConfig.AllowKeyboardNavOffCanvas)return this._selectableItemsContainer.select(null,!0),!0;if(h&&!n.RuntimeConfig.AllowKeyboardNavCycling)return!1;const u=t?r<=0?i.length-1:r-1:(r+1)%i.length;return this._selectableItemsContainer.select(i[u],!0),i[u]&&i[u].onSelected&&((e=(s=i[u]).onSelected)===null||e===void 0?void 0:e.call(s)),!0}selectNextItemInGroup(t){var h,e,f,o;const i=this._selectableItemsContainer.getSelectableItemsByGroup();if((i===null||i===void 0?void 0:i.length)==0)return!1;const s=i.findIndex(n=>!!n.find(n=>{var t;return n.id===((t=this.selectedItem)===null||t===void 0?void 0:t.id)}));if(s<0)return!1;const r=i[s],u=r.findIndex(n=>n==this.selectedItem);this.selectedItem&&(this.selectedItem.selected=!1,(e=(h=this.selectedItem).onUnselected)===null||e===void 0?void 0:e.call(h));const l=t?u==0:u==r.length-1;if(l&&!n.RuntimeConfig.AllowKeyboardNavCycling)return!1;const c=t?u<=0?r.length-1:u-1:(u+1)%r.length;return this._selectableItemsContainer.select(i[s][c],!0),(o=(f=r[c])===null||f===void 0?void 0:f.onSelected)===null||o===void 0?void 0:o.call(f),!0}getSelectedItem(){let t;return this.selectedItem||!(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.keyNavSetFocus)?(t=this._selectableItemsContainer.getSelectedItem(),this.isMsbDsbSelected(this.selectedItem)&&(t=this._selectableItemsContainer.getSelectableItems().find(n=>n.selected)||t)):(t=this._selectableItemsContainer.getSelectableItems().find(t=>t.id===(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.keyNavSetFocus)),this._selectableItemsContainer.select(t,!0)),t}isMsbDsbSelected(n){const t=n;return t&&t.dsb&&t.isMsb}}n.KeyboardEvtHandler=t}(WSB||(WSB={})),function(n){n.LatencyTimeout=500;n.MsbPeopleLatencyTimeout=1e3;class t{constructor(n,t,i){this._aggregator=n;this._rootViewModel=t;this._queryIntentClassifier=i;this._sequenceNumber=-1;this._suggestionsQueue={};this._dataSourcesCompleted={};this._expectedLongRunningDataSources=["CoPIFF","CoPCFP","CoPST"]}initiateSequenceNumber(t,i,r){if(!(n.isThirdPartySearchAllowed===null||n.isThirdPartySearchAllowed===void 0?void 0:n.isThirdPartySearchAllowed())||(n.isSupportWebResultsInAllScopeInDMAEnabled===null||n.isSupportWebResultsInAllScopeInDMAEnabled===void 0?void 0:n.isSupportWebResultsInAllScopeInDMAEnabled())||i.scope!=n.Scope.ThirdPartyWeb){if(this._sequenceNumber>=t){n.LogWSBError("initiateSequenceNumber",null,new Error("Unexpected sequence number"));return}this.resetStateForNewQuery(t,i);this._highPriorityDataSources=[];this._normalPriorityDataSources=[];this._lowPriorityDataSources=[];for(let t of n.config.enabledDataSources){let r=i.enabledDataSources[t];r&&(n.config.lowPriorityDataSources[t]?this._lowPriorityDataSources.push(t):n.config.highPriorityDataSources[t]?t==="MSBC"&&(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.qfUtils.isWaitForBackfillEnabled(i.scope))?this._lowPriorityDataSources.push(t):this._highPriorityDataSources.push(t):t==="IFF"&&n.isHighPriorityFileProviderEnabled()?this._highPriorityDataSources.push(t):this._normalPriorityDataSources.push(t))}if(this._HighPriDoneProcessing=this._highPriorityDataSources.length==0,this._highPriorityDataSources.length==0&&this._normalPriorityDataSources.length==0&&this._lowPriorityDataSources.length==0)this.processSuggestions(!1);else{let t=this.getLatencyTimeout();t>0&&(this._bufferingTimer=n.safeSetTimeout(()=>{this._bufferingTimer=null,this.processSuggestions(!0)},t,"processSuggestionsBuffering"),n.config.dataSourceTimeLimit&&(this._processingTimeoutTimer=n.safeSetTimeout(()=>{this._processingTimeoutTimer=null;let t=[...this._highPriorityDataSources.filter(t=>!n.contains(this._arrivedDataSources,t)),...this._normalPriorityDataSources.filter(t=>!n.contains(this._arrivedDataSources,t)),...this._lowPriorityDataSources.filter(t=>!n.contains(this._arrivedDataSources,t)),];t.some(t=>n.contains(this._expectedLongRunningDataSources,t))?n.LogWSBWarning("SuggestionsRenderingManager",t.join(","),new Error("Data provider did not complete before the time limit")):n.LogWSBError("SuggestionsRenderingManager",t.join(","),new Error("Data provider did not complete before the time limit"));this._processingStopped=!0;this._allDataSourcesArrived=!0;this.processSuggestions(!1);r&&r()},n.config.dataSourceTimeLimit,"processSuggestionsTimeout")))}}}getLatencyTimeout(){var t;return this._partialQuery.queryToFetch?this._partialQuery.scope===n.Scope.People&&n.isMsftAccountConnected?(t=n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbPeopleL2LatencyTimeout)!==null&&t!==void 0?t:n.MsbPeopleLatencyTimeout:(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.latencyTimeout)?n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.latencyTimeout:n.config.impressionRenderingTimeout?n.config.impressionRenderingTimeout:n.LatencyTimeout:n.LatencyTimeout}queueSuggestions(t,i,r,u,f){if(t>this._sequenceNumber){n.LogWSBError("queueSuggestions",null,new Error("Unexpected sequence number"));return}if(!(t<this._sequenceNumber)){if(this._dataSourcesCompleted[i]){n.LogWSBError("queueSuggestions",i,new Error(`Data source already completed: ${i}`));return}if(!n.contains(this._highPriorityDataSources,i)&&!n.contains(this._normalPriorityDataSources,i)&&!n.contains(this._lowPriorityDataSources,i)){n.LogWSBError("queueSuggestions",i,new Error("Unexpected data source"));return}this._allDataSourcesArrived||(this._suggestionsQueue[i]&&!this._suggestionsQueue[i].updated?this._suggestionsQueue[i].suggestions.push(...r):this._suggestionsQueue[i]={suggestions:r,updated:!1},this._dataSourcesCompleted[i]=!f,u&&(this._extraSignalsMap[i]=u),f||this._arrivedDataSources.push(i),this._allDataSourcesArrived=this.haveAllDataSourcesArrived(this._highPriorityDataSources.concat(this._normalPriorityDataSources).concat(this._lowPriorityDataSources)),this._processingStopped||n.InstrumentationHelper.isLayoutLogged(this._sequenceNumber)?this._allDataSourcesArrived&&(this.resetTimers(),n.InstrumentationHelper.notifyAllDataSourcesProcessed(this._sequenceNumber)):this.processSuggestions(!1))}}resetTimers(){this._bufferingTimer&&(sb_ct(this._bufferingTimer),this._bufferingTimer=null);this._processingTimeoutTimer&&(sb_ct(this._processingTimeoutTimer),this._processingTimeoutTimer=null)}resetStateForNewQuery(t,i){this._arrivedDataSources=[];this._allProcessedDataSources={};this._sequenceNumber=t;this._partialQuery=i;this._suggestionsQueue={};this._dataSourcesCompleted={};this._extraSignalsMap={};this._renderedThisSequenceNumber=!1;this._waitingForMoreResults=!0;this._processingStopped=!1;this._allDataSourcesArrived=n.isEmpty(i.enabledDataSources);this.resetTimers()}getDependencies(t){return n.Host.dataSourceDependencies(t).filter(t=>n.isDataSourceEnabled(t,this._partialQuery))}haveAllDataSourcesArrived(t){return n.config.mergeQueries&&this._partialQuery.scope==n.Scope.Documents?t.every(n=>{switch(n){case"MPHO":case"MVID":case"MDOC":return!!this._partialQuery.enabledDataSources.MPHO&&!!this._partialQuery.enabledDataSources.MVID&&!!this._partialQuery.enabledDataSources.MDOC&&!!this._partialQuery.enabledDataSources.MPVD;default:return!!this._suggestionsQueue[n]}}):t.every(i=>{var r,u;if(i=="MSBC"){const t=n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.qfUtils.isWaitForBackfillEnabled(this._partialQuery.scope),f=!!this._suggestionsQueue[i]&&(((u=(r=this._suggestionsQueue[i])===null||r===void 0?void 0:r.suggestions)===null||u===void 0?void 0:u.length)>0||this._dataSourcesCompleted[i]);return t?f:!!this._suggestionsQueue[i]}return!!this._suggestionsQueue[i]&&this.haveCacheBackedDataSourcesArrived(t)})}haveCacheBackedDataSourcesArrived(t){if(this._partialQuery.isSearchHomeZI&&n.isMsbQwsDocsCacheEnabled(this._partialQuery)&&!n.config.msbQwsDocsNoRefreshAfterCachedResults){const i="SSUE",r="SREE",s=!!this._partialQuery.enabledDataSources[i]&&n.isDocSourceEnabledInQws(i),h=!!this._partialQuery.enabledDataSources[r]&&n.isDocSourceEnabledInQws(r);let u=!1,f=!1;t.forEach(n=>{n==i?u=!0:(n=r)&&(f=!0)});const e=u&&s,o=f&&h;if(e||o){const n=e&&this._dataSourcesCompleted[i],t=o&&this._dataSourcesCompleted[r];return n||t}return!0}return!0}haveAllDataSourcesCompleted(t){return n.config.mergeQueries&&this._partialQuery.scope==n.Scope.Documents?t.every(n=>{switch(n){case"MPHO":case"MVID":case"MDOC":return!!this._partialQuery.enabledDataSources.MPHO&&!!this._partialQuery.enabledDataSources.MVID&&!!this._partialQuery.enabledDataSources.MDOC&&!!this._partialQuery.enabledDataSources.MPVD;default:return!!this._dataSourcesCompleted[n]}}):t.every(n=>!!this._dataSourcesCompleted[n])}processSuggestions(t){let r=[],o=[],i,h=this.getLatencyTimeout()>0&&this._bufferingTimer==null,c=this.haveAllDataSourcesArrived(this._highPriorityDataSources),l=c||h,y=this.haveAllDataSourcesCompleted(this._normalPriorityDataSources),a=this.haveAllDataSourcesCompleted(this._highPriorityDataSources),v=a&&y;const f=this._allDataSourcesArrived||h;t&&n.InstrumentationHelper.logDataSourceTimeout(Object.keys(this._suggestionsQueue),this._partialQuery);let u=t&&!this._renderedThisSequenceNumber,p=(t,f)=>{if(!t.updated&&this.getDependencies(f).every(t=>n.contains(this._arrivedDataSources,t))){if(o.push(f),this._allProcessedDataSources[f]=!0,t.suggestions.length>0){n.config.enableUserEngagementLog&&t.suggestions.forEach(n=>{n.dataSource=f});let e=this.canHaveSuppressions(f)?t.suggestions.filter(n=>!this.isSuppressed(f,n)):t.suggestions;if(e.length>0){i&&i.length!==0||(i=this._renderedThisSequenceNumber?this._rootViewModel.getSuggestions(!0):[]);f=="CoPIFF"&&n.Host.getIFFPolarisProviderEnabled()&&this.maxRankScoreOfDuplicatesSuggestions(e,i);let[t,o]=this.removeDuplicatesAndAssignIds(e,i,r,f);if(n.config.enableMruProviderInQF&&(n.AccessTokenManager===null||n.AccessTokenManager===void 0?void 0:n.AccessTokenManager.getWindowsAccountType())===3&&f=="Web"){if(f=="Web"){let n=[];t.forEach(t=>{r.find(n=>(n===null||n===void 0?void 0:n.query)==(t===null||t===void 0?void 0:t.query))||i.find(n=>(n===null||n===void 0?void 0:n.query)==(t===null||t===void 0?void 0:t.query))||n.push(t)});r=r.concat(n)}}else r=r.concat(t);o&&(u=!0)}}t.updated=!0}};const e=(t,u)=>{var f,e,o,s,h,c;for(let n in t){let i=t[n],r=this._suggestionsQueue[i];r&&p(r,i)}if(n.config.wsbWithCopilotQF&&u&&this._queryIntentClassifier&&!this._extraSignalsMap.QIC){let t=this._partialQuery.queryToFetch;if(t.split(/\W+/).filter(Boolean).length>1){let l=(f=r===null||r===void 0?void 0:r.filter(n=>n.type=="PP"||n.type=="IBA").length)!==null&&f!==void 0?f:0;l+=(e=i===null||i===void 0?void 0:i.filter(n=>n.type=="PP"||n.type=="IBA").length)!==null&&e!==void 0?e:0;let u=(o=r===null||r===void 0?void 0:r.filter(n=>n.type=="ST").length)!==null&&o!==void 0?o:0;u+=(s=i===null||i===void 0?void 0:i.filter(n=>n.type=="ST").length)!==null&&s!==void 0?s:0;n.Host.getJupiterProviderEnabled()&&(u+=(h=r===null||r===void 0?void 0:r.filter(n=>n.type=="CoPST").length)!==null&&h!==void 0?h:0,u+=(c=i===null||i===void 0?void 0:i.filter(n=>n.type=="CoPST").length)!==null&&c!==void 0?c:0);let a=this._queryIntentClassifier.classify(t,l,u);this._extraSignalsMap.QIC={rankerExtraInfo:{confidence:a}}}}};l&&(n.config.impressionRenderingWaitTimeout?f&&e(this._highPriorityDataSources,!0):e(this._highPriorityDataSources,!0));this._bufferingTimer&&v&&(!n.config.impressionRenderingWaitTimeout||f)&&(sb_ct(this._bufferingTimer),this._bufferingTimer=null);let s=l&&!this._HighPriDoneProcessing;s=s||!!(n.config.impressionRenderingWaitTimeout&&f);let w=s||(this.getLatencyTimeout()>0?this._bufferingTimer==null:c);w&&(e(this._normalPriorityDataSources),e(this._lowPriorityDataSources));this._waitingForMoreResults&&v&&(this._waitingForMoreResults=!1,(!this._renderedThisSequenceNumber||this._rootViewModel.mayNeedFlush()||(i||this._rootViewModel.getSuggestions(!0)).length==0)&&(u=!0));this._partialQuery.showProgressBar&&this._allDataSourcesArrived&&(u=!0);(r.length>0||u)&&(i||(i=this._renderedThisSequenceNumber?this._rootViewModel.getSuggestions(!0):[]),n.config.impressionRenderingWaitTimeout?f&&this.addSuggestions(i,r,o,u):this.addSuggestions(i,r,o,u));this._allDataSourcesArrived&&(this.resetTimers(),n.InstrumentationHelper.notifyAllDataSourcesProcessed(this._sequenceNumber),this._rootViewModel.toggleProgressBar(!1),(n.Host.useImprovedIndexingMessage()||(n.MockUrlParameters===null||n.MockUrlParameters===void 0?void 0:n.MockUrlParameters.windowsSearchCatalogStatus))&&(this._partialQuery.queryToFetch?this._rootViewModel.updateIndexingNotificationVisibility():this._rootViewModel.hideIndexingIncompleteNotification()));this._HighPriDoneProcessing=a}getAggregatorResult(n,t,i){let r=this.waitingForWebProvider();return this._aggregator.rank(t,i,this._extraSignalsMap,this._partialQuery,n,this._sequenceNumber,r)}waitingForWebProvider(){return n.isBrowserOnline()&&["Web"].concat(this.getDependencies("Web")).some(t=>n.isDataSourceEnabled(t,this._partialQuery)&&!this._allProcessedDataSources[t])}addSuggestions(t,i,r,u){let e=this._renderedThisSequenceNumber?this._rootViewModel.getCurrentTopResults():[],f=n.safeExecute(()=>this.getAggregatorResult(e,t,i),"getAggregatorResults",null);f||(f={topResults:e,suggestionsToAdd:i,suggestionsToRemove:[],groupOrder:[]});n.InstrumentationHelper.instrumentAggregatorCall(this._sequenceNumber);n.shouldShowDSBLayout(this._partialQuery)&&n.InstrumentationHelper.instrumentDSB();i=f.suggestionsToAdd;let o=f.suggestionsToRemove;for(let i of f.topResults)n.contains(t,i)&&!n.contains(e,i)&&o.push(i);if(u||i.length!=0||o.length!=0||!n.sequenceEqual(e,f.topResults)){let s=!this._renderedThisSequenceNumber;if(s&&(this._renderedThisSequenceNumber=!0,n.InstrumentationHelper.instrumentRenderingStarted(this._sequenceNumber)),n.config.useGroupTitleEdgeBS&&this._partialQuery&&!this._partialQuery.isSearchHomeZI&&i)for(let t of i)t&&(t.type=="ANAF"||t.type=="ANAH"||t.type=="ANAR"||t.type=="ANAT")&&(t.staticGroupType=n.GroupType.AnaheimDataQF);n.TweakDiagnostics===null||n.TweakDiagnostics===void 0?void 0:n.TweakDiagnostics.pushDiagnostics("onAddSuggestions",f);let h=n.safeExecute(()=>this._rootViewModel.update(s,f.topResults,this._waitingForMoreResults,this._sequenceNumber,i,o,r,f.groupOrder,this._allDataSourcesArrived,this._extraSignalsMap),"rootViewModel.update",0,null,t=>{n&&n.fallbackToPrepopulatedBundle&&n.fallbackToPrepopulatedBundle(t)});h==0&&(this._processingStopped=!0,this.resetTimers())}}isAnaheimSuggestionDupeWithMRU(t,i){if(i.type=="ANAH"||i.type=="ANAR"){let r=i;if(n.isBingSearchUrl(r.url)){let i=n.extractQueryFromBingSearchUrl(r.url);if(i&&n.contains(t,i))return!0}}return!1}maxRankScoreOfDuplicatesSuggestions(t,i){var r,u;for(let f=0;f<i.length;++f){let e=i[f];if(n.isDocument(e===null||e===void 0?void 0:e.type)||n.isPhoto(e===null||e===void 0?void 0:e.type)||n.isFolder(e===null||e===void 0?void 0:e.type)){let o=t.filter(t=>n.isDuplicateDocument(e,t));for(let t of o)!n.isNullOrUndefined((r=t===null||t===void 0?void 0:t.deviceItem)===null||r===void 0?void 0:r.rankScore)&&!n.isNullOrUndefined((u=e===null||e===void 0?void 0:e.deviceItem)===null||u===void 0?void 0:u.rankScore)&&t.deviceItem.rankScore>e.deviceItem.rankScore&&(i[f].maxRankScoreForLocalDevice=t.deviceItem.rankScore),(n.config.enableCopIFFExpPlan||n.config.mergeMultipleResouces)&&(t.isPolarisMatched?(i[f].isPolarisMatched=!0,i[f].indexerIntentFeature=!0):t.isVegaMatched&&(i[f].isVegaMatched=!0,i[f].indexerIntentFeature=!0))}}}removeDuplicatesAndAssignIds(t,i,r,u){var f;let o=n=>{var t,i;n.id||(n.id=n.path?n.path:n.type+n.text+((t=n.additionalInfoText)!==null&&t!==void 0?t:"")+(n.handoffType===17?(i=n.reactKey)!==null&&i!==void 0?i:"":""))},e=!1;if(u=="ANA"&&this._suggestionsQueue.MRS){let n=(f=this._suggestionsQueue.MRS.suggestions)===null||f===void 0?void 0:f.map(n=>n.query);n&&(t=t.filter(t=>!this.isAnaheimSuggestionDupeWithMRU(n,t)))}if(this._aggregator.canHaveDuplicates(u,this._partialQuery)){let f=[];for(let s=0;s<t.length;++s){const c=t[s];let h=i.findIndex(n=>this._aggregator.mergeDuplicates(this._partialQuery,n,c));if(h>=0){let t=i[h];t.needsRefreshAfterDeduping&&(e=!0);n.InstrumentationHelper.instrumentDuplicate(this._sequenceNumber,t,c);continue}if(h=r.findIndex(n=>this._aggregator.mergeDuplicates(this._partialQuery,n,c)),h>=0){let t=r[h],i=null;const u=n.config.msbReplaceDupLocalFiles&&c.type==="MFIL"&&t.type==="FL";u&&(i=this.replaceSuggestionInList(r,h,c),t=r[h]);t.needsRefreshAfterDeduping&&(t.needsRefreshAfterDeduping=!1,t.previewPaneNeedsRefreshAfterDeduping=!1);n.InstrumentationHelper.instrumentDuplicate(this._sequenceNumber,t,i!==null&&i!==void 0?i:c);continue}if(this._aggregator.canHaveDuplicatesWithinDataSource(u,this._partialQuery)&&(h=f.findIndex(n=>this._aggregator.mergeDuplicates(this._partialQuery,n,c)),h>=0)){let t=f[h];t.needsRefreshAfterDeduping&&(t.needsRefreshAfterDeduping=!1,t.previewPaneNeedsRefreshAfterDeduping=!1);n.InstrumentationHelper.instrumentDuplicate(this._sequenceNumber,f[h],c);continue}o(c);f.push(c)}return[f,e]}return t.forEach(n=>o(n)),[t,e]}canHaveSuppressions(t){return n.config.suppressDataSources[t]||n.config.dataSourcesWithSuppressedTypes[t]}isSuppressed(t,i){return n.config.suppressDataSources[t]||n.config.suppressTypes[i.type]}replaceSuggestionInList(n,t,i){const r=n[t];return r?(i.duplicates=r.duplicates,i.needsRefreshAfterDeduping=!0,i.previewPaneNeedsRefreshAfterDeduping=!0,n[t]=i,r):r}}n.SuggestionsRenderingManager=t}(WSB||(WSB={})),function(n){function w(n){return n.handoffType==1?n.query:HitHighlightingParser.removeMarkers(n.text)}function f(n){if(n.length==0)return 0;let t=0;for(let i=0;i<n.length;i++)t=(t<<5)-t+n.charCodeAt(i)|0;return t}function o(n){let t=1779033703,i=3144134277,r=1013904242,u=2773480762;for(let e=0,f;e<n.length;e++)f=n.charCodeAt(e),t=i^Math.imul(t^f,597399067),i=r^Math.imul(i^f,2869860233),r=u^Math.imul(r^f,951274213),u=t^Math.imul(u^f,2716044179);return t=Math.imul(r^t>>>18,597399067),i=Math.imul(u^i>>>22,2869860233),r=Math.imul(t^r>>>17,951274213),u=Math.imul(i^u>>>19,2716044179),t^=i^r^u,i^=t,r^=t,u^=t,[t>>>0,i>>>0,r>>>0,u>>>0]}function s(n,t,i,r){return function(){n|=0;t|=0;i|=0;r|=0;let u=(n+t|0)+r|0;return r=r+1|0,n=t^t>>>9,t=i+(i<<3)|0,i=i<<21|i>>>11,i=i+u|0,(u>>>0)/4294967296}}function b(n){n||(n="default");let t=o(n);return s(t[0],t[1],t[2],t[3])}function t(n,t){if(!n)return t.length;if(!t)return n.length;let u=[],i;for(i=0;i<=t.length;i++)u[i]=[i];let r;for(r=0;r<=n.length;r++)u[0][r]=r;for(i=1;i<=t.length;i++)for(r=1;r<=n.length;r++)u[i][r]=t.charAt(i-1)==n.charAt(r-1)?u[i-1][r-1]:Math.min(u[i-1][r-1]+1,Math.min(u[i][r-1]+1,u[i-1][r]+1));return u[t.length][n.length]}function k(n,i){return n&&(n=n.toLocaleLowerCase()),i&&(i=i.toLocaleLowerCase()),t(n,i)}function h(n,t,i){let r=0;if(t>0||i>0)if(t>0&&i>0){if(i>t){let n=t;t=i;i=n}r=n/(t-n+i)}else r=Number.MAX_VALUE;return r}function c(n,t){let i=n.length,u=t.length;if(i===0&&u===0)return 1;let s=new Array(i),o=new Array(u),r=0,h=0,c=Math.floor(Math.max(i,u)/2)-1;for(let e=0;e<i;e++){let i=Math.max(0,e-c),h=Math.min(u,e+c+1);for(var f=i;f<=h;f++)if(!o[f]&&n[e]==t[f]){s[e]=!0;o[f]=!0;r++;break}}if(r===0)return 0;let e=0;for(let r=0;r<i;r++)if(s[r]){while(!o[e])e++;n[r]!=t[e]&&h++;e++}return(r/i+r/u+(r-h/2)/r)/3}function d(n,t){let i=c(n,t);if(i<1)return i;let r=l(n,t);return i+r*.1*(1-i)}function l(n,t){let i=0;for(;i<4;i++)if(n[i]!=t[i])return i;return++i}function g(n,t){return!n||!t?0:n.length+1<=t.length&&t[n.length]==" "?1:n.length==t.length?1:0}function nt(n){let i=0,t=1;if(n&&n.length>1)for(let r=1;r<n.length;r++)n.charAt(r)==n.charAt(r-1)?t++:t=1,t>i&&(i=t);else if(n)return 1;return i}function tt(n){return n&&n.length>0?n.trim().split(" ").length:0}function it(n){let t=new RegExp("^[0-9a-zA-Z ]+$");return n&&t.test(n)?1:0}function rt(n){return n&&n.length>0&&n.charAt(n.length-1)==" "?1:0}function ut(n){return n&&n.length>0&&(n.includes("http://")||n.includes("https://")||n.includes("."))?1:0}function ft(t,i,r,u){t.includes("?")&&(r[117]=1,ct(t)&&(r[127]=1));t.replace("///","").replace("//","").includes("/")&&(r[118]=1);t.includes(".")&&(r[119]=1);let o=u.cvid+u.privacyNumber+t;r[120]=f(o);let e=t.toLocaleLowerCase();if((e.startsWith("www.")||e.startsWith("http://www.")||e.startsWith("https://www."))&&(r[122]=1),e.startsWith("www.")||e.startsWith("http://")?r[123]=1:e.startsWith("https://")?r[124]=1:e.startsWith("ftp://")?r[125]=1:r[126]=1,i){let t=n.normalizeUrl(e,15),u=n.normalizeUrl(i,15).toLocaleLowerCase();t.startsWith(u)&&(r[187]=1)}}function et(n,i,r,u,e){if(e){r[128]=t(e,i);r[129]=e.length;let n=u.cvid+u.privacyNumber+e;r[130]=f(n)}}function ot(n,i,r){let u=n.toLocaleLowerCase();r[140]=n.length;let f=u.split(" ");if(r[144]=f.length,i){r[141]=t(n,i);r[142]=Math.min(100,h(r[141],i.length,n.length));let e=i.toLocaleLowerCase();u.includes(e)&&(r[143]=1);u.startsWith(e)&&(r[188]=1);for(let n of f)if(n==e){r[145]=1;break}}}function ct(n){let t=ht.find(t=>n.startsWith(t));return n=t?n.substr(t.length):n,st.some(t=>n.startsWith(t))}function lt(n){let t=0;if(n)for(let i in n){let r=n[i];r&&r.prefixLaunchCount&&(t+=r.prefixLaunchCount)}return t}function at(t,i,r,u){if(r){let f=r[t];f&&(i[47]=f.prefixLaunchCount,i[49]=f.lastLaunchTime,i[101]=u,u>0&&(i[100]=f.prefixLaunchCount/u),f.previewPaneLaunchCount&&f.lastPreviewPaneLaunchTime&&(i[301]=f.previewPaneLaunchCount,f.lastPreviewPaneLaunchTime==f.lastLaunchTime&&(i[302]=1),i[303]=n.getCurrentTime()-f.lastPreviewPaneLaunchTime))}}function vt(n,t,i){if(i){let r=i[n];r&&(t[281]=r.probability,t[282]=r.weight)}}function yt(n,t,r,u,f,e){if(t){let s=i(u,r),o=t[s];o&&(f?(n[153]=o.ProbSugClickGivenPref,n[152]=o.ClicksOnSugGivenPref):e?(n[161]=o.Loglikelihood,n[162]=o.ProbSugClickGivenBackground,n[163]=o.ClicksOnSugGivenPref,n[164]=o.ProbSugClickGivenPref,n[165]=o.CCR,n[166]=o.EventCount,n[293]=o.ProbSugClickGivenPrefTime,n[168]=o.CCRTime,n[294]=o.ProbSugClickGivenBackgroundTime,n[295]=o.LoglikelihoodTime):(n[6]=o.Loglikelihood,n[3]=o.ProbSugClickGivenBackground,n[151]=o.ClicksOnSugGivenPref,n[0]=o.ProbSugClickGivenPref,n[94]=o.CCR,n[95]=o.EventCount,n[290]=o.ProbSugClickGivenPrefTime,n[155]=o.CCRTime,n[291]=o.ProbSugClickGivenBackgroundTime,n[292]=o.LoglikelihoodTime))}}function pt(n,t,i){if(t){let r=t[i];r&&(n[256]=r.PSGPCR,n[257]=r.PSGCCR,n[258]=r.PSGSTR,n[286]=r.PSGSATCCR,n[287]=r.PSGSATPCR)}}function i(n,t){return(n+"\t"+t).toLocaleLowerCase()}function r(t,i,r){i==11..toString()&&i==0..toString();switch(n.config.athenaKeyType){case 0:return t||n.LogWSBError("getAthenaGroupKey",null,new Error("Athena key group is empty"),undefined,undefined,"WindowsTelemetry"),t;case 1:return i||n.LogWSBError("getAthenaGroupKey",null,new Error("Athena key handoff is empty"),undefined,undefined,"WindowsTelemetry"),i;case 2:return r||n.LogWSBError("getAthenaGroupKey",null,new Error("Athena key suggestion type is empty"),undefined,undefined,"WindowsTelemetry"),i||n.LogWSBError("getAthenaGroupKey",null,new Error("Athena key handoff is empty"),undefined,undefined,"WindowsTelemetry"),r+"_"+i;default:return n.LogWSBError("getAthenaGroupKey",null,new Error("Athena key group type is not set"),undefined,undefined,"WindowsTelemetry"),""}}function u(t,i,r){switch(n.config.athenaKeyType){case 0:return i==t;case 1:return r==t;case 2:return r==t;default:return!1}}function wt(t){let i={};return t?(n.config.athenaKeyType==2?dt(t,i):(bt(t,i),kt(t,i)),i):i}function bt(t,f){let a=t.Suggestions?t.Suggestions.split("\t"):[],v=t.ProbSugClickGivenPrefs?t.ProbSugClickGivenPrefs.split("\t"):[],y=t.ClicksOnSugGivenPrefs?t.ClicksOnSugGivenPrefs.split("\t"):[],p=t.ProbSugClickGivenBackground?t.ProbSugClickGivenBackground.split("\t"):[],w=t.Loglikelihoods?t.Loglikelihoods.split("\t"):[],c=t.SuggestionGroups?t.SuggestionGroups.split("\t"):[],b=t.ProbSugClickGivenPrefWeeks?t.ProbSugClickGivenPrefWeeks.split("\t"):[],l=t.ProbSugClickGivenPrefWeekends?t.ProbSugClickGivenPrefWeekends.split("\t"):[],k=t.ProbSugClickGivenBackgroundWeeks?t.ProbSugClickGivenBackgroundWeeks.split("\t"):[],nt=t.ProbSugClickGivenBackgroundWeekends?t.ProbSugClickGivenBackgroundWeekends.split("\t"):[],d=t.LoglikelihoodWeeks?t.LoglikelihoodWeeks.split("\t"):[],g=t.LoglikelihoodWeekends?t.LoglikelihoodWeekends.split("\t"):[],s=n.config.athenaKeyType==0||!t.SuggestionHandOffTypes?[]:t.SuggestionHandOffTypes.split("\t"),o=a.length,h=e();if(u(o,c.length,s.length))for(let t=0;t<o;t++){let e=c&&c.length>t?c[t]:"",tt=s&&s.length>t?s[t]:"",it=r(e,tt,""),u=i(a[t],it);f[u]={SuggestionGroup:+c[t]};p.length==o&&(f[u].ProbSugClickGivenBackground=Number(p[t]));v.length==o&&(f[u].ProbSugClickGivenPref=Number(v[t]));y.length==o&&(f[u].ClicksOnSugGivenPref=Number(y[t]));w.length==o&&(f[u].Loglikelihood=Number(w[t]));n.config.athenaKeyType!=0&&s.length==o&&(f[u].SuggestionHandOffType=Number(s[t]));b.length!=o||h?l.length==o&&h&&(f[u].ProbSugClickGivenPrefTime=Number(l[t])):f[u].ProbSugClickGivenPrefTime=Number(b[t]);k.length!=o||h?l.length==o&&h&&(f[u].ProbSugClickGivenBackgroundTime=Number(nt[t])):f[u].ProbSugClickGivenBackgroundTime=Number(k[t]);d.length!=o||h?g.length==o&&h&&(f[u].LoglikelihoodTime=Number(g[t])):f[u].LoglikelihoodTime=Number(d[t])}else n.LogWSBError("parseLLSignals",null,new Error("Length doesn't match"),undefined,undefined,"WindowsTelemetry")}function kt(t,f){let c=t.CCRSuggestions?t.CCRSuggestions.split("\t"):[],h=t.CCRSuggestionGroups?t.CCRSuggestionGroups.split("\t"):[],l=t.CCRs?t.CCRs.split("\t"):[],a=t.EventCounts?t.EventCounts.split("\t"):[],s=n.config.athenaKeyType==0||!t.CCRSuggestionHandOffTypes?[]:t.CCRSuggestionHandOffTypes.split("\t"),v=t.CCRsWeek?t.CCRsWeek.split("\t"):[],y=t.CCRsWeekend?t.CCRsWeekend.split("\t"):[],o=c.length,p=e();if(u(o,h.length,s.length))for(let t=0;t<o;t++){let e=h&&h.length>t?h[t]:"",w=s&&s.length>t?s[t]:"",b=r(e,w,""),u=i(c[t],b);f[u]||(f[u]={SuggestionGroup:Number(h[t])});l.length==o&&(f[u].CCR=Number(l[t]));a.length==o&&(f[u].EventCount=Number(a[t]));n.config.athenaKeyType!=0&&s.length==o&&(f[u].CCRSuggestionHandOffType=Number(s[t]));v.length!=o||p?y.length==o&&p&&(f[u].CCRTime=Number(y[t])):f[u].CCRTime=Number(v[t])}else n.LogWSBError("parseCCRSignals",null,new Error("Length doesn't match"),undefined,undefined,"WindowsTelemetry")}function dt(t,i){let e=t.SugTypes?t.SugTypes.split("\t"):[],o=t.HandOffTypes?t.HandOffTypes.split("\t"):[],s=t.PSGPCRs?t.PSGPCRs.split("\t"):[],h=t.PSGCCRs?t.PSGCCRs.split("\t"):[],c=t.PSGSTRs?t.PSGSTRs.split("\t"):[],l=t.PSGSATCCRs?t.PSGSATCCRs.split("\t"):[],a=t.PSGSATPCRs?t.PSGSATPCRs.split("\t"):[],f=e.length;if(u(f,0,o.length))for(let n=0;n<f;n++){let u=e[n],v=o[n],t=r("",v,u);i[t]={};s.length==f&&(i[t].PSGPCR=Number(s[n]));h.length==f&&(i[t].PSGCCR=Number(h[n]));c.length==f&&(i[t].PSGSTR=Number(c[n]));l.length==f&&(i[t].PSGSATCCR=Number(l[n]));a.length==f&&(i[t].PSGSATPCR=Number(a[n]))}else n.LogWSBError("parseGroupEngagementSignals",null,new Error("Length doesn't match"),undefined,undefined,"WindowsTelemetry")}function gt(n,t){let i={};if(t){let u=0,f=0,r={};for(let{key:e,value:o}of t){r[e]={lexicalSimilarity:0,groupClickCounts:{},groupWeight:{}};f+=a(r,e,n);let t=y(o);r[e].groupClickCounts=t.groupLaunches;for(let n in r[e].groupClickCounts)i[n]||(i[n]={probability:0,weight:0}),i[n].probability+=t.groupHits[n],u+=t.groupHits[n]}v(i,r,f,u)}return i}function ni(n,t){let i={};if(t){let u=0,f=0,r={};for(let{key:o,value:e}of t){r[o]={lexicalSimilarity:0,groupClickCounts:{},groupWeight:{}};f+=a(r,o,n);for(let n in e)e[n]&&e[n].prefixLaunchCount&&(i[n]||(i[n]={probability:0,weight:0}),r[o].groupClickCounts[n]=e[n].prefixLaunchCount,i[n].probability++,u++)}v(i,r,f,u)}return i}function a(n,t,i){let r=t.length-i.length,u=r/t.length;return n[t].lexicalSimilarity=1-u,n[t].lexicalSimilarity}function v(n,t,i,r){let u=0;for(let n in t){let r=t[n];r.lexicalSimilarity/=i;for(let n in r.groupClickCounts){let t=r.groupClickCounts[n];r.groupWeight[n]=t*r.lexicalSimilarity;u+=r.groupWeight[n]}}for(let t in n)n[t].probability/=r;for(let i in t){let r=t[i];for(let t in r.groupClickCounts)n[t]||(n[t]={probability:0,weight:0}),r.groupWeight[t]/=u,n[t].weight+=r.groupWeight[t]}}function y(n){let i=(n,t,i)=>n[t]=n[t]?n[t]+i:i,t={groupLaunches:{},groupHits:{},otherGroupLaunches:0};for(let r in n){let u=n[r];if(u&&u.prefixLaunchCount){let f=u.groupType;f||f===0?(i(t.groupLaunches,f,u.prefixLaunchCount),i(t.groupHits,f,1)):t.otherGroupLaunches+=u.prefixLaunchCount}}return t}function ti(n,t,i,r){if(r){let f=i(t),u=r[f];u&&(n[266]=u.probability,n[267]=u.weight)}}function e(t){let i=t?t.getDay():n.getCurrentDate().getDay();return i==6||i==0}function ii(n){for(let t in n)n[t]?n[t]=p(Number(n[t])):delete n[t]}function p(n){return Number(n.toFixed(5))}function ri(n,t){n.featureStore||(n.featureStore={});n.featureStore[t]=1}n.getTextForLexicalFeatures=w;n.stringHashCode=f;n.cyrb128=o;n.sfc32=s;n.getRNG=b;n.getEditDistance=t;n.getEditDistanceIgnoreCase=k;n.computeEditDistanceRatio=h;n.computeJaroSimilarity=c;n.computeJaroWinklerSimilarity=d;n.computeJaroWinklerPrefixOverLapCount=l;n.isWordBoundary=g;n.countMaxContiguousRepeatedChars=nt;n.getNumberOfWords=tt;n.containsOnlyDigitsLettersOrSpaces=it;n.endsWithSpace=rt;n.prefixIsLikeUrl=ut;n.computeUrlFeatures=ft;n.computeDomainFeatures=et;n.computeTitleFeatures=ot;const st=["www.bing.","cn.bing.","www.google.","www.yandex.","www.baidu.","www.yahoo.",],ht=["http://","https://",];n.getSumMruLaunches=lt;n.setMRUSignal=at;n.setMRUBackPropSignal=vt;n.setEngagementSignals=yt;n.setSuggestionGroupEngagementSignals=pt;n.getEngagementSignalKey=i;n.getAthenaGroupKey=r;n.checkAthenaGroupLength=u;n.parseWebEngagementSignals=wt;n.computeGroupBackpropagatedClicks=gt;n.computeSuggestionBackpropagatedClicks=ni;n.evaluateGroupLaunches=y;n.setMRUGroupBackpropClicks=ti;n.isWeekend=e;n.removeUndefinedAndZeroAndTrimValues=ii;n.trimFeatureStoreValue=p;n.setFlagInFeatureStore=ri}(WSB||(WSB={})),function(n){var t;(function(t){function r(n){return n[1060]?n[1060]:0}function u(n){return n.isSearchHomeZI}const i=.4;t.suggestionRankingModels={};t.suggestionFastRankModelIdCurrent="STH_00000000-0000-0000-0000-000000000000";t.randomizationRank=r;t.suggestionRankingModels.STH_randomizationranker=r;class f{rank(t,i,r,f,e,o,s,h,c){var v,y,p,w,a;if(u(t))return{topResults:[],mruSuppressions:null};if(t.scope==n.Scope.PathCompletion)return this.rankPathCompletion(i);let b=n.isL2(t)?null:{mruGroupRatios:null,maxGroupCCR:null,maxGroupProbSugClickGivenPref:null,mruGroupBackpropWeights:null,mruGroupBackpropRatios:null},k=i.slice();this.orderSuggestions(t,i,r,f,o,s,h,b,e);this.setMRUHintEnabled(t,i);this.setGroupSuppressionSignals(b,i);let d=this.getTopHitCandidates(t,i,c.searchTheWeb,k),l=this.createMulticlassClassifierTopHitSuggestionList(d);if((n.config.enableCopIFFExpPlan||n.config.mergeMultipleResouces)&&l.length>0&&(n.isDocument((v=l[0])===null||v===void 0?void 0:v.type)||n.isPhoto((y=l[0])===null||y===void 0?void 0:y.type))&&!n.isNullOrUndefined((p=l[0])===null||p===void 0?void 0:p.deviceItem)){let t=undefined,r=0,u=n.isNullOrUndefined(l[0].maxRankScoreForLocalDevice)?l[0].deviceItem.rankScore:l[0].maxRankScoreForLocalDevice;for(let f=0;f<i.length;f++)n.getGroupType(i[f])!==n.getGroupType(l[0])||n.isNullOrUndefined((w=i[f])===null||w===void 0?void 0:w.deviceItem)||(a=n.isNullOrUndefined(i[f].maxRankScoreForLocalDevice)?i[f].deviceItem.rankScore:i[f].maxRankScoreForLocalDevice,t===undefined?a>u&&(t=i[f],r=a):a>r&&(t=i[f],r=a));t!==undefined&&(l[0]=t)}return this.replaceTopSettingSuggestions(l,i),{topResults:l,mruSuppressions:b}}replaceTopSettingSuggestions(t,i){var r;if(n.Host.getJupiterProviderEnabled()&&n.Host.getCoPSTRankPlanEnabled()&&t.length>0){let u=t.findIndex(t=>n.isSetting(t.type));if(u>=0){let o=t.findIndex(t=>n.isDefaultSynthetic(t)),s=t.findIndex(t=>n.isWebRelatedSuggestion(t)),f=undefined,e=this.getSettingRankScore(t[u]);for(let o=0;o<i.length;o++)if(n.getGroupType(i[o])===n.getGroupType(t[u])&&!n.isNullOrUndefined((r=i[o])===null||r===void 0?void 0:r.deviceItem)){let r=this.getSettingRankScore(i[o]);n.isNullOrUndefined(f)?this.compareSettingScore(r,i[o],e,t[u])&&(e=r,f=i[o]):this.compareSettingScore(r,i[o],e,f)&&(e=r,f=i[o])}n.isNullOrUndefined(f)||(t[u]=f);let h=o>=0?o:s>=0?s:-1;if(h>=0&&t.length===2&&h<u){let n=t.slice(0,1)[0];t.splice(0,1);t.push(n)}}}}compareSettingScore(t,i,r,u){return n.Host.getJupiterProviderEnabled()&&n.Host.getCoPSTRankPlanEnabled()?n.isNonCopilotPoweredSetting(i.type)&&n.isNonCopilotPoweredSetting(u.type)?t>r:i.type=="CoPST"&&u.type=="CoPST"?n.isModernSetting(i.deviceItem)&&n.isModernSetting(u.deviceItem)?t<r:n.isModernSetting(i.deviceItem)&&!n.isModernSetting(u.deviceItem)?!0:!1:n.isNonCopilotPoweredSetting(i.type)&&u.type=="CoPST"?!0:i.type=="CoPST"&&n.isNonCopilotPoweredSetting(u.type)?!1:(n.LogWSBError("compareSettingScore",i.type,new Error("Invalid setting type"),undefined,undefined,"WindowsTelemetry"),undefined):undefined}getSettingRankScore(t){var i;return n.Host.getJupiterProviderEnabled()&&n.Host.getCoPSTRankPlanEnabled()?n.isNonCopilotPoweredSetting(t.type)?t.rankingScore:t.type=="CoPST"?(i=t.deviceItem)===null||i===void 0?void 0:i.rankScore:(n.LogWSBError("getSettingRankScore",t.type,new Error("Invalid setting type"),undefined,undefined,"WindowsTelemetry"),undefined):undefined}isNotChromeIntent(n,t){let i="google chrome";if(t.length==0)return!1;let r=t.filter(n=>n.query.toLocaleLowerCase()==i&&n.type=="PP");return r.length>0&&!n.queryToFetch.includes("c")&&!n.queryToFetch.includes("h")&&!n.queryToFetch.includes("r")&&!n.queryToFetch.includes("m")?!0:!1}setMRUHintEnabled(t,i){if(n.config.enableMRUHint){let r=t.queryToFetch.toLocaleLowerCase();for(let t=0;t<i.length;t++){let u=i[t].featureStore;u[281]&&u[282]&&(n.config.enableMRUHint!=1&&i[t].text.toLocaleLowerCase().startsWith(r)||(i[t].mruHintEnabled=!0))}}}rankPathCompletion(n){let t=n.find(n=>n.type=="CG")||n[0];return{topResults:t?[t]:[],mruSuppressions:null}}selectFastRankRanker(i){if(i)t.suggestionFastRankModelIdCurrent=i;else if(n.config.wsbEnableRandomization){let i=n.getRNG(n.Host.getConversationId());t.suggestionFastRankModelIdCurrent=n.config.wsbRandomizationProbability==1||i()<n.config.wsbRandomizationProbability?"STH_randomizationranker":"STH_00000000-0000-0000-0000-000000000000"}let r=t.suggestionRankingModels[t.suggestionFastRankModelIdCurrent];if(!r){let i;if(i=n.config.secondRankerId&&(n.isMsftAccountConnected||n.isMsbEnterprise()||n.AccessTokenManager.getWindowsAccountType()==1)?n.config.secondRankerId:n.config.mainRankerId,i){if(r=t.suggestionRankingModels[i],r)return t.suggestionFastRankModelIdCurrent=i,r;if(i!=n.config.mainRankerId)r=this.selectFastRankRanker(n.config.mainRankerId);else if(t.suggestionFastRankModelIdCurrent="STH_00000000-0000-0000-0000-000000000002",n.config.enbaleGetRankerNewLog){let r=[];for(let n in t.suggestionRankingModels)r.push(n);let u=r.sort().join("|");n.LogWSBError("getRanker",i+"#TAB#"+u,new Error("Model not found"),undefined,undefined,"WindowsTelemetry")}else n.LogWSBError("getRanker",i,new Error("Model not found"),undefined,undefined,"WindowsTelemetry")}else n.LogWSBError("getRanker",i,new Error("fastRank RankerId not defined"),undefined,undefined,"WindowsTelemetry"),t.suggestionFastRankModelIdCurrent="STH_00000000-0000-0000-0000-000000000003"}return r}orderSuggestions(t,i,r,u,f,e,o,s,h){var l,a;if(n.config.perfLogging&&n.WSBPerformance&&n.WSBPerformance.getInstance().beginMark("WSBRanking.orderSuggestions"),!n.config.bypassRankerOnNoNewSuggestions||t.hasNewSuggestions){let v=n.safeExecute(()=>this.createFeatureStore(t,i,r,u,f,e,o,s,h),"createFeatureStore");v=v||i.map(()=>({}));let p=this.selectFastRankRanker();if(p){let t=-1,r=-1;for(let u=0;u<i.length;u++){let f=v[u];if(i[u].handoffType!==21||!i[u].skipRerank){let e=n.safeExecute(()=>p(f),"calculateRankingScore");if(i[u].rankingScore=n.trimFeatureStoreValue(e),i[u].featureStore=f,n.config.enableMruProviderInQF&&n.config.useRankerRankScore&&((l=i[u])===null||l===void 0?void 0:l.subType)==="MRUHS"&&(n.AccessTokenManager===null||n.AccessTokenManager===void 0?void 0:n.AccessTokenManager.getWindowsAccountType())===3){if(t===-1){t=u;continue}r===-1?i[t].rankingScore>=i[u].rankingScore?r=u:(r=t,t=u):i[t].rankingScore>=i[u].rankingScore?i[r].rankingScore<i[u].rankingScore&&(r=u):(r=t,t=u)}}}if(n.config.enableMruProviderInQF&&n.config.useRankerRankScore&&(n.AccessTokenManager===null||n.AccessTokenManager===void 0?void 0:n.AccessTokenManager.getWindowsAccountType())===3)for(let n=i.length-1;n>=0;--n)((a=i[n])===null||a===void 0?void 0:a.subType)==="MRUHS"&&n!==t&&n!==r&&i.splice(n,1)}if(n.config.enableAnaheimRelevance){let t=[];n.config.enableAnaheimRelevance==1?t=i.filter(n=>n.anaheimRankingSignals):n.config.enableAnaheimRelevance==2&&(t=i.filter(t=>n.getGroupType(t)==n.GroupType.SearchSuggestions));this.getWebRankingWithAnaheimAdapter(t)}let y=i.filter(n=>n.type=="MB"),[c]=this.splitSuggestionsByGroup(i);if(i.sort((n,t)=>t.rankingScore-n.rankingScore),y.length>1){let n=i.map((n,t)=>n.type=="MB"?t:undefined).filter(n=>typeof n=="number");for(let t=0;t<y.length;++t)i[n[t]]=y[t]}if(c.length>0){let[,t]=this.splitSuggestionsByGroup(i);if(n.config.enableRankByGroupFirstEle){let r;if(n.Host.getJupiterProviderEnabled()&&n.Host.getCoPSTRankPlanEnabled()){let n=t.findIndex(n=>n.type=="CoPST")>=0;r=n?!0:(t===null||t===void 0?void 0:t.length)>0&&t[0].rankingScore>c[0].rankingScore}else r=(t===null||t===void 0?void 0:t.length)>0&&t[0].rankingScore>c[0].rankingScore;i.splice(0);r?i.push(...t,...c):i.push(...c,...t)}}n.config.perfLogging&&n.WSBPerformance&&n.WSBPerformance.getInstance().endMark("WSBRanking.orderSuggestions")}}splitSuggestionsByGroup(t){const[i,r]=t.reduce(([i,t],r)=>n.getGroupType(r)===n.GroupType.SearchSuggestions?[[...i,r],t]:[i,[...t,r]],[[],[]]);return[i,r]}getWebRankingWithAnaheimAdapter(t){const i=10,e=-1;let r=!1,u=new Array(i),f=n=>{if(n==e&&!r)return r=!0,-400;n=Math.floor(n);n>i-1&&(n=i-1);let t=-(n*100+500)-u[n];return u[n]+=1,t},o=n=>{for(let t of n)if(t.suggestionLogMeta){let n=this.getSuggestionScoreFromSuggestionLogMeta(t.suggestionLogMeta);if(n)return n}return 64e3};t.sort((n,t)=>t.rankingScore-n.rankingScore);for(let n=0;n<i;++n)u[n]=0;let s=o(t);for(let u of t){let t=this.getRankingBucketWithAnaheimAdapter(u,s,i);u.rankingScore=t!=null&&t>=0?!r&&u.anaheimRankingSignals&&t<=n.config.anaheimDataTopHitThreshold?f(e):f(t):f(i)}}getRankingBucketWithAnaheimAdapter(t,i,r){let u=Math.pow(2,-(i/8e3)+2);if(t.anaheimRankingSignals){let i=t.anaheimRankingSignals.dateVisited,u=(n.getCurrentTime()-i.getTime())/864e5,f=t.anaheimRankingSignals.visitCount,e=t.anaheimRankingSignals.urlTypedCount,o=.6*Math.exp(-u/14)+.25*(1-Math.exp(-f/6))+.15*(1-Math.exp(-e/2));return Math.floor(r*(1-o))}if(t.suggestionLogMeta){let n=this.getSuggestionScoreFromSuggestionLogMeta(t.suggestionLogMeta);if(n)return Math.floor((n-i)/u)}return null}getSuggestionScoreFromSuggestionLogMeta(n){let t=";2152:";return n&&n.indexOf(t)>=0?parseInt(n.substring(n.indexOf(t)+6).split(";")[0].slice(1,-1)):NaN}getTopWebSuggestion(t){if(t.length==0)return null;n.config.perfLogging&&n.WSBPerformance&&n.WSBPerformance.getInstance().beginMark("WSBRanking.getTopWebSuggestion");let i=t[0],r=64e3;if(t.length>1)for(let n of t)if(n.suggestionLogMeta){let t=this.getSuggestionScoreFromSuggestionLogMeta(n.suggestionLogMeta);!isNaN(t)&&t<r&&(r=t,i=n)}return n.config.perfLogging&&n.WSBPerformance&&n.WSBPerformance.getInstance().endMark("WSBRanking.getTopWebSuggestion"),i}applyQueryOverride(t){return n.config.msbQueryOverrideTenant&&(t===null||t===void 0?void 0:t.queryToFetch)&&n.contains(n.config.msbQueryOverrideTenant,t.queryToFetch.toLowerCase())}bypassFallbackForMSB(t,i,r){return(n.config.bypassFallbackOnMSBTopHit==2||n.config.bypassFallbackOnMSBTopHit==3)&&i.every(t=>n.isWebSuggestion(t)||n.isMsbQFSuggestion(t)||t.isAnswer)?n.isMsftAccountConnected&&this.applyQueryOverride(t)?!1:!0:(n.config.bypassFallbackOnMSBTopHit==1||n.config.bypassFallbackOnMSBTopHit==4)&&!i.some(t=>n.isApp(t.type)||n.isSetting(t.type))&&r.length>0&&n.isMsbOnlineSuggestionType(r[0].type)?!0:n.config.bypassFallbackOnMSBTopHit==4&&!i.some(t=>n.isApp(t.type)||n.isSetting(t.type))&&r.length>1&&(r[0].isAnswer||n.isWebSuggestion(r[0]))&&(n.isMsbOnlineSuggestionType(r[1].type)||r.length>2&&r[0].isAnswer&&r[1].isAnswer&&n.isMsbOnlineSuggestionType(r[2].type))?!0:!1}getTopHitCandidates(t,r,u,f){n.config.perfLogging&&n.WSBPerformance&&n.WSBPerformance.getInstance().beginMark("WSBRanking.getTopHitCandidates");let e=r.filter(n=>this.allowInTopHit(t,n,f));if(this.bypassFallbackForMSB(t,r,e,f)){const s=n.getMsbTophitSuggestionTypeOrder();let o=[],u=[];for(const t of s)if(u=n.config.useWsbRankingForMsbFile&&t.length==1&&t[0]=="MFIL"?r.filter(n=>n.type=="MFIL"&&n.autoOpenPreviewPaneWhenOnTopHit):f.filter(n=>t.indexOf(n.type)>-1&&n.autoOpenPreviewPaneWhenOnTopHit),u.length>0)break;if(u.length>0&&u[0].autoOpenPreviewPaneWhenOnTopHit&&(n.config.bypassFallbackOnMSBTopHit!=3||n.getTextForLexicalFeatures(u[0]).toLowerCase().startsWith(t.queryToFetch.toLowerCase()))&&o.push(u[0]),n.config.bypassFallbackOnMSBTopHit==4&&(e[0].isAnswer||n.isWebSuggestion(e[0]))&&(e[0].isAnswer||this.getFallbackClassifierScore(e[0])>i)&&o.push(e[0]),o.length>0)return n.config.perfLogging&&n.WSBPerformance&&n.WSBPerformance.getInstance().endMark("WSBRanking.getTopHitCandidates"),o}if(this.enableFallbackClassifier(t,e,u)){if(e=this.getFallbackClassifierSuggestions(e,u),n.config.enableGGSupp&&this.isNotChromeIntent(t,e))return n.config.perfLogging&&n.WSBPerformance&&n.WSBPerformance.getInstance().endMark("WSBRanking.getTopHitCandidates"),[];if(n.config.demoteWebForApps){let i=this.getTopAppSuggestion(r),u=i?i.query.toLocaleLowerCase():"";i&&this.allowInTopHit(t,i)&&e.every(t=>n.isWebSuggestion(t))&&(u.startsWith(t.queryToFetch)||u.includes(" "+t.queryToFetch))&&(e=[i])}return n.config.perfLogging&&n.WSBPerformance&&n.WSBPerformance.getInstance().endMark("WSBRanking.getTopHitCandidates"),e}return n.config.perfLogging&&n.WSBPerformance&&n.WSBPerformance.getInstance().endMark("WSBRanking.getTopHitCandidates"),e}getFallbackClassifierScore(i){let r=n.safeExecute(()=>t.suggestionRankingModels[n.config.fallbackClassifierId],"getFallbackClassifier"),u=r?n.safeExecute(()=>r(i.featureStore),"calculateFallbackClassifierScore"):0;return n.trimFeatureStoreValue(u)}getFallbackClassifierSuggestions(r,u){if(r=r.filter(n=>n.type!="SW"),r.every(n=>n.type=="SW"||n.type=="MACR")||(r=r.filter(n=>n.type!="MACR")),r.length>0){let e=0,f=r[0];if(f.fbcScore=this.getFallbackClassifierScore(f),e=n.config.enableAppsSettingsFbcScoreThreshold?n.isApp(f.type)||n.isSetting(f.type)?n.config.appsSettingsFbcScoreThreshold:n.isWebSuggestion(f)?i:n.config.nonWebFbcScoreThreshold:n.isWebSuggestion(f)?n.config.webFbcScoreThreshold>0?n.config.webFbcScoreThreshold:i:n.config.nonWebFbcScoreThreshold,f.fbcScore<e){if(n.config.disableTopHitForFBC&&f.handoffType!=0&&!t.topHitIsMultiEntity(r)&&1!=(n.AccessTokenManager===null||n.AccessTokenManager===void 0?void 0:n.AccessTokenManager.getWindowsAccountType())){let t=-1;if(t=r.findIndex(n=>n.handoffType==0),t>=0){if(n.config.asTopHitPosForFBC==1){let n=r.slice(t,t+1);return n.push(f),n}if(n.config.asTopHitPosForFBC==2){let n=r.slice(0,1);return n.push(r[t]),n}return r.slice(t,t+1)}}this.isSyntheticWebBlockedInTopHit(u,f)&&(e=0)}return f.fbcScore>=e?r.slice(0,t.topHitIsMultiEntity(r)?2:1):[]}return[]}enableFallbackClassifier(t,i,r){if(r&&n.config.fallbackClassifierId&&i.length>0){let t=i[0];return n.getGroupType(t)==n.GroupType.Cortana?!1:t.isAnswer?!1:!0}return!1}getTopAppSuggestion(t){for(let i of t)if(n.isApp(i.type))return i;return null}isRecourse(t){return t.notAResult&&!n.contains(["SW","PWL","SSTS"],t.type)}allowInTopHit(t,i,r){if((t===null||t===void 0?void 0:t.scope)!=n.Scope.Web&&i.type=="SW"&&(r===null||r===void 0?void 0:r.length)>1&&this.isSyntheticWebBlockedInTopHit(i,r[0]))return!1;let u=!r||r.length==1;if(n.config.demoteTopHitOnNoQueryMatch&&(n.isApp(i.type)||n.isSetting(i.type))&&!i.ciMatchedQuery&&!i.query.toLocaleLowerCase().includes(t.queryToFetch.toLocaleLowerCase()))return!1;if(t.topHitRestriction==1&&i.query.toLocaleLowerCase()!=t.queryToFetch.toLocaleLowerCase()&&(n.contains(i.features,"ForcePrefixOnTop")||i.features.push("ForcePrefixOnTop")),this.isRecourse(i))return u;let f=n.getGroupType(i);switch(f){case n.GroupType.Store:return i.hc;case n.GroupType.Command:return i.hc||u;case n.GroupType.LocalPlaces:return!1}if(n.getScope(f)==n.Scope.Emails&&!i.hc)return!1;if(n.enforceOriginalOrder(i)&&r)for(let n of r){if(n==i)break;if(n.type==i.type&&n.handoffType==i.handoffType&&n.sourceForGroup==i.sourceForGroup)return!1}return n.RuntimeConfig.QfMode!=11&&n.RuntimeConfig.AlwaysWide&&!i.previewPaneType?!1:!0}isSyntheticWebBlockedInTopHit(t,i){return n.config.enableBlockSWTopHit&&t.type=="SW"&&i.rankingScore-t.rankingScore>n.config.swTopHitRankScoreThreshold&&!n.prefixNormalizedSuggTypes.has(i.type)?!0:!1}createMulticlassClassifierTopHitSuggestionList(i){let r=0;if(n.config.disableTopHitForFBC)r=i.length;else if(n.Host.getJupiterProviderEnabled()&&n.Host.getCoPSTRankPlanEnabled())r=Math.min(i.length,n.config.maxNumberOfTopResults)-1;else for(let t=0;t<Math.min(i.length,n.config.maxNumberOfTopResults);t++)i[t].rankingScore!==undefined&&i[t].rankingScore>.5&&(r=t);return r==0&&t.topHitIsMultiEntity(i)&&(r=1),n.config.bypassFallbackOnMSBTopHit==4&&i.length>0&&n.isMsbOnlineSuggestionType(i[0].type)&&(r=1),i.slice(0,r+1)}createFeatureStore(t,i,r,u,f,e,o,s,h){let p=[],a=0,w=0,v=0,y=t.queryToFetch.toLocaleLowerCase(),nt=t=>n.getGroupType(t),b=n.getSumMruLaunches(u),k=0,d={};if(u){let t=n.evaluateGroupLaunches(u);k=t.otherGroupLaunches;d=t.groupLaunches}let g=n.computeGroupBackpropagatedClicks(t.queryToFetch,h),tt=n.computeSuggestionBackpropagatedClicks(t.queryToFetch,h);for(let t of i)if(t.handoffType==2){let i=n.getAppItem(t);i&&(w+=i.totalLaunches,i.totalLaunches>a&&(a=i.totalLaunches));t.deviceItem&&t.deviceItem.rankScore>v&&(v=t.deviceItem.rankScore)}let c={};n.isWeekend()&&(c[440]=1);c[441]=this.getLocalHourBucket(new Date);let l=y.split(" ");for(let n of l){if(n=="install"){c[451]=1;break}if(n=="uninstall"){c[450]=1;break}}if(l&&l.length>0){let n=l[0];c[452]=n.indexOf("c:")>-1||n.indexOf("d:")>-1||n.indexOf("e:")>-1||n.indexOf("f:")>-1?1:0}for(let h of i){let i=this.getSuggestionFeatureStore(y,h,f,r,w,o);i[13]=a;i[7]=v;r&&r.WebSignalsAvailable&&(i[93]=1);n.setMRUSignal(n.getSuggestionKey(h),i,u,b);this.setMRUGroupLaunchRatios(i,h,b,d,k,s);n.setMRUBackPropSignal(n.getSuggestionKey(h),i,tt);g&&n.setMRUGroupBackpropClicks(i,h,nt,g);let l=n.getTextForLexicalFeatures(h);if(l){if(h.handoffType==1){n.computeUrlFeatures(l,t.queryToFetch,i,e);let r=n.getDomain(l);n.computeDomainFeatures(h,t.queryToFetch,i,e,r,f)}if(n.isFileOrFolder(h.type)){let t=e.cvid+e.privacyNumber+l;i[131]=n.stringHashCode(t)}}if(c&&(i[440]=c[440],i[441]=c[441],i[451]=c[451],i[450]=c[450],i[452]=c[452]),n.config.enbaleCateFeature){n.config.undocked?i[1003]=1:i[1002]=1;switch(n.AccessTokenManager.getWindowsAccountType()){case 2:i[1032]=1;break;case 1:i[1030]=1;break;case 3:i[1031]=1;break;case 0:i[1033]=1}n.isApp(h.type)?i[1029]=1:n.isSetting(h.type)?i[1022]=1:h.type=="SW"?i[1021]=1:n.isWebSuggestion(h)?i[1023]=1:h.handoffType==10?i[1015]=1:n.isDocument(h.type)?i[1017]=1:n.isFolder(h.type)?i[1018]=1:n.isPhoto(h.type)?i[1020]=1:h.type=="CG"?i[1016]=1:h.type=="LV"?i[1024]=1:h.type=="MU"?i[1028]=1:h.type=="PPL"?i[1025]=1:h.type=="MD"?i[1026]=1:i[1019]=1}if(n.config.wsbEnableRandomization){let t=n.Host.getConversationId(),r=n.getRNG(t);if(n.config.wsbRandomizationProbability==1||r()<n.config.wsbRandomizationProbability){let r=t+y+h.type+l,u=n.getRNG(r);i[1060]=n.trimFeatureStoreValue(u())}}n.removeUndefinedAndZeroAndTrimValues(i);p.push(i)}return p}setGroupSuppressionSignals(t,i){if(t){t.maxGroupCCR={};t.maxGroupProbSugClickGivenPref={};t.mruGroupBackpropRatios={};t.mruGroupBackpropWeights={};for(let r of i)if(r.featureStore){let i=n.getGroupType(r),u=r.featureStore[94]||0,f=r.featureStore[0]||0;t.maxGroupCCR[i]=t.maxGroupCCR[i]?Math.max(t.maxGroupCCR[i],u):u;t.maxGroupProbSugClickGivenPref[i]=t.maxGroupProbSugClickGivenPref[i]?Math.max(t.maxGroupProbSugClickGivenPref[i],f):f;t.mruGroupBackpropRatios[i]=r.featureStore[266];t.mruGroupBackpropWeights[i]=r.featureStore[267];(t.mruGroupBackpropWeights[i]||t.mruGroupBackpropRatios[i])&&(t.backPropDataExists=!0)}}}setMRUGroupLaunchRatios(t,i,r,u,f,e){var o,s,h,c,l,a,v,y;if(r){e&&(e.mruGroupRatios={});t[186]=f/r;for(let f in u){let p=u[f]/r;n.getGroupType(i)==Number(f)&&(t[271]=p);e&&(e.mruGroupRatios[f]=p);switch(Number(f)){case n.GroupType.Apps:t[169]=p;break;case n.GroupType.Settings:t[170]=p;break;case n.GroupType.Cortana:t[171]=p;break;case n.GroupType.Command:t[172]=p;break;case n.GroupType.Photos:t[173]=p;break;case n.GroupType.Videos:t[174]=p;break;case n.GroupType.Music:t[175]=p;break;case n.GroupType.Documents:t[176]=p;break;case n.GroupType.Folders:t[177]=p;break;case n.GroupType.Emails:t[178]=p;break;case n.GroupType.Store:t[179]=p;break;case n.GroupType.SearchSuggestions:if(n.config.enableFromYourHistory){t[262]=((o=t[262])!==null&&o!==void 0?o:0)+p;let i=((s=u[n.GroupType.Websites])!==null&&s!==void 0?s:0)+((h=u[n.GroupType.FromYourHistory])!==null&&h!==void 0?h:0);t[180]=i>0?(i+u[f])/r:p}else t[262]=p,t[180]=u[n.GroupType.Websites]?(u[n.GroupType.Websites]+u[f])/r:p;break;case n.GroupType.FromYourHistory:t[262]=((c=t[262])!==null&&c!==void 0?c:0)+p;let i=((l=u[n.GroupType.Websites])!==null&&l!==void 0?l:0)+((a=u[n.GroupType.SearchSuggestions])!==null&&a!==void 0?a:0);t[180]=i>0?(i+u[f])/r:p;break;case n.GroupType.Websites:if(t[263]=p,n.config.enableFromYourHistory){let i=((v=u[n.GroupType.SearchSuggestions])!==null&&v!==void 0?v:0)+((y=u[n.GroupType.FromYourHistory])!==null&&y!==void 0?y:0);t[180]=i>0?(i+u[f])/r:p}else t[180]=u[n.GroupType.SearchSuggestions]?(u[n.GroupType.SearchSuggestions]+u[f])/r:p;break;case n.GroupType.PathCompletion:t[181]=p;break;case n.GroupType.People:t[184]=p;break;case n.GroupType.Bookmarks:t[260]=p;break;case n.GroupType.LocalPlaces:t[261]=p}}}}getRank(t){var i=undefined;if(t.deviceItem&&typeof t.deviceItem.rankScore!="undefined"&&(i=t.deviceItem.rankScore),!n.isNullOrUndefined(t.maxRankScoreForLocalDevice)&&t.maxRankScoreForLocalDevice>i&&(i=t.maxRankScoreForLocalDevice),i!=undefined)return i;let r=n.isJumpListSuggestion(t)?t.jumpListItem.usagePoints:undefined;return typeof r!="undefined"?r:undefined}getSuggestionFeatureStore(t,i,r,u,f,e){let o={};this.setTypeSignal(i,o);let l=n.getAppItem(i);l?(o[2]=l.totalLaunches,o[92]=l.launchArguments?1:0,f>0&&(o[103]=l.totalLaunches/f),this.addLastAccessDate(l.lastAccessed,o)):this.addLastAccessDate(n.isJumpListSuggestion(i)?i.jumpListItem.lastAccessed:null,o);o[99]=i.confidence;o[150]=i.source;o[283]=i.pinnedToTaskbar?1:undefined;i.hc&&(o[189]=1);o[17]=i.highConfidenceMetaSuggestionScore;let p=this.getRank(i);typeof p!="undefined"?o[16]=p:o[4]=1;var h=i;h.matchedOnlyOnContent&&(o[259]=1);h.matchedOnlyOnAuthor&&(o[273]=1);h.lastModifiedDate&&(o[268]=n.getTimeDiffInDays(h.lastModifiedDate));n.config.populateLastAccessDateForFiles&&h.lastAccessDate&&(o[9]=n.getTimeDiffInDays(h.lastAccessDate),o[19]=0);h.extensionLC==".lnk"&&(o[272]=1);(n.config.enableCopIFFExpPlan||n.config.mergeMultipleResouces)&&(i.isLexicalMatched&&(o[1040]=1),i.isFullTextMatched&&(o[1041]=1),i.isPolarisMatched&&(o[1042]=1),i.isVegaMatched&&(o[1043]=1),i.indexerIntentFeature&&(o[1050]=1));n.Host.getJupiterProviderEnabled()&&(i.isJupiterMatched&&(o[1044]=1),i.indexerIntentFeature&&(o[1050]=1));o[23]=i.prefetchConfidenceScore;o[264]=u&&u.ProbNextKS!==undefined?u.ProbNextKS:1;o[296]=u&&u.ProbNextKSV2!==undefined?u.ProbNextKSV2:1;this.setThresholdRatios(o,u);this.setRatios(o,u);let a=n.getGroupType(i),v=i.query;i.type=="SW"&&(v="SearchTheWeb");let y=n.getAthenaGroupKey(String(a),String(i.handoffType),i.type);n.setEngagementSignals(o,r,y,v,!1,!1);n.setEngagementSignals(o,e,y,v,!1,!0);e&&!r&&n.setEngagementSignals(o,e,y,v,!1,!1);o[10]=t.length;(i.isAnswer||a==n.GroupType.Cortana)&&(o[11]=1);let c=n.getTextForLexicalFeatures(i),s=c?c.toLocaleLowerCase():null;c||(o[132]=1);s==t&&(o[133]=1);i.handoffType==2&&(o[8]=1,n.isSetting(i.type)&&(o[64]=1),n.isApp(i.type)&&(o[83]=1));(a==n.GroupType.SearchSuggestions||n.config.enableFromYourHistory&&a==n.GroupType.FromYourHistory)&&(i.type!="SW"&&(o[82]=1),o[25]=1);let w=o[132]==1;if(w?o[137]=t.length:(o[137]=c.length,o[134]=n.getEditDistance(t,s),o[135]=Math.min(100,n.computeEditDistanceRatio(o[134],t.length,c.length)),o[136]=n.isWordBoundary(t,c),o[284]=Math.abs(c.length-t.length)),!w&&s){s.indexOf(t)>-1&&(o[143]=1);s.substring(0,t.length)===t&&(o[188]=1);let i=s.split(" ");for(let n of i)if(n==t){o[145]=1;break}o[420]=n.computeJaroSimilarity(t,s);o[421]=n.computeJaroWinklerSimilarity(t,s)}if(o[1]==1&&i.deviceItem){let t=n.getAppItem(i);t.extension&&(o[400]=t.extension===".exe"?1:0,o[401]=t.extension===".appref-ms"?1:0);s&&(o[402]=s.indexOf("install")>-1?1:0)}if(!o[1]&&(n.isDocument(i.type)||n.isFolder(i.type)||i.type=="ST")&&(o[403]=1),(i.type=="QP"||i.type=="QS"||i.type=="SC"||i.type=="OS")&&(o[404]=1),o[8]==1&&(o[27]=o[133]),(i.isAnswer||a==n.GroupType.Cortana)&&(o[55]=o[133]),(i.type=="HS"||i.fromHistory)&&(o[121]=1),o[41]=o[83]==1?o[40]:o[64]==1?o[39]:o[11]==1?o[32]:o[89]==1?o[54]:o[85]==1?o[30]:o[86]==1?o[53]:o[87]==1?o[52]:o[61]==1?o[31]:o[88]==1?o[51]:o[63]==1?o[35]:o[82]==1?o[29]:o[90]==1?o[50]:o[59]==1?o[34]:o[37],n.isSetting(i.type)||n.isApp(i.type)){let n=i.ciMetaData;this.computeConstraintIndexFeatures(i.deviceItem,o,n);i.ciMatchedQuery=this.getConstraintIndexMatchedQuery(n);o[269]&&o[270]&&(o[405]=Math.sqrt(o[269]*o[270]))}return i.signals&&(o[230]=i.signals.DistanceToEntity,o[231]=i.signals.DistanceToEntityPrecision,o[232]=i.signals.RankingScore),o}addLastAccessDate(t,i){let r=n.getTimeDiffInDays(t);r!=null?i[9]=r:i[19]=1}setTypeSignal(n,t){switch(n.type){case"LDOC":case"FL":case"PSFL":case"CSFL":t[61]=1;break;case"LI":case"PSLI":case"CSLI":t[85]=1;break;case"LV":t[86]=1;break;case"MU":t[87]=1;break;case"FD":case"PSFD":case"CSFD":t[88]=1;break;case"CG":t[89]=1;break;case"PT":t[90]=1;break;case"PP":case"IBA":t[1]=1;break;case"ML":case"MD":t[21]=1;break;case"SPP":case"SAPP":t[1014]=1;break;case"SW":t[59]=1}}setRatios(n,t){t&&t.AppsRatio!==undefined&&(n[26]=t.AppsRatio,t.SettingsRatio&&(n[5]=t.SettingsRatio),t.StoreRatio&&(n[57]=t.StoreRatio),t.PrefixProbability&&(n[12]=t.PrefixProbability),t.FilesRatio&&(n[24]=t.FilesRatio),t.WebRatio&&(n[18]=t.WebRatio),t.PhotosVideosMusicRatio&&(n[28]=t.PhotosVideosMusicRatio),t.ContactsRatio&&(n[56]=t.ContactsRatio),t.LocalProtocolRatio&&(n[91]=t.LocalProtocolRatio))}setThresholdRatios(n,t){t&&t.ThApps!==undefined?(n[40]=t.ThApps,t.ThStore&&(n[35]=t.ThStore),t.ThSetting&&(n[39]=t.ThSetting),t.ThCortAns&&(n[32]=t.ThCortAns),t.ThPrefixCount&&(n[38]=t.ThPrefixCount),t.ThWeb&&(n[29]=t.ThWeb),t.ThSearchTheWeb&&(n[34]=t.ThSearchTheWeb),t.ThOther&&(n[37]=t.ThOther),t.ThFile&&(n[31]=t.ThFile),t.ThFolder&&(n[51]=t.ThFolder),t.ThPath&&(n[50]=t.ThPath),t.ThEmail&&(n[33]=t.ThEmail),t.ThCommAns&&(n[54]=t.ThCommAns),t.ThPhotoAns&&(n[30]=t.ThPhotoAns),t.ThVideoAns&&(n[53]=t.ThVideoAns),t.ThMusicAns&&(n[52]=t.ThMusicAns),t.ThDNav&&(n[147]=t.ThDNav)):n[42]=1}computeConstraintIndexFeatures(n,t,i){if(n&&n.rawIndexResponse){if(!i)return;if(t[157]=i.GrammarScore,t[158]=i.MatchScore,i.Parses&&i.Parses.length>0&&i.Parses[0].Entities&&i.Parses[0].Entities.length>0)for(let n of i.Parses[0].Entities)if(t[159]=n.EntityScore,n.Attributes)for(let i of n.Attributes)i.Name=="gscore"?t[269]=Number(i.Value):i.Name=="lscore"&&(t[270]=Number(i.Value))}}getConstraintIndexMatchedQuery(n){return!n||n.MatchScore==0?null:n.Query}getLocalHourBucket(n){let t=n.getHours(),i=1;return t>=0&&t<6?i=1:t>=6&&t<12?i=2:t>=12&&t<18?i=3:t>=18&&t<=23&&(i=4),i}}t.FastRankRanker=f})(t=n.Ranking||(n.Ranking={}))}(WSB||(WSB={})),function(n){class t{constructor(t){this._instrumentationProvider=t;n.Host.bindDismissed(()=>this.flushAggregatedMeasure(!0));this._keystrokeAggregatedFunctionPerf={}}onNewKeystroke(n,t,i){this.flushAggregatedMeasure();this._aggregatedMeasureFlushed=!1;this._currentLeftPaneSuggestions=null;this._currentRawImpressionGuid=t;this._currentRawClientImpressionGuid=SearchAppWrapper.CortanaApp.impressionId;this._keystrokeAggregatedMeasure={CVID:n,WebView2Info:this._instrumentationProvider.getWebView2Info()};this._keystrokeAggregatedFunctionPerf={};this._currentKeystrokeAggregatedMeasureIsForSearchHome=i}flushAggregatedMeasure(t){if((t||this._currentKeystrokeAggregatedMeasureIsForSearchHome)&&!this._aggregatedMeasureFlushed){if(n.config.logClientPerf){let n=Object.keys(this._keystrokeAggregatedFunctionPerf);if(this._keystrokeAggregatedFunctionPerf&&n.length>0){let t="";for(let i of n){let n=this._keystrokeAggregatedFunctionPerf[i];t+=n.functionName+","+n.numCalls+","+n.totalDuration+";"}t=t.substr(0,t.length-1);this._instrumentationProvider.logProfilerMarker(1,0,"KeystrokeAggregatedFuncPerf",this._currentRawClientImpressionGuid,t)}}else this._keystrokeAggregatedMeasure&&Object.keys(this._keystrokeAggregatedMeasure).length>1&&this.logProfilerMarker(1,0,"KeystrokeAggregatedMeasure",this._currentRawImpressionGuid,this._currentRawClientImpressionGuid,this._keystrokeAggregatedMeasure);this._aggregatedMeasureFlushed=!0}}logSingleMeasure(n,t,i){this.logProfilerMarker(1,0,n,t,SearchAppWrapper.CortanaApp.impressionId||t,i)}logProfilerMarker(n,t,i,r,u,f){f&&typeof f!="string"&&u!=r&&(f.ServerIG=r);this._instrumentationProvider.logProfilerMarker(n,t,i,u,f)}logAggregate(n,t){this._keystrokeAggregatedMeasure[n]=t}logAggregateFunctionPerf(n,t){let i=this._keystrokeAggregatedFunctionPerf[n];this._keystrokeAggregatedFunctionPerf[n]=i?{functionName:i.functionName,numCalls:i.numCalls+1,totalDuration:i.totalDuration+t}:{functionName:n,numCalls:1,totalDuration:t}}getItemLayoutFromSuggestionsList(n){if(this._currentLeftPaneSuggestions){const t=this._currentLeftPaneSuggestions.topResults,i=this._currentLeftPaneSuggestions.groups;for(let i=0;i<t.length;++i)if(t[i].instItem==n)return{IsInTopResult:!0,GroupType:undefined,PositionInGroup:i};for(let t of i)for(let i=0;i<t.suggestions.length;++i)if(t.suggestions[i].instItem==n)return{IsInTopResult:undefined,GroupType:t.typeWithSource.type,PositionInGroup:i}}return undefined}updateSuggestionsList(n,t){this._currentLeftPaneSuggestions={topResults:n,groups:t}}logDataSourcePerformancesMeasure(n){let t=n.RequestBegin,i=Object.keys(n.ResponseReceived).map(i=>({Name:i,ResponseReceivedTime:n.ResponseReceived[i]-t,RenderedTime:n.RenderFinished[i]-t,Status:n.DataSourcesState&&n.DataSourcesState[i]})),r=n.TopResultRendered.map(n=>({Type:n.T,Time:n.V-t})),u={DataSources:i,TopResultRendered:r};this.logAggregate("DataSourcePerformancesMeasure",u)}logNewKeystrokeMeasure(t,i,r){this.onNewKeystroke(t,i,r.isSearchHomeZI);let u={ScopeInQuery:r.scopePrefix,Scope:r.scope,IsSearchHome:r.isSearchHomeZI};u.CIVersion=n.ConstraintIndex.currentCIVersion;this.logAggregate("NewKeystrokeMeasure",u)}logTopResultsRenderedMeasure(n,t){const i=this._instrumentationProvider.getWebView2Info();this._instrumentationProvider.logProfilerMarker(1,0,"topResultRendered",n,"IsWebView2:"+(i.isWebView2?1:0)+",WebView2Version:"+i.webView2Version);let r={SuggestionTypes:t};this.logAggregate("TopResultsRenderedMeasure",r)}logGroupsRenderedMeasure(n){let t={GroupTypes:n};this.logAggregate("GroupsRenderedMeasure",t)}logPreviewPaneOpenedMeasure(t,i,r){const u=this._instrumentationProvider.getWebView2Info();this._instrumentationProvider.logProfilerMarker(1,0,"previewPaneOpened",this._currentRawClientImpressionGuid,n.getPreviewPaneTypeAsString(i)+",IsWebView2:"+(u.isWebView2?1:0)+",WebView2Version:"+u.webView2Version);let f={ParentType:t.getQsCode(),PreviewPaneType:i,ParentLayoutInfo:this.getItemLayoutFromSuggestionsList(t),AutoOpened:r||undefined};this.logAggregate("LastPreviewPaneOpened",f)}logConversationStartMeasure(n){const t=this._instrumentationProvider.getWebView2Info();this.logSingleMeasure("ConversationStartMeasure",n,"IsWebView2:"+(t.isWebView2?1:0)+",WebView2Version:"+t.webView2Version)}logItemClickedMeasure(n,t,i,r){let u={CVID:n,ItemType:i.getQsCode(),InputType:r,LayoutInfo:this.getItemLayoutFromSuggestionsList(i)};this.flushAggregatedMeasure(!0);this.logSingleMeasure("ItemClickedMeasure",t,u);this.logUserEngagementTelemetry(t,i)}logUserEngagementTelemetry(t,i){var r;n.config.enableUserEngagementLog&&(n.VelocityKeys===null||n.VelocityKeys===void 0?void 0:n.VelocityKeys.isFeatureEnabled(49805431))&&!n.isNullOrUndefined(SearchAppWrapper)&&!n.isNullOrUndefined(SearchAppWrapper===null||SearchAppWrapper===void 0?void 0:SearchAppWrapper.CortanaApp)&&typeof((r=SearchAppWrapper===null||SearchAppWrapper===void 0?void 0:SearchAppWrapper.CortanaApp)===null||r===void 0?void 0:r.logCriticalUserEngagementTelemetry)=="function"&&n.safeExecute(()=>{var n;let r=i.getUserEngagementContent();(n=SearchAppWrapper===null||SearchAppWrapper===void 0?void 0:SearchAppWrapper.CortanaApp)===null||n===void 0?void 0:n.logCriticalUserEngagementTelemetry(JSON.stringify(r),t)},"logUserEngagementTelemetry")}logItemDwellMeasure(n,t){this.logUserEngagementTelemetry(n,t)}logQFSuggestionsIndexerMatchTypeList(t){var i,r,u;typeof((u=(r=(i=SearchAppWrapper===null||SearchAppWrapper===void 0?void 0:SearchAppWrapper.CortanaApp)===null||i===void 0?void 0:i.queryFormulationView)===null||r===void 0?void 0:r.deviceSearch)===null||u===void 0?void 0:u.onDeviceItemsDisplayed)=="function"&&n.safeExecute(()=>{var n,i,r;(r=(i=(n=SearchAppWrapper===null||SearchAppWrapper===void 0?void 0:SearchAppWrapper.CortanaApp)===null||n===void 0?void 0:n.queryFormulationView)===null||i===void 0?void 0:i.deviceSearch)===null||r===void 0?void 0:r.onDeviceItemsDisplayed(t)},"logQFSuggestionsIndexerMatchTypeList")}logPreviewPaneItemClickMeasure(t,i){n.safeExecute(()=>{if(t.vbt&&!n.isNullOrUndefined(i)&&typeof i.onItemAction=="function"){let r=n.JumplistActionItemType[t.vbt];const u="S_";r.startsWith(u)&&(r=r.substring(u.length));r==="Open"&&(r="Launch");i.onItemAction(r)}},"logPreviewPaneItemClickMeasure")}logPreviewPaneDwellMeasure(t){n.safeExecute(()=>{let n=t===null||t===void 0?void 0:t.deviceItem;typeof(n===null||n===void 0?void 0:n.onItemAction)=="function"&&(n===null||n===void 0?void 0:n.onItemAction("Dwell"))},"logPreviewPaneDwellMeasure")}logFlightState(n,t){this.logSingleMeasure("BingExpFlight",this._currentRawClientImpressionGuid,`FX:${t?1:0}${n}`)}}n.WindowsTelemetry=t}(WSB||(WSB={})),function(n){const t=/[+.\\*?\[\]()]/g,i={".":"\\.","+":"\\+","*":"\\*","\\":"\\\\","?":"\\?","[":"\\[","]":"\\]","(":"\\(",")":"\\)"},r=/^(?:https?:\/\/)?(.*)/,u=/^(?:(?:https?:\/\/(?:www\.)?)|(?:www\.))(.*)/,f=/^\s+/;class e{constructor(){n.Host.bindKeyDown(t=>{n.isUpOrDownKey(t)&&this.reset()});n.Host.bindQueryChangedOrInitialized(n=>{this._currentQuery=n,!this._fullAutoCompletedQuery||this._fullAutoCompletedQuery.startsWith(n.originalQuery)||n.originalQuery.startsWith(this._fullAutoCompletedQuery)||this.reset()})}apply(t){if(t.query!=this._autoCompletedQuery){let i=this._currentQuery.originalQuery;if(n.Host.setAutoCompleteQueryText(""),this._currentQuery.originalCursorPosition===i.length){let u=this._currentQuery.scopePrefix?this._currentQuery.scopePrefix.length+1:0,n=i.substr(u).replace(f,"").toLowerCase(),r=t.query.toLowerCase();if(n!==r){let f=1,u=this.fullAutoCompleteOffset(r,n);if(u<0&&t.url&&(u=this.infixAutoCompleteOffset(r,n),f=2),u<0&&(u=this.directNavAutoCompleteOffset(r,n)),u>=0){this.setAutoCompletedQuery(i,t.query,u);t.autoCompleteType=f;return}}}this._autoCompletedQuery&&(this.reset(),n.Host.setAutoCompleteQueryText(i))}}reset(){this._autoCompletedQuery=null;this._fullAutoCompletedQuery=null}fullAutoCompleteOffset(n,t){let i=n.startsWith(t);return i?t.length:-1}infixAutoCompleteOffset(n,u){let f=n.search("[ .:,\\\\/+_&-]"+u.replace(t,n=>i[n]));if(f>0){let t=n.substring(0,f+1).match(r)[1],i=t?t.match(/[ .:,\\/+_&-]+/g).length+1:1;if(i<3)return f+1+u.length}return-1}directNavAutoCompleteOffset(n,t){let i=t.match(u);if(i){let t=i[1];if(t.length>0&&n.startsWith(i[1]))return t.length}return-1}setAutoCompletedQuery(t,i,r){let u=t+i.slice(r);n.Host.setAutoCompleteQueryText(u);this._autoCompletedQuery=i;this._fullAutoCompletedQuery=u}}n.WSBAutoComplete=e}(WSB||(WSB={})),function(n){var t;(function(t){function i(n,t){return!n.suppressed&&n.handoffType==0&&!n.htmlContent&&n.query.toLocaleLowerCase()==t.queryToFetch.toLocaleLowerCase()}function f(n){return n.length>=2&&n[0].type=="MB"&&n[1].type=="MB"}function e(t){var i,r;return t.length>=2&&(n.isStore((i=t[0])===null||i===void 0?void 0:i.type)||n.isStore((r=t[1])===null||r===void 0?void 0:r.type))}let r;(function(n){n[n.NotDuplicate=0]="NotDuplicate";n[n.NoMetadata=1]="NoMetadata";n[n.MergeMetadata=2]="MergeMetadata"})(r||(r={}));const u={"{1AC14E77-02E7-4E5D-B744-2EB1AE5198B7}\\cmd.exe":{appToPromote:"Microsoft.WindowsTerminal_8wekyb3d8bbwe!App",enabled:n.config.promoteTerminalOverCmd},"Microsoft.Windows.MediaPlayer32":{appToPromote:"Microsoft.ZuneMusic_8wekyb3d8bbwe!Microsoft.ZuneMusic",enabled:n.config.demoteWindowsMediaPlayer}};t.isWebSuggestionForPrefix=i;t.topHitIsMultiEntity=f;t.topHitHasStoreApp=e;class o{constructor(n,t,i,r,u,f,e){this._navigationHelper=n;this._previousKeystrokeCache=t;this._ranker=i;this._renderedTopResults=r;this._previewPane=u;this._upsellViewModel=f;this._copilotViewModel=e}launchWebSearch(t,i,r,u,f){let e=t.queryToFetch;n.Host.launchSearchAsync(e,this._navigationHelper.getSearchUrl(t.fullPartialQuery,e,r,null,u,undefined,undefined,undefined,undefined,f),i,r)}getProtocol(t,i){let u="PWL",r=n.InstrumentationHelper.getInstrumentedSyntheticSuggestion(i,u);if(r)return r;r=n.createSuggestion(t,null,n.Host.getEdgeIcon,null,u,null,n.InstrumentedItem.getNonSuggestionInstrumentedItem(u,n.SyntheticQSCodesMaps.KValues),1,i,!1,"tp",()=>n.Host.launchUrlWithHttpProtocolAsync(r.url,{medium:"MSBLink"}));r.notAResult=!0;let f=t=>{let i=n.prettyPrintUrl(t.fixedUrl,t.queryToFetch,!0);r.url=t.fixedUrl;r.tooltip=t.fixedUrl;r.query=i;r.text=HitHighlightingParser.addMarkers(i);r.narratorText=n.getNarratorText(r,n.Host.getLocString("DirectNavSuggestion"));r.reactKey=u+t.fixedUrl};return f(t),r.updateFromQuery=n=>n.isProtocol?(f(n),!0):!1,n.InstrumentationHelper.instrumentSyntheticSuggestion(i,r),r}getWebSearch(t,i,r,u,f,e){let o=n.contains([13,14],f);return n.getSyntheticSuggestion(t,i,r,u,f,e,o,(n,t)=>this.launchWebSearch(t,n.useRaf,r,f,n.msbVerticalHash))}getExplorerSearch(t,i){let r=n.getSyntheticSuggestion(t,i,"SDFE",{content:"&#xEC50",type:1},2,n.Host.getLocString("SearchInFileExplorer"),!0,(t,i)=>n.Host.launchSearchInFileExplorer(i.queryToFetch));return n.shouldSetThisPcGroupSource(n.GroupType.Documents,t)&&(r.sourceForGroup=1),r}getOutlookWebAccessSearch(t,i){let r=n.AccessTokenManager.getWindowsAccountType()==1;return n.getSyntheticSuggestion(t,i,"OWA",{content:"&#xE715",type:2},r?8:12,n.Host.getLocString("SearchInOutlookWeb"),!0,()=>{r?n.Host.launchUrlWithHttpProtocolAsync("https://outlook.office.com/owa",{medium:"MSBLink"}):n.Host.launchUrlWithEdgeProtocolAsync("https://outlook.live.com/owa",{medium:"MSBLink"})})}getStoreSearch(t,i){return n.getSyntheticSuggestion(t,i,"STS",{content:"&#xEA96",type:2},3,n.Host.getLocString("SearchForAppsInTheStore"),!0,(t,i)=>n.Host.launchStoreSearchAsync(i.queryToFetch))}getRecourse(t,i){var r;if(!t.queryToFetch||t.taskFrame)return null;switch(n.getEffectiveScope(t)){case n.Scope.Apps:return n.isBingEnabled()&&((r=SearchAppWrapper.CortanaApp.isStoreAppEnabled)!==null&&r!==void 0?r:!0)?this.getStoreSearch(t,i):null;case n.Scope.Documents:return this.getExplorerSearch(t,i);case n.Scope.Emails:return n.ScopeConfig[n.Scope.Emails].showUpsellOnSuggestionsList()?null:this.getOutlookWebAccessSearch(t,i);case n.Scope.Photos:return n.isWebResultsDisabled()?null:this.getWebSearch(t,i,"SBI",{content:"&#xEB9F",type:2},13,n.Host.getLocString("SearchForWebImages"));case n.Scope.Videos:return n.isWebResultsDisabled()?null:this.getWebSearch(t,i,"SBV",{content:"&#xE714",type:1},14,n.Host.getLocString("SearchForWebVideos"));default:return null}}getSyntheticSuggestions(t,i,r){var u,o;const l=n.getScopeConfig(t),a=l.webSyntheticEnabled&&l.webSyntheticEnabled(t),f=0,e="SW";n.canShowCopilotQF()?(r&&r.QIC&&(o=r.QIC.rankerExtraInfo.confidence),o&&o[0]==n.QueryIntentClassification.Conversation?u=this._copilotViewModel.getCopilotSuggestion():a&&(u=this.getWebSearch(t,i,e,n.getSearchSuggestionIcon(),f,n.getWebSuggestionAnnotation(n.msbEnabledForQuery(t))))):a&&(n.shouldQFSuggToBingChat(f,t.originalQuery,"SW")?(u=n.getSyntheticSuggestion(t,i,e,undefined,f,n.getWebSuggestionAnnotation(),!1,(t,i)=>n.Host.launchSearchAsync(i.queryToFetch,this._navigationHelper.getSearchUrl(i.fullPartialQuery,i.queryToFetch,e,n.replaceSearchWithChatPath(n.appendBingChatParams(`/search?q=${n.encodeQueryParameter(i.queryToFetch)}`)),f,"WSBQFC"),t===null||t===void 0?void 0:t.useRaf,"WSBQFC")),n.setSearchSuggestionChatIcon(u),n.getGroupType(u)===n.GroupType.ChatWithBing&&(u.primaryMetadata=n.Host.getLocString("CodexChatButtonUpperRight"))):u=this.getWebSearch(t,i,e,n.getSearchSuggestionIcon(),f,n.getWebSuggestionAnnotation(n.msbEnabledForQuery(t))));let v;v=n.isThirdPartySearchAllowed()?null:t.isProtocol&&n.RuntimeConfig.AllowProtocolSyntheticSuggestions?this.getProtocol(t,i):null;const s=this.getRecourse(t,i);s&&(s.rankingScore=-Number.MAX_VALUE);const h=[];t.scope==n.Scope.All&&t.isSearchHomeZI&&n.msbHost&&n.msbHost.qfUtils.isDocumentZeroQueryEnabled()&&n.msbHost.features.isQwsEnabled()&&n.isMsbEnterprise()&&!n.msbHost.isGccHighTenant()&&h.push(n.msbHost.qfUtils.getOnRampButtonSuggestion(t,i));this._upsellViewModel&&h.push(this._upsellViewModel.getUpsellSyntheticSuggestion(t,i));let c=[];if(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isWorkScopeApplicable()){c=n.msbHost.verticalManager.getSyntheticSuggestions(t,i);for(const n of c)if(n&&(n.click=()=>this.launchWebSearch(t,n.useRaf,n.type,n.handoffType,n.msbVerticalHash),n.childSuggestions!=undefined))for(const i of n.childSuggestions)i.click=()=>this.launchWebSearch(t,i.useRaf,i.type,i.handoffType,i.msbVerticalHash)}return{protocol:v,searchTheWeb:u,recourse:s,msbVerticals:c,others:h.filter(n=>!!n)}}canHaveDuplicates(t,i){switch(t){case"Web":case"MRU":case"MWS":case"RWQ":case"OSTMA":case"OSTMAN":case"MSBC":case"QS":case"PP":case"IBA":case"LRA":case"ST":case"FL":case"LM":case"IFF":case"CG":case"PT":case"MPP":case"MST":case"MFF":case"MRS":case"MPVD":case"MDOC":case"MFOL":case"MPHO":case"MVID":case"MMUS":case"SSUE":case"SSUC":case"ANA":case"QWQS":case"CoPIFF":case"CoPCFP":case"CoPST":case"TPWeb":case"SWMF":return!0;case"SMA":case"FEH":case"TOPP":case"QSCH":case"TS":case"AIF":case"DFLS":case"CUSE":case"SREE":case"SAPP":return!1;case"SSEE":return i.scope==n.Scope.Documents||i.scope==n.Scope.Emails||n.RuntimeConfig.QfMode==5;case"SSEC":return i.scope==n.Scope.Emails;case"RSH":return!1}throw new Error("New data source "+t+" needs to be explicity classified as needed deduping with other data sources or not");}canHaveDuplicatesWithinDataSource(t,i){switch(t){case"MPP":case"MST":case"MRU":case"ST":case"MSBC":case"MWS":case"TPWeb":return!0;case"SSEE":case"SSEC":return i.scope==n.Scope.Emails}return n.supportsShortcuts(t,i)}mergeDuplicates(t,i,u){let f=n.isDuplicate(t,i,u);return f?(i.type==="MFIL"||u.type==="MFIL")&&n.config.msbReplaceDupLocalFiles&&u.type==="MFIL"?!0:(f==r.MergeMetadata&&n.enrichMetadataFromDuplicate(t,i,u),n.Host.getJupiterProviderEnabled()&&f==r.NoMetadata&&n.checkAndEnrichMetaForSettingSuggestions(i,u))?!0:(i.duplicates=i.duplicates||[],n.contains(i.duplicates,u)||(i.duplicates.push(u),i.needsRefreshAfterDeduping=!0,i.previewPaneNeedsRefreshAfterDeduping=f==r.MergeMetadata),!0):!1}shuffle(n,t){let i=n.length,r=0;while(i!==0)r=Math.floor(t()*i),i--,[n[i],n[r]]=[n[r],n[i]];return n}rank(t,r,u,f,e,o,s){var b,k;const it=n.isL2(f);it&&(s=!1);let y=u.Web,d=y?y.rankingSignals:null,st=y?y.webTopResultRoutingType:1,p=u.MRU,rt=null,v=null,ut=null;d&&(d.WebSignalsAvailable=!0,rt=y.engagementSignals,v=y.suppressedGroups);this._previousKeystrokeCache&&(ut=this._previousKeystrokeCache.getPreviousEventWebSignalsData(f.queryToFetch));let ht=p?p.SuggestionEngagementData:null,ct=p?p.LookupCompletions:null,lt={cvid:n.Host.getConversationId(),privacyNumber:n.Host.getPrivacyNumber()},a=this.getSyntheticSuggestions(f,o,u);if(f.scope!=n.Scope.Web&&n.config.enableSearchTheWebMaxSuggestions){let i=[n.GroupType.SearchSuggestions,n.GroupType.FromYourHistory,n.GroupType.Websites];n.limitWebSuggestions(f,t,r,i,["ANAH","ANAR","ANATH"])}n.config.enableWinStoreAppPreview&&(n.dedupStoreAppsSuggestion(r,t),n.dedupStoreAppsSuggestion(t,r));r=r.slice();v&&(v.fullySuppressedGroups&&v.fullySuppressedGroups.length>0&&(this.removePromotedFSUPGroups(r,v.fullySuppressedGroups),r=r.filter(t=>!n.contains(v.fullySuppressedGroups,String(this.getGroupTypeForSuppressions(t)))||t.type==="SAPP")),v.suppressedSuggestions&&v.suppressedSuggestions.length>0&&(r=r.filter(t=>!n.contains(v.suppressedSuggestions,n.getSuggestionKey(t))||t.type==="SAPP")));t.length==0&&(a.others.length>0&&r.unshift(...a.others),a.protocol&&r.unshift(a.protocol),((b=a.msbVerticals)===null||b===void 0?void 0:b.length)>0&&(a.msbVerticals[0].isQfWorkSuggestionMode=r.length>=1,r.push(...a.msbVerticals)));this.ensureUniqueReactKeys(r);let g=e.length==1&&e[0].childSuggestions&&e[0].childSuggestions.some(n=>n.displayed),ft=this.getSuggestionsToRank(g,t,r,a,o);n.config.bypassRankerOnNoNewSuggestions&&r&&r.length&&(f.hasNewSuggestions=!0);let w=this._ranker.rank(f,ft,d,ht,ct,rt,lt,ut,a);this._previousKeystrokeCache&&!s&&this._previousKeystrokeCache.updateSpellerTriggerData(f.queryToFetch,ft);t.length==0&&a.recourse&&r.push(a.recourse);let c=this.determineTopResults(e,r,w,a,f,o,g);if(n.config.enableWebSynonymScoreTopHit&&((f===null||f===void 0?void 0:f.scope)==n.Scope.All||(f===null||f===void 0?void 0:f.scope)==n.Scope.Apps)){let n=(k=t.find(n=>Math.abs(n.prefetchConfidenceScore-1e4)<Number.MIN_VALUE))!==null&&k!==void 0?k:t.find(n=>{var t;if((t=n.duplicates)!==null&&t!==void 0)return t.some(n=>Math.abs(n.prefetchConfidenceScore-1e4)<Number.MIN_VALUE)});n&&(c.length==0?c.push(n):c[0]!==n&&(c[1]=c[0],c[0]=n))}let nt=t.filter(t=>!n.contains(e,t)),l=this.determineSuggestionsToAddToGroups(it,nt,r,e,c,a,f,g,s);if(n.config.enableMruProviderInQF&&n.config.useRankerRankScore&&(n.AccessTokenManager===null||n.AccessTokenManager===void 0?void 0:n.AccessTokenManager.getWindowsAccountType())===3){let t=l.filter(n=>(n===null||n===void 0?void 0:n.subType)==="MRUHS");t.sort((n,t)=>t.rankingScore-n.rankingScore);t=t.slice(0,2);l=l.filter(i=>(i===null||i===void 0?void 0:i.subType)!=="MRUHS"||n.contains(t,i))}if(!n.RuntimeConfig.FlatListWithoutGroups&&w.mruSuppressions&&w.mruSuppressions.backPropDataExists)this.applyMRUSuppressions(w,e,c,l,f);else if(v&&v.partiallySuppressedGroups&&this.canPartiallySuppressGroups(c,l,f))for(let t of l)if(!i(t,f)){let i=this.getGroupTypeForSuppressions(t);if(this.canBePartiallySuppressed(t,i)&&n.contains(v.partiallySuppressedGroups,String(i))&&!n.contains(e,t)){if(t.sequenceNumber<n.config.minSequenceForPSUP)continue;t.suppressed=!0}}if(n.config.enableQFChatWithBingSuggestions){let i=[],t=[];for(let r of l)if(r&&(n.getGroupType(r)===n.GroupType.SearchSuggestions||n.config.enableFromYourHistory&&n.getGroupType(r)===n.GroupType.FromYourHistory)&&r.type!="MB"&&n.shouldQFSuggToBingChat(r.handoffType,r.query,r.type)){let u=n.deepCopy(r);u.staticGroupType=n.GroupType.ChatWithBing;u.primaryMetadata=n.Host.getLocString("AskCopilot");u.instItem=n.InstrumentedItem.createInstrumentedItem(o,r.type);i.push(u);n.config.enableQFChatdupSuggestion&&(r.id+="_dup",r.icon=n.getSearchSuggestionIcon(),r.handoffType=0,r.click=()=>n.Host.launchSearchAsync(r.query,this._navigationHelper.getSearchUrl(r.query,r.query,"SW",null,0,undefined,undefined,undefined,undefined),r===null||r===void 0?void 0:r.useRaf),r.reactKey+="dup",t.push(r))}else t.push(r);n.InstrumentationHelper.instrumentDataSource(o,"Web",i,null);t=t.concat(i);l=t.slice()}let tt=[];this.removeProtocolIfDuplicate(f,a,c,nt,l,tt);this.setUseRafFlag(c,l,f,st);let h=this.getGroupOrder(f,l,nt);if(f.staticGroupOrder){let n=[];for(let t of f.staticGroupOrder){let i=h.findIndex(n=>n.type==t);i>=0&&(n.push(h[i]),h.splice(i,1))}n.length>0&&(n.push(...h),h=n)}else if(f.forceGroupOnTop){let i=f.forceGroupOnTop,t=h.findIndex(t=>n.sameGroup(t,i));if(t>=0&&(h.splice(t,1),h.unshift(i)),t=h.findIndex(t=>n.isTopHitChildGroup(t)),t>=0){let n=h[t];h.splice(t,1);h.unshift(n)}}if(n.RuntimeConfig.FlatListWithoutGroups&&(c=c.concat(l.filter(n=>!n.suppressed)),l=[],n.trimList(c,n.RuntimeConfig.MaxSuggestionsWhenFlatList,i=>!n.contains(t,i)&&!i.notAResult),tt.length!=0))throw new Error("Can't remove suggestions from groups when there are no groups");if(n.config.promoteEdgeOverIE&&this.promoteEdgeOverInternetExplorer(l,c),n.config.transitionIEToEdge&&this.transitionInternetExplorerToEdge(c),n.config.enablePartnerPromotions&&this.promotePartnerSuggestions(l,c,f.queryToFetch),n.config.enablePromoteWebSuggestionsGroup&&c.length>0){const t=n.isApp(c[0].type);if(t){let t=h.findIndex(t=>t.type==n.GroupType.SearchSuggestions);if(t!==-1&&t!==0){let n=h.splice(t,1);h.splice(0,0,n[0])}}}if(n.config.enablePromoteWebSuggestionsGroupForAll&&f.scope==n.Scope.All){let t=h.findIndex(t=>t.type==n.GroupType.SearchSuggestions),i=h.findIndex(t=>t.type==n.GroupType.Related);if(i!==-1&&i==0){if(t!==-1&&t!==0){let n=h.splice(t,1);h.splice(1,0,n[0])}}else if(t!==-1&&t!==0){let n=h.splice(t,1);h.splice(0,0,n[0])}}let at=h.slice(0);const et=c.filter(t=>n.isMsbQFSuggestion(t)).length>0,ot=c.filter(t=>n.isWebSuggestion(t)||t.isAnswer).length>0;if(et?h=this.promoteMsbSuggestions(c,h):ot&&(h=this.promoteMsbSuggestionsAboveWeb(h)),(ot||et)&&l.forEach(t=>{if(n.isMsbQFSuggestion(t)){const i=n.getGroupType(t);this.isMsbGroupTypePromoted(i,at,h)&&(t.suppressed=!1)}}),n.config.trendingSearchAboveTiles){let t=h.findIndex(t=>t.type==n.GroupType.TopApps||t.type==n.GroupType.AnaheimDataTile),i=h.findIndex(t=>t.type==n.GroupType.TrendingSearchData);if(t!==-1)if(i!==-1){let r=h.splice(i,1);if(h.splice(t,0,r[0]),n.config.anaheimDataListAboveTiles){let i=h.findIndex(t=>t.type==n.GroupType.AnaheimDataList);if(i!==-1){let n=h.splice(i,1);h.splice(t+1,0,n[0])}}}else if(n.config.anaheimDataListAboveTiles){let i=h.findIndex(t=>t.type==n.GroupType.AnaheimDataList);if(i!==-1){let n=h.splice(i,1);h.splice(t,0,n[0])}}}else if(n.config.anaheimDataListAboveTiles){let t=h.findIndex(t=>t.type==n.GroupType.TopApps||t.type==n.GroupType.AnaheimDataTile),i=h.findIndex(t=>t.type==n.GroupType.AnaheimDataList);if(t!==-1&&i!==-1){let n=h.splice(i,1);h.splice(t,0,n[0])}}if(n.config.trendingSearchInWin11LeftPane){const i=h.findIndex(t=>t.type===n.GroupType.MRUHistory),t=h.findIndex(t=>t.type===n.GroupType.TrendingSearchData);i==-1&&t>-1&&(h.splice(t,1),l=l.filter(n=>n.type!=="TS"))}if(n.config.enableFromYourHistory&&(h=this.promoteTargetGroupBeforeSourceGroup(n.GroupType.FromYourHistory,n.GroupType.SearchSuggestions,h)),n.config.wsbEnableRandomization){let t=n.getRNG(n.Host.getConversationId());(n.config.wsbRandomizationProbability==1||t()<n.config.wsbRandomizationProbability)&&this.shuffle(h,t)}return{topResults:c,suggestionsToAdd:l,suggestionsToRemove:tt,groupOrder:h}}isMsbGroupTypePromoted(t,i,r){let u=-1,f=-1;return t===n.GroupType.Documents?(u=i.findIndex(n=>this.isMsbFileGroupType(n)),f=r.findIndex(n=>this.isMsbFileGroupType(n))):(u=i.findIndex(n=>n.type===t),f=r.findIndex(n=>n.type===t)),f<u}promoteMsbSuggestionsAboveWeb(t){const f=t.filter(t=>t.type==n.GroupType.SearchSuggestions);if(f.length==0)return t;let r=t.filter(n=>this.isMsbGroupTypes(n));if(r.length==0)return t;t=t.filter(n=>!this.isMsbGroupTypes(n));const u=t.findIndex(t=>t.type==n.GroupType.SearchSuggestions);let i=t.slice(0,u);i.push(...r);const e=t.slice(u);return i.push(...e),i}promoteTargetGroupBeforeSourceGroup(n,t,i){let u=i.filter(t=>t.type==n);if(u.length==0)return i;const e=i.filter(n=>n.type==t);if(e.length==0)return i;i=i.filter(t=>t.type!=n);const f=i.findIndex(n=>n.type==t);let r=i.slice(0,f);r.push(...u);const o=i.slice(f);return r.push(...o),r}isArithmeticExpression(n){return/^[\+\-]?((\d*\.\d+|\d+)\s*[\+\-\*\/\^]\s*)+((\d*\.\d+|\d+)\s*)$/.test(n)}promoteMsbSuggestions(t,i){let r=i.filter(n=>this.isMsbGroupTypes(n));const u=r.filter(t=>t.type===n.GroupType.Bookmarks);u.length>0&&(r=r.filter(t=>t.type!==n.GroupType.Bookmarks),r.unshift(...u));const f=t.filter(t=>n.isMsbQFSuggestion(t)&&(t.type==="MPPL"||t.type==="MFIL")).length>0;if(f){const n=r.filter(n=>this.isMsbFileGroupType(n));n.length>0&&(r=r.filter(n=>!this.isMsbFileGroupType(n)),r.unshift(...n))}return r.length>0&&(i=i.filter(n=>!this.isMsbGroupTypes(n)),i.unshift(...r)),i}removePromotedFSUPGroups(t,i){for(let r in n.config.disableFSUPPartnerAppIds){let u=t[t.findIndex(n=>n.deviceItem&&n.deviceItem.id==r)];if(u){let t=this.getGroupTypeForSuppressions(u).toString();n.contains(i,t)&&n.tryRemove(i,t)}}}transitionInternetExplorerToEdge(t){var r;let i=(r=n.Host.getQuery().originalQuery)===null||r===void 0?void 0:r.toLowerCase();if(i==="ie"||(i===null||i===void 0?void 0:i.startsWith("internet e"))){let i=t.findIndex(t=>t.deviceItem&&n.contains(n.AnaheimAppIds,t.deviceItem.id));if(i>=0){t[i].primaryMetadata=n.Host.getLocString("EdgeToIEUpsell");t[i].classNames.twoLineMax||t[i].classNames.push("twoLineMax");let r="&ciaid=actpermedge&source=windowsSearch";t[i].click=n.config.useCobaltCSS?()=>n.Host.launchUrlWithEdgeProtocolAsync("https://go.microsoft.com/fwlink/?linkid=2181241"+r,{medium:"MSBLink"}):()=>n.Host.launchUrlWithEdgeProtocolAsync("https://go.microsoft.com/fwlink/?linkid=2181242"+r,{medium:"MSBLink"})}}}promoteEdgeOverInternetExplorer(t,i){let r=i.findIndex(t=>t.deviceItem&&t.deviceItem.id==n.InternetExplorerId),u=t.findIndex(t=>t.deviceItem&&n.contains(n.AnaheimAppIds,t.deviceItem.id));r>=0&&u>=0&&(i.unshift(t.splice(u,1)[0]),t.unshift(i.splice(r+1,1)[0]))}promotePartnerSuggestions(n,t,i){for(let r in u)if(u[r].enabled){let e=t.findIndex(n=>n.deviceItem&&n.deviceItem.id==r),f=n.findIndex(n=>n.deviceItem&&n.deviceItem.id==u[r].appToPromote);e>=0&&f>=0&&n[f].query.toLocaleLowerCase().includes(i)&&(t.unshift(n.splice(f,1)[0]),n.unshift(t.splice(e+1,1)[0]))}}applyMRUSuppressions(t,r,u,f,e){if(this.canPartiallySuppressGroups(u,f,e)){const o=3.34728026,s=3.523466,h=3.72204852,c=.5865976,l=1.37432766,a=-1.75450325;let u={};for(let v of f)if(!i(v,e)){let i=n.getGroupType(v);if(this.canBePartiallySuppressed(v,i)){if(!u[i]){let r=t.mruSuppressions.maxGroupCCR?t.mruSuppressions.maxGroupCCR[i]||0:0,f=t.mruSuppressions.maxGroupProbSugClickGivenPref?t.mruSuppressions.maxGroupProbSugClickGivenPref[i]||0:0,e=t.mruSuppressions.mruGroupRatios?t.mruSuppressions.mruGroupRatios[i]||0:0,v=t.mruSuppressions.mruGroupBackpropRatios?t.mruSuppressions.mruGroupBackpropRatios[i]||0:0,y=t.mruSuppressions.mruGroupBackpropWeights?t.mruSuppressions.mruGroupBackpropWeights[i]||0:0,p=o*r+s*f+h*e+c*v+l*y+a,w=1/(1+Math.exp(-p));u[i]=n.trimFeatureStoreValue(w)}v.mruSuppressionScore=u[i];let f=this.getGroupSuppressionCutOff(v);if(v.mruSuppressionScore<f&&!n.contains(r,v)){if(n.config.forceCoPilotPoweredResultsVisible&&(n.isDocument(v.type)||n.isPhoto(v.type)||n.isFolder(v.type)))continue;if(n.Host.getJupiterProviderEnabled()&&n.Host.getForceCoPSTResultRenderingEnabled()&&n.isSetting(v.type))continue;v.suppressed=!0}}}}}getGroupSuppressionCutOff(t){return n.config.msbUseSuppressionsThreshold&&n.isMsbQFSuggestion(t)?n.config.msbSuppressionsThreshold:n.config.lRModelCutOff}isMsbFileGroupType(t){return t.type===n.GroupType.Documents&&t.source===7?!0:!1}isMsbGroupTypes(t){return t.type===n.GroupType.People||t.type===n.GroupType.Bookmarks?!0:this.isMsbFileGroupType(t)?!0:!1}allowedInGroups(n){return n.isAnswer?n.allowedInGroups:!0}getGroupTypeForSuppressions(t){let i=n.getGroupType(t);return i==n.GroupType.LocalPlaces?n.GroupType.SearchSuggestions:i}canBePartiallySuppressed(t,i){return n.getScope(i)!=n.Scope.All}canPartiallySuppressGroups(t,i,r){return n.config.noGroupSuppressions&&!n.isThirdPartySearchAllowed()?!1:t.every(n=>!n.query.toLocaleLowerCase().includes(r.queryToFetch))?!1:n.RuntimeConfig.ScopesAvailable?t.every(t=>n.getGroupType(t)==n.GroupType.SearchSuggestions)&&i.every(t=>n.getGroupType(t)==n.GroupType.SearchSuggestions)?!1:!0:!1}isProtocolDuplicate(t,i,r){return t==r?!1:t.type=="MD"?!0:t.handoffType==1&&n.isDuplicateUrl(i,t.url,r.url)}removeProtocolIfDuplicate(t,i,r,u,f,e){if(i.protocol){let o=n=>!n.suppressed&&this.isProtocolDuplicate(n,t,i.protocol);if(r.some(o)||u.some(o)||f.some(o)){if(n.tryRemove(r,i.protocol)){if(!r.length){let t=n.removeFirstWhere(u,o)||n.removeFirstWhere(f,o);r.push(t)}}else n.tryRemove(f,i.protocol)||n.contains(u,i.protocol)&&e.push(i.protocol);i.protocol=null}}}getSuggestionsToRank(t,i,r,u){t&&(i=i.filter(t=>!n.isChildSuggestion(t)));u.recourse&&(i=i.filter(n=>n!=u.recourse));let f=i.concat(r);return u.searchTheWeb&&!n.contains(i,u.searchTheWeb)&&f.push(u.searchTheWeb),n.config.topHitMuse&&f.forEach(n=>{var t,i,r,u;return n.tooltip="Rank:"+((t=n.rankingScore)===null||t===void 0?void 0:t.toString())+" launch:"+((i=n.anaheimRankingSignals)===null||i===void 0?void 0:i.visitCount)+" DateV:"+((u=(r=n.anaheimRankingSignals)===null||r===void 0?void 0:r.dateVisited)===null||u===void 0?void 0:u.toString())}),f}determineTopResults(t,r,u,o,s,h,c){var y,p,w,b,k,d,g,nt,tt,it,a;if(n.config.wsbEnableRandomization){let t=n.getRNG(n.Host.getConversationId());if(n.config.wsbRandomizationProbability==1||t()<n.config.wsbRandomizationProbability)return[]}if(c||!s.queryToFetch)return t;if(n.RuntimeConfig.QfMode!=5&&(s===null||s===void 0?void 0:s.scope)==n.Scope.All&&!n.isNullOrUndefined(o===null||o===void 0?void 0:o.searchTheWeb)&&this.isArithmeticExpression(s.queryToFetch)){let n=r.find(n=>(n===null||n===void 0?void 0:n.query)===o.searchTheWeb.query&&n.type!="SW");if(n=n?n:Object.assign({},o.searchTheWeb),n.query+="=",t.length==0)return t[0]=n,t;if(!t[0].isAnswer&&t[0].query!=n.query)return t[1]=t[0],t[0]=n,i(t[1],s)&&t.splice(0,1),t}if(n.config.stickyTopResultsV2&&t.length>1&&!n.isL2(s))if((n.config.enableBoostWebAnswer||n.config.enableBoostSWAnswer)&&s.scope==n.Scope.All){if(!(t.length==2&&(n.isApp(t[0].type)||n.isSetting(t[0].type)||n.isFileOrFolder(t[0].type))&&(t[1]==o.searchTheWeb||n.isWebSuggestion(t[1])||t[1].type=="MB")))return t}else if(n.config.enablePutASInSecondTopHit&&s.scope==n.Scope.All){if(!(t.length==2&&(t[1]==o.searchTheWeb||n.isWebSuggestion(t[1])||t[1].type=="MB")))return t}else if(n.config.promoteAS2SecondTopWhenTopHitIsFLorFD&&s.scope==n.Scope.All){if(!(t.length==2&&n.isFileOrFolder(t[0].type)&&(t[1]==o.searchTheWeb||n.isWebSuggestion(t[1])||t[1].type=="MB")))return t}else return t;if(s.inorganic&&s.queryToFetch){if(t.length>0)return t;if(((y=o.searchTheWeb)===null||y===void 0?void 0:y.query)===s.queryToFetch)return t.push(o.searchTheWeb),t}let l=u.topResults;if((n.config.enableWinStoreAppPreview||n.config.enableWinStoreAppDataProvider)&&s.queryToFetch.length>=n.config.minPrefixLengthForSpp&&!n.config.disableSPPPromoteChange)if(n.isL2(s)){if(l.length==0&&(s===null||s===void 0?void 0:s.scope)==n.Scope.Apps)for(let t=0;t<r.length;t++)if(n.isStore((tt=r[t])===null||tt===void 0?void 0:tt.type)){l.push(r[t]);break}}else{if(l.length==1){if(n.isWebRelatedSuggestion(l[0])){for(let t=0;t<r.length;t++)if(n.isStore((p=r[t])===null||p===void 0?void 0:p.type)){l.unshift(r[t]);break}}else if(!n.isStore((w=l[0])===null||w===void 0?void 0:w.type)){let t=n.config.disableChangeWhenTopIsApp&&n.isApp(l[0].type),i=n.config.disableChangeWhenTopIsAppOrSetting&&(n.isApp(l[0].type)||n.isSetting(l[0].type)),u=t||i||n.config.disableChangeWhenTopIsNotWeb;if(!u)for(let t=0;t<r.length;t++)if(n.isStore((b=r[t])===null||b===void 0?void 0:b.type)){l.push(r[t]);break}}}else if(l.length==2)if(n.isWebRelatedSuggestion(l[0])){if(n.isStore((k=l[1])===null||k===void 0?void 0:k.type)){for(let t=0;t<r.length;t++)if(n.isStore((g=r[t])===null||g===void 0?void 0:g.type)){l[0]=l[1];l[1]=r[t];break}}else for(let t=0;t<r.length;t++)if(n.isStore((d=r[t])===null||d===void 0?void 0:d.type)){l[1]=l[0];l[0]=r[t];break}}else if(n.isWebRelatedSuggestion(l[1])){let t=n.config.disableChangeWhenTopIsApp&&n.isApp(l[0].type),i=n.config.disableChangeWhenTopIsAppOrSetting&&(n.isApp(l[0].type)||n.isSetting(l[0].type)),u=t||i||n.config.disableChangeWhenTopIsNotWeb;if(!u)for(let t=0;t<r.length;t++)if(n.isStore((nt=r[t])===null||nt===void 0?void 0:nt.type)){l[1]=r[t];break}}if(l.length==2){let t=l.findIndex(n=>n.type==="MB"),i=l.findIndex(t=>n.isStore(t.type));i>=0&&t>=0&&(n.config.enableSPPDisableMB?i==0?l.pop():l.shift():n.config.enableMBDisableSPP&&(t==0?l.pop():l.shift()))}}let rt=this._previewPane?this._previewPane.getPreviewedSuggestionToForceTopHit():null;if(rt&&this._ranker.allowInTopHit(s,rt)){let i=t=>n.isEquivalentForPreviewPanePurposes(s,rt,t),u=l.findIndex(i);if(u!=0){let n;u>0?(n=l[u],l.splice(u,1)):n=t.find(i)||r.find(i)||(o.searchTheWeb?[o.searchTheWeb]:[]).find(i);n&&l.unshift(n)}}if(o.protocol&&o.searchTheWeb&&this._ranker.allowInTopHit(s,o.protocol)&&n.tryRemove(l,o.searchTheWeb),o.searchTheWeb){let n=l.indexOf(o.searchTheWeb);n>=0&&l.some(n=>n!=o.searchTheWeb&&i(n,s))&&l.splice(n,1)}l.length==0&&(n.config.stickyTopResultsV2&&n.config.enableBoostWebAnswer&&s.scope==n.Scope.All&&t.length==2&&(n.isApp(t[0].type)||n.isSetting(t[0].type)||n.isFileOrFolder(t[0].type))&&t[1]==o.searchTheWeb?l.push(t[0]):n.config.stickyTopResultsV2&&t.length>0&&s.scope==n.Scope.All&&t.length==2&&(n.config.enablePutASInSecondTopHit||n.config.promoteAS2SecondTopWhenTopHitIsFLorFD)&&(n.isWebSuggestion(r[1])||r[1].type=="MB"||t[1]==o.searchTheWeb)?l.push(t[0]):n.config.stickyTopResultsV2&&t.length>0?l.push(...t):o.protocol&&this._ranker.allowInTopHit(s,o.protocol)?l.push(o.protocol):o.searchTheWeb&&this._ranker.allowInTopHit(s,o.searchTheWeb)?l.push(o.searchTheWeb):o.recourse&&this._ranker.allowInTopHit(s,o.recourse)&&l.push(o.recourse));let v=n.getEffectiveScope(s)==n.Scope.Emails?n.config.maxNumberOfEmailsInTopResult:Math.max(n.config.maxNumberOfTopResults,f(l)?2:0,e(l)?2:0,t.length);if(n.config.bypassFallbackOnMSBTopHit==4&&l.length>0&&n.isMsbOnlineSuggestionType(l[0].type)&&(v=2),l.length>v&&(l=l.slice(0,v)),n.config.synthWebNoBestMatch&&l.length==1){let t=[n.GroupType.SearchSuggestions,n.GroupType.FromYourHistory,n.GroupType.Websites],i=r.filter(i=>!n.contains(t,n.getGroupType(i))),u=l.filter(i=>!n.contains(t,n.getGroupType(i)));i.length==0&&u.length==0&&(l=[])}for(let i=t.length-1;i>=0;--i){let u=t[i];n.contains(l,u)||(u.useRaf&&(u.useRaf=!1),u!=o.searchTheWeb&&r.unshift(u))}l.length==1&&n.safeExecute(()=>this.applyAppOverride(l,r),"applyDeviceInfoOverride");l.forEach(n=>n.suppressed=!1);let ut=n.isL2(s);if(n.config.stickyTopResultsV2&&l.length==1&&t.length==1&&!ut){let r=l[0],i=t[0];r==i||n.isDefaultSynthetic(i)||n.config.msbDisableStickyWeb&&n.isWebSuggestion(i)&&n.isMsbOnlineSuggestionType(r.type)||l.unshift(i)}else if((n.config.enablePutASInSecondTopHit||n.config.promoteAS2SecondTopWhenTopHitIsFLorFD)&&n.config.stickyTopResultsV2&&l.length==1&&t.length>1&&!ut){let r=l[0],i=t[0];r==i||n.isDefaultSynthetic(i)||n.config.msbDisableStickyWeb&&n.isWebSuggestion(i)&&n.isMsbOnlineSuggestionType(r.type)||l.unshift(i)}if(n.config.enableBoostASTopHitForLowClickType&&s.queryToFetch.length==1&&l.length==1&&!n.isWebSuggestion(l[0])&&!n.isApp(l[0].type))for(let t=0;t<r.length;t++)if(n.isWebSuggestion(r[t])||r[t].type=="MB"){l.splice(0,0,r[t]);break}if(n.config.enableBoostASTopHitForFile&&s.queryToFetch.length==1&&l.length==1&&!n.isWebSuggestion(l[0])&&!n.isApp(l[0].type)&&!n.isSetting(l[0].type))for(let t=0;t<r.length;t++)if(n.isWebSuggestion(r[t])||r[t].type=="MB"){l.splice(0,0,r[t]);break}if(n.config.enableBoostWebAnswer&&s.scope==n.Scope.All&&l.length===1&&(n.isApp(l[0].type)||n.isSetting(l[0].type)||n.isFileOrFolder(l[0].type))&&(!n.config.enableBoostWebAnswerScoreLimit||n.config.enableBoostWebAnswerScoreLimit&&l[0].rankingScore<n.config.boostWebAnswerScoreThreshold))for(let t=0;t<r.length;t++)if(n.isWebSuggestion(r[t])||r[t].type=="MB"){l.push(r[t]);break}if(n.config.enableBoostSWAnswer&&s.scope==n.Scope.All&&l.length===1&&(n.isApp(l[0].type)||n.isSetting(l[0].type)||n.isFileOrFolder(l[0].type))&&(!n.config.enableBoostWebAnswerScoreLimit||n.config.enableBoostWebAnswerScoreLimit&&l[0].rankingScore<n.config.boostWebAnswerScoreThreshold)&&l.length===1&&o.searchTheWeb&&(o.protocol&&this._ranker.allowInTopHit(s,o.protocol)||l.push(o.searchTheWeb)),n.config.enableBoostWebAnswer&&s.scope==n.Scope.All&&l.length===1&&(n.isApp(l[0].type)||n.isSetting(l[0].type)||n.isFileOrFolder(l[0].type))&&o.searchTheWeb&&this._ranker.allowInTopHit(s,o.searchTheWeb)&&(!n.config.enableBoostWebAnswerScoreLimit||n.config.enableBoostWebAnswerScoreLimit&&l[0].rankingScore<n.config.boostWebAnswerScoreThreshold)&&l.push(o.searchTheWeb),n.config.promoteAS2SecondTopWhenTopHitIsFLorFD&&s.scope==n.Scope.All&&l.length===1&&n.isFileOrFolder(l[0].type)&&n.config.thresholdForQFToSkipGIQS>0&&s.queryToFetch.length>n.config.thresholdForQFToSkipGIQS){for(let t=0;t<r.length;t++)if(!n.contains(l,r[t])&&(n.isWebSuggestion(r[t])||r[t].type=="MB")){l.push(r[t]);break}l.length===1&&o.searchTheWeb&&!n.contains(l,o.searchTheWeb)&&l.push(o.searchTheWeb)}if(n.config.enablePutASInSecondTopHit&&s.scope==n.Scope.All&&l.length===1&&l[0].type!="MB"){for(let t=0;t<r.length;t++)if(!n.contains(l,r[t])&&(n.isWebSuggestion(r[t])||r[t].type=="MB")){l.push(r[t]);break}l.length===1&&o.searchTheWeb&&!n.contains(l,o.searchTheWeb)&&l.push(o.searchTheWeb)}if(n.config.stickyTopResultsV2&&t.length==1&&n.config.enableSuperStickySWTopHit){let u=l.filter(n=>n.handoffType==0),f=l.filter(n=>n.type=="ANAH"||n.type=="ANAR"),i=r.filter(n=>n.type=="ANAH"||n.type=="ANAR").sort((n,t)=>t.rankingScore-n.rankingScore);f.length==0&&i.length>0?l.push(i[0]):o.searchTheWeb&&u.length==0&&this._ranker.allowInTopHit(s,o.searchTheWeb)&&(n.config.enableSoftSuperStickySWTopHit&&t[0].rankingScore<2||n.config.enableHardSuperStickySWTopHit&&t[0].rankingScore<0||!n.config.enableHardSuperStickySWTopHit&&t[0].rankingScore<1)&&l.push(o.searchTheWeb)}if(n.config.enableMRUHint&&l.length>0&&this._previousKeystrokeCache){let n=this._previousKeystrokeCache.getPreviousTopHit();n&&n.mruHintEnabled&&n.text==l[0].text&&n.type==l[0].type&&(l[0].mruHintEnabled=!0)}if(this.promoteIFFPolarisToTopResults(s,l,r),n.config.enableCISpeller&&l.length==1&&this._previousKeystrokeCache&&(l[0].type=="PP"||l[0].type=="ST")&&this._previousKeystrokeCache.setPreviousTopHit(ut?null:l[0]),n.config.topHitMuse&&l.forEach(n=>{var t,i,r,u;return n.tooltip="thRank:"+((t=n.rankingScore)===null||t===void 0?void 0:t.toString())+" thlaunch:"+((i=n.anaheimRankingSignals)===null||i===void 0?void 0:i.visitCount)+" thDateV:"+((u=(r=n.anaheimRankingSignals)===null||r===void 0?void 0:r.dateVisited)===null||u===void 0?void 0:u.toString())}),l.length>2&&(n.config.enableSuperStickySWTopHit||n.config.enableSuperBouncySWTopHit))n.tryRemove(l,o.searchTheWeb);else if(n.config.enableSuperBouncySWTopHit){let i=[];for(a in r){let t=r[a].staticGroupType;t||(t=n.getGroupType(r[a]));t&&i.indexOf(t)<0&&i.push(t)}for(a in t){let r=t[a].staticGroupType;r||(r=n.getGroupType(t[a]));r&&i.indexOf(r)<0&&i.push(r)}i.length>1&&(i.indexOf(n.GroupType.SearchSuggestions)>=0||n.config.enableFromYourHistory&&i.indexOf(n.GroupType.FromYourHistory)>=0)?n.config.enablePutASInSecondTopHit||n.config.promoteAS2SecondTopWhenTopHitIsFLorFD||n.tryRemove(l,o.searchTheWeb):l.length==0&&i.length==1&&(i.indexOf(n.GroupType.SearchSuggestions)>=0||n.config.enableFromYourHistory&&i.indexOf(n.GroupType.FromYourHistory)>=0)&&l.push(o.searchTheWeb)}if(n.config.disableQFPreviewBtnForChatSugg)for(a in l)((it=l[a].icon)===null||it===void 0?void 0:it.className)===n.searchChatIconClassName()&&(l[a].icon=n.getSearchSuggestionIcon(),l[a].primaryMetadata=n.Host.getLocString("SeeWebResults"),l[a].click=()=>{var t;return n.Host.launchSearchAsync(l[a].query,this._navigationHelper.getSearchUrl(l[a].query,l[a].query,l[a].type,null,0,undefined,undefined,undefined,undefined),(t=l[a])===null||t===void 0?void 0:t.useRaf)});return n.config.wsbWithCopilotQF&&(v=1,l.length>v&&(l=l.slice(0,v))),n.Host.enableAddCopilotActionToBestMatch()&&l.length==1&&n.isSuggestionWithCopilotAction(l[0])&&l.push(this.createCopilotSuggestion(l[0],s)),(s===null||s===void 0?void 0:s.scope)==n.Scope.All&&n.isSupportWebResultsInAllScopeInDMAEnabled()&&l.some(n=>n.type==="TP")&&this.appendDMASearchAppSuggestionsToTopResults(s,l,r,h),l}createCopilotSuggestion(t,i){let r="",e="",h=n.Host.getLocString("StartANewConversation");n.isSetting(t===null||t===void 0?void 0:t.type)?r=n.config.copilotSettingSuggestionString:n.isPhoto(t===null||t===void 0?void 0:t.type)?r=n.config.copilotPhotoSuggestionString:(e=t===null||t===void 0?void 0:t.extensionLC,r=n.isPowerPointSuggestion(e)?n.config.copilotPPTSuggestionString:n.isExcelSuggestion(e)?n.config.copilotExcelSuggestionString:n.config.copilotFileSuggestionString);let c=!!r&&n.Host.getLocString(r,`${HitHighlightingParser.addMarkers(t.query)}`),o=!!r&&n.Host.getLocString(r,`${t.query}`),s="&q="+o+"&form=WSBQFE",u=t===null||t===void 0?void 0:t.path;!u||(s+="&file="+u);let f=n.createSuggestion(i,c,t.getIcon,{type:0,content:null},"CopSugg",o,n.InstrumentedItem.createInstrumentedItem(t.sequenceNumber,"CopSugg"),26,t.sequenceNumber,!1,null,()=>{n.Host.launchUriWithCopilotProtocalAsync(s),SearchAppWrapper.CortanaApp.dismissApp()},!1);return f.primaryMetadata=h,f.copilotSuggestionInBestMatchMirrorType=t===null||t===void 0?void 0:t.type,!u||(f.copilotSuggestionInBestMatchMirrorFilePath=u),f}appendDMASearchAppSuggestionsToTopResults(t,i,r,u){var o,s;const h=n.Host.getDMAWebProvidersOrderMap(),l=new Set,c={},e=[],f=[];for(const n of i)n.type==="TP"?(((o=n.sourceApp)===null||o===void 0?void 0:o.applicationUserModelId)&&l.add(n.sourceApp.applicationUserModelId),f.push(n)):e.push(n);for(const n of r){const t=(s=n.sourceApp)===null||s===void 0?void 0:s.applicationUserModelId;t&&!c[t]&&(c[t]=n)}for(const n of Object.values(h)){const i=n.applicationUserModelId;if(!l.has(i)){const r=c[i];f.push(r||this.createDMAPlaceholderSuggestion(t,n,u))}}f.sort((n,t)=>{var i,r;const u=n.sourceApp?((i=h[n.sourceApp.applicationUserModelId])===null||i===void 0?void 0:i.order)||Number.MAX_SAFE_INTEGER:Number.MAX_SAFE_INTEGER,f=t.sourceApp?((r=h[t.sourceApp.applicationUserModelId])===null||r===void 0?void 0:r.order)||Number.MAX_SAFE_INTEGER:Number.MAX_SAFE_INTEGER;return u-f});const a=i.findIndex(n=>n.type==="TP");a!==-1?e.splice(a,0,...f):e.push(...f);i.length=0;i.push(...e)}createDMAPlaceholderSuggestion(t,i,r){const u=n.createSuggestion(t,t.queryToFetch,null,n.getSearchSuggestionIcon(),"TP",t.queryToFetch,n.InstrumentedItem.createInstrumentedItem(r,"TP"),1,r,!1,`DMA-${i.displayName}-Placeholder`,()=>{},!1,`DMA-${i.displayName}-Placeholder`);u.previewPaneType=1;u.sourceApp=n.Host.getThirdPartySearchAppByName(i.displayName);u.primaryMetadata=n.Host.getLocString("DMAWebSearchResults",i.displayName)+" ("+n.Host.getLocString("Loading").toLocaleLowerCase()+")";let f=u.sourceApp;return f&&f.getLogoAsDataUriAsync&&(u.getIcon=n.getDmaSuggestionIcon(f)),u}applyAppOverride(n,t){const i=["Microsoft.Office.WINWORD.EXE","{6D809377-6AF0-444B-8957-A3773F02200E}\\Windows NT\\Accessories\\wordpad.exe"];let r=n[0].deviceItem?n[0].deviceItem.id:null;if(r&&r.startsWith(i[1])){let r=t.findIndex(n=>n.deviceItem&&n.deviceItem.id&&n.deviceItem.id.startsWith(i[0]));r>=0&&n.splice(0,1,t[r])}}setUseRafFlag(t,i,r,u){if(n.isCortanaEnabledCache&&u==2)for(let n of t)n.handoffType!=0||n.isAnswer||(n.useRaf=!0)}determineANASuggestionsToRemoveForZeroInput(t,i,r){const u=n.canShowAnaheimDataSH(),f=n.canShowAnaheimDataSHTileE2E(),e=n.canShowAnaheimDataSHListE2E();r.isSearchHomeZI&&u&&r.scope==n.Scope.All&&t.forEach((t,r)=>{n.config.enableAnaheimDataTSTile&&(f?n.canShowAnaheimWin11ZITopSites()||t.type!="TOPL"||i.push(r):t.type=="ANAT"&&i.push(r)),n.canShowAnaheimWin11ZITopSites()&&t.type=="QSSG"&&i.push(r),e?t.type=="QSSG"&&i.push(r):(t.type=="ANAH"||t.type=="ANAR")&&i.push(r)})}determineSuggestionsToAddToGroups(t,r,u,f,e,o,s,h,c){let l=u.filter(t=>!n.contains(e,t)),a=[];n.RuntimeConfig.FlatListWithoutGroups||l.forEach((t,i)=>{this.allowedInGroups(t)||(n.getScope(n.getGroupType(t))==n.Scope.All?a.push(i):t.suppressed=!0)});this.determineANASuggestionsToRemoveForZeroInput(l,a,s);for(let n=a.length-1;n>=0;--n)l.splice(a[n],1);if(o.searchTheWeb){let t=e.indexOf(o.searchTheWeb);if(t!=-1){let r=n.removeFirstWhere(l,n=>i(n,s));r&&(e[t]=r)}}let v=l.filter(t=>n.contains([n.GroupType.SearchSuggestions,n.GroupType.FromYourHistory,n.GroupType.Websites,n.GroupType.LocalPlaces],n.getGroupType(t))),p=l.filter(n.enforceOriginalOrder);const y=u.find(n=>n.handoffType===21);return n.config.enableAnaheimRelevance==2&&(v=l.filter(t=>n.contains([n.GroupType.Websites,n.GroupType.LocalPlaces],n.getGroupType(t)))),!h&&this.canRenderChildSuggestions(e,c,s)?this.addChildSuggestions(t,e[0],l):(s===null||s===void 0?void 0:s.scope)===n.Scope.Work&&y&&this.addChildSuggestions(t,y,l),s.queryToFetch&&l.sort((n,t)=>t.rankingScore-n.rankingScore),this.insertDefaultSearchTheWeb(s,o,e,r,l,v),l=this.insertSuggestionsToRightPlace(l,p),l=this.insertSuggestionsToRightPlace(l,v),n.config.topHitMuse&&e.forEach(n=>{var t,i,r,u;return n.tooltip="gaRank:"+((t=n.rankingScore)===null||t===void 0?void 0:t.toString())+" galaunch:"+((i=n.anaheimRankingSignals)===null||i===void 0?void 0:i.visitCount)+" gaDateV:"+((u=(r=n.anaheimRankingSignals)===null||r===void 0?void 0:r.dateVisited)===null||u===void 0?void 0:u.toString())}),l}insertDefaultSearchTheWeb(t,r,u,f,e,o){if(r.searchTheWeb&&(t.scope==n.Scope.Web||t.scope==n.Scope.All)){let n=o.findIndex(n=>i(n,t));if(f.some(n=>i(n,t))||u.some(n=>i(n,t))){if(n!=-1){let t=o[n];o.splice(n,1);e.splice(e.indexOf(t),1)}}else n==-1&&(o.unshift(r.searchTheWeb),e.unshift(r.searchTheWeb))}}getGroupOrder(t,i,r){switch(t.scope){case n.Scope.Web:if(!t.queryToFetch)return n.config.enableFromYourHistory?[{type:n.GroupType.Websites},{type:n.GroupType.FromYourHistory},{type:n.GroupType.SearchSuggestions}]:[{type:n.GroupType.Websites},{type:n.GroupType.SearchSuggestions}];break;case n.Scope.Apps:return[{type:n.GroupType.Apps},{type:n.GroupType.Store}];case n.Scope.Photos:return[{type:n.GroupType.Photos},{type:n.GroupType.SearchSuggestions}];case n.Scope.Videos:return[{type:n.GroupType.Videos},{type:n.GroupType.SearchSuggestions}]}let u=r.concat(i);u.sort((n,t)=>t.rankingScore-n.rankingScore);let s=[],o=[],e=[];for(let t of u)if(t.suppressed)o.push(t);else if(s.push(t),n.config.enableStaticGroupRanking){let r=n.getGroupType(t),i={type:r,source:t.sourceForGroup};e.some(t=>n.sameGroup(t,i))||e.push(i)}o.length!=0&&(u=s.concat(o));let f=[];n.config.enableStaticGroupRanking&&n.isMarketEligible(n.Host.getRegion(),n.Host.getLanguage(),n.config.disableWebCheckForGroupingLanguageRegionPairs)&&u.length>0?f=this.getStaticGroupOrder(e):n.config.enableStaticGroupRanking&&u.length>0&&n.getGroupType(u[0])!=n.GroupType.SearchSuggestions&&n.getGroupType(u[0])!=n.GroupType.FromYourHistory&&(f=this.getStaticGroupOrder(e));for(let i of u){let u=n.getGroupType(i,t===null||t===void 0?void 0:t.scope),r=this.getTypeWithSource(u,i);f.some(t=>n.sameGroup(t,r))||(!n.config.enableStaticGroupRanking||!n.isTopHitChildGroup(r)||i.handoffType===21?f.push(r):f.unshift(r))}return f}getTypeWithSource(t,i){const r=t==n.GroupType.MRUHistory?undefined:i.sourceForGroup;return{type:t,source:r}}addChildSuggestions(t,i,r){i.calculateChildSuggestions&&i.calculateChildSuggestions();i.childSuggestions&&i.childSuggestions.length>0&&Object.keys(n.config.topHitChildGroups).forEach((n,u)=>{const f=parseInt(n),e=this.getMaxChildSuggestions(t,i,f);if(e>0){const n=i.childSuggestions.filter(n=>n.groupType==f).slice(0,e);n.forEach((n,t)=>{n.handoffType===21||(n.rankingScore=1e4-100*u-t),r.push(n)})}})}getMaxChildSuggestions(t,i,r){var u;return n.isMsbVerticalOnlineSuggestionType(i.type)?t?((u=i.childSuggestions)===null||u===void 0?void 0:u.length)||0:n.config.msbVerticalChildSuggestionsInL1||0:n.contains(n.config.suppressedTopHitChildGroups,r)?0:n.config.topHitChildGroups[r]}canRenderChildSuggestions(t,i){if(n.RuntimeConfig.FlatListWithoutGroups||t.length!=1)return!1;let r=t[0];if(n.RuntimeConfig.AlwaysWide){const n=r.previewPaneType===1,t=r.handoffType===21,i=r.type==="MPPL"&&!!r.calculateChildSuggestions;if(!n&&!t&&!i)return!1}if(!i||r.handoffType===21)return!0;if(this._renderedTopResults.topResults.length==1){let t=this._renderedTopResults.topResults[0];return t.hasChildSuggestionsDisplayed&&t.query==r.query&&n.getGroupType(t)==n.getGroupType(r)}return!1}insertSuggestionsToRightPlace(t,i){if(i.length==0)return t;let r=[],u=i[0];for(let f=0;f<t.length;f++){let e=t[f];e==u?r=r.concat(i):n.contains(i,e)||r.push(e)}return r}ensureUniqueReactKeys(t){let i={};if(t)for(let r=t.length-1;r>=0;r--){let u=t[r];if(i[u.reactKey]){let i=t.splice(r,1),u=i[0].mayContainPII?i[0].type:i[0].reactKey;n.LogWSBError("ensureUniqueReactKeys","Found two suggestions with the same key: "+u,undefined,undefined,undefined,"WindowsTelemetry")}else i[u.reactKey]=1}}getStaticGroupOrder(t){let r=[],i=[{type:n.GroupType.Apps},{type:n.GroupType.Settings},{type:n.GroupType.Documents,source:1},];n.config.enableCopIFFAboveTheWeb&&(i=[{type:n.GroupType.Apps},{type:n.GroupType.Settings},{type:n.GroupType.Documents},{type:n.GroupType.Documents,source:1},{type:n.GroupType.Documents,source:2},{type:n.GroupType.Documents,source:3},{type:n.GroupType.Documents,source:4},{type:n.GroupType.Photos},{type:n.GroupType.Folders},{type:n.GroupType.Store}]);n.config.enableCopIFFAboveAll&&(i=[{type:n.GroupType.Documents},{type:n.GroupType.Documents,source:1},{type:n.GroupType.Documents,source:2},{type:n.GroupType.Documents,source:3},{type:n.GroupType.Documents,source:4},{type:n.GroupType.Photos},{type:n.GroupType.Folders},{type:n.GroupType.Apps},{type:n.GroupType.Settings},{type:n.GroupType.Store}]);(n.config.enableWinStoreAppPreview||n.config.enableWinStoreAppDataProvider)&&(i=[{type:n.GroupType.Apps},{type:n.GroupType.Settings},{type:n.GroupType.Store},{type:n.GroupType.Documents,source:1},]);n.isHighPriorityFileProviderEnabled()&&n.AccessTokenManager.getWindowsAccountType()!=1&&(i=[{type:n.GroupType.Apps},{type:n.GroupType.Settings},{type:n.GroupType.Documents},],(n.config.enableWinStoreAppPreview||n.config.enableWinStoreAppDataProvider)&&(i=[{type:n.GroupType.Apps},{type:n.GroupType.Settings},{type:n.GroupType.Store},{type:n.GroupType.Documents},]),n.config.enableCopIFFAboveTheWeb&&(i=[{type:n.GroupType.Apps},{type:n.GroupType.Settings},{type:n.GroupType.Documents},{type:n.GroupType.Documents,source:1},{type:n.GroupType.Documents,source:2},{type:n.GroupType.Documents,source:3},{type:n.GroupType.Documents,source:4},{type:n.GroupType.Photos},{type:n.GroupType.Folders},{type:n.GroupType.Store}]),n.config.enableCopIFFAboveAll&&(i=[{type:n.GroupType.Documents},{type:n.GroupType.Documents,source:1},{type:n.GroupType.Documents,source:2},{type:n.GroupType.Documents,source:3},{type:n.GroupType.Documents,source:4},{type:n.GroupType.Photos},{type:n.GroupType.Folders},{type:n.GroupType.Apps},{type:n.GroupType.Settings},{type:n.GroupType.Store}]));n.config.topHitMuse&&(i=[{type:n.GroupType.Apps},{type:n.GroupType.AnaheimDataTopHit},{type:n.GroupType.Settings},{type:n.GroupType.Documents,source:1}]);for(let u of i)t.some(t=>n.sameGroup(t,u))&&r.push(u);return t.some(t=>n.sameGroup(t,{type:n.GroupType.SearchSuggestions}))&&r.push({type:n.GroupType.SearchSuggestions}),n.config.enableFromYourHistory&&t.some(t=>n.sameGroup(t,{type:n.GroupType.FromYourHistory}))&&r.push({type:n.GroupType.FromYourHistory}),r}promoteIFFPolarisToTopResults(t,i,r){var u,f,e,o,s,h,c,l,a,v,y;if((n.config.enableCopIFFAboveTheWeb||n.config.enableCopIFFAboveAll)&&t.scope==n.Scope.All){if(i.length>0)if(n.isPhoto((u=i[0])===null||u===void 0?void 0:u.type)||n.isFileOrFolder((f=i[0])===null||f===void 0?void 0:f.type)){for(let u=0;u<r.length;u++)if(n.isContentSearch((e=r[u])===null||e===void 0?void 0:e.type)&&n.isSameType((o=r[u])===null||o===void 0?void 0:o.type,(s=i[0])===null||s===void 0?void 0:s.type)&&!n.isDuplicate(t,i[0],r[u])){i[1]=r[u];break}}else if(n.isWebSuggestion(i[0]))for(let t=0;t<r.length;t++)if(n.isContentSearch((h=r[t])===null||h===void 0?void 0:h.type)){i[1]=r[t];break}}else if(n.config.enableCopIFFPromoteByRelevance&&t.scope==n.Scope.All&&i.length>0)if(n.isPhoto((c=i[0])===null||c===void 0?void 0:c.type)||n.isFileOrFolder((l=i[0])===null||l===void 0?void 0:l.type)){for(let u=0;u<r.length;u++)if(!n.isDuplicate(t,i[0],r[u])){n.isSameType((a=r[u])===null||a===void 0?void 0:a.type,(v=i[0])===null||v===void 0?void 0:v.type)&&(i[1]=r[u]);break}}else if(n.isWebSuggestion(i[0]))for(let t=0;t<r.length;t++){n.isContentSearch((y=r[t])===null||y===void 0?void 0:y.type)&&(i[1]=r[t]);break}}}t.Aggregator=o})(t=n.Ranking||(n.Ranking={}))}(WSB||(WSB={})),function(n){function e(t,i){t(n.getCurrentTime(),n.getInputType(i),i)}function i(n,t){let i=parseInt(n.substr(1),16),r=i>>16&255,u=i>>8&255,f=i&255;return"rgba("+r+","+u+","+f+","+t+")"}function r(n,t){var i=parseInt(n.slice(1),16),r=t<0?0:255,u=t<0?t*-1:t,f=i>>16,e=i>>8&255,o=i&255;return"#"+(16777216+(Math.round((r-f)*u)+f)*65536+(Math.round((r-e)*u)+e)*256+(Math.round((r-o)*u)+o)).toString(16).slice(1)}n.invokeClickHandler=e;n.SinglePaneWidth=344;n.PreviewPaneWidth=440;n.DebugWindowWidth=800;n.CobaltPreviewPaneWidth=410;const o="qfContainer",u="workScopeSubVerticalsContainer";let t,f="aria-selected";n.MaxTextScaleThres=1.2;n.MinTextScaleThres=.8;class s{constructor(){this._windowsTemporaryMessageShown=!1;this._progressBarVisible=!1;this._previewPaneVisible=!1;this._debugWindowVisible=!1;this._suggestionsContainerHeight=0;this._renderingInProgress=!1;this._narratorLaunchHandlers=[];this._viewData={};this._targetElemCache={};this._shimmerShown=!1;this._copilotChatQueryCount=0;this.scrollTo=(t,i,r)=>{var s;let f=_ge(t.id);const l=(s=this._qfContainer)===null||s===void 0?void 0:s.contains(f);while(r&&l&&(f===null||f===void 0?void 0:f.offsetParent.id)!==o)f=f.parentElement;let e;const h=n.msbDsbHost&&n.isMsbEnterprise()&&t.dsb,c=i&&h?_ge(n.MsbDsb.MAINPAGE_CONTAINER_SCROLL):n.StaticHtmlElements.msbDsbRoot;if(n.config.disbaleWideForLargeTextScale){const t=f.closest(".suggsList")!=null;e=h?c:!n.config.enableWin11SSH&&i&&!t?n.StaticHtmlElements.root:r&&(f===null||f===void 0?void 0:f.id)===u?n.StaticHtmlElements.qfContainerScroll:this._qfContainer;this.scrollToElement(f,e,e.offsetHeight);this.scrollToElementBottomHorizontalScrollBar(f,_qs(".resultsContainer"),_qs(".resultsContainer").offsetWidth)}else e=h?c:!n.config.enableWin11SSH&&i?n.StaticHtmlElements.root:r&&(f===null||f===void 0?void 0:f.id)===u?n.StaticHtmlElements.qfContainerScroll:this._qfContainer,this.scrollToElement(f,e,e.offsetHeight)};let r=new MutationObserver(n=>{if(!this._renderingInProgress){let t=[],i;for(let r of n){let n=r.target;i=n.id;t.push(n.getAttribute(f)=="true"?1:0)}(t.length==1&&t[0]==0||t.length==2&&t[0]^t[1])&&this._narratorLaunchHandlers.forEach(n=>n(i))}});r.observe(document,{subtree:!0,attributes:!0,attribute