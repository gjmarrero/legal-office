eSubtree=!0}return o}getPageRegexData(e,t,o=!1,a=void 0){return JSON.stringify({automated:t?.urlRegex??"",regular:o?this.cashbackDao.isTraveldomain()?a?.confirmationPageUrl||"":this.cashbackDao.getConfirmationPageRegex():e?.checkoutPageUrl})}saveCartData(e,t){try{this.saveToLocalAndPersistentStorage(C._.CartDataKey,e)}catch(o){this.logDebugOrErrorEvent("Error saving cart data",!0,t,"",e,!0,{error:o,size:this.getObjectSize(e)})}}markAsUsedCartData(e,t){try{e&&(e.IsAlreadySent=!0,this.saveCartData(e,t))}catch(o){this.logDebugOrErrorEvent("Error in markAsUsedCartData",!0,t,"",e,!0,{error:o})}}getObjectSize(e){try{return e?JSON.stringify(e).length:0}catch(e){this.logDebuggMesageToConsole("Error getting object size",e)}return-1}saveToLocalAndPersistentStorage(e,t){const o=t?JSON.stringify(t):"";this.cashbackDao.saveToLocalCache(e,o),this.cashbackDao.saveToLocalCachePersistent(e,t)}readFromLocalAndPersistentStorage(e){const t=this.cashbackDao.readFromLocalCache(e);if(t)return{data:t,isFromLocal:!0,isFromPersistent:!1};const o=this.cashbackDao.readFromLocalCachePersistent(e);return o?{data:o,isFromLocal:!1,isFromPersistent:!0}:void 0}saveProductCollectionData(e){this.saveToLocalAndPersistentStorage(B,e)}readProductCollectionData(){return this.readFromLocalAndPersistentStorage(B)?.data}getCurrency(e){return e?(0,u.cU)(e,!0):""}getCurrencyMarket(){return(0,u.N6)(this.cashbackDao.getAfdMarket())}mergeCartData(e,t){const o={OrderSubTotal:t?.OrderSubTotal||e?.OrderSubTotal||0,OrderTotal:t?.OrderTotal||e?.OrderTotal||0,ProductNames:t?.ProductNames||e?.ProductNames||"",Currency:t?.Currency||e?.Currency||"",PricePerItem:t?.PricePerItem||e?.PricePerItem||"",QuantityPerItem:t?.QuantityPerItem||e?.QuantityPerItem||"",ProductUrls:t?.ProductUrls||e?.ProductUrls||"",ProductIds:t?.ProductIds||e?.ProductIds||"",ProductSellers:t?.ProductSellers||e?.ProductSellers||"",IsFromBuyNowButton:t?.IsFromBuyNowButton??e?.IsFromBuyNowButton??!1,ExtractionId:t?.ExtractionId||e?.ExtractionId||"",CartDataCreationTime:t?.CartDataCreationTime||e?.CartDataCreationTime||0,CartId:t?.CartId||e?.CartId||"",ExtractionPageRegex:t?.ExtractionPageRegex||e?.ExtractionPageRegex||"",ProductImg:t?.ProductImg||e?.ProductImg||"",IsMerged:!0,Products:t?.Products||e?.Products||""};this.cashbackDao.isTraveldomain()&&(o.TravelData={StartDate:t?.TravelData?.StartDate||e?.TravelData?.StartDate||"",EndDate:t?.TravelData?.EndDate||e?.TravelData?.EndDate||"",IsRoundTrip:t?.TravelData?.IsRoundTrip||e?.TravelData?.IsRoundTrip||"",ConfirmationState:t?.TravelData?.ConfirmationState||e?.TravelData?.ConfirmationState||"",DomainType:t?.TravelData?.DomainType||e?.TravelData?.DomainType||""});const a=t?.CurrencyForMarket||e?.CurrencyForMarket||"";a&&a!==o.Currency&&(o.CurrencyForMarket=a);const i=t?.StorageSource||e?.StorageSource||"";return i&&(o.StorageSource=i),o}mergeExtractedData(e,t){const o={productQuantity:e?.productQuantity||t?.productQuantity||"",productNames:e?.productNames||t?.productNames||"",productPrice:e?.productPrice||t?.productPrice||"",productTitleFromImage:e?.productTitleFromImage||t?.productTitleFromImage||"",productSkus:e?.productSkus||t?.productSkus||"",purchaseTotal:e?.purchaseTotal||t?.purchaseTotal||"",orderSubTotal:e?.orderSubTotal||t?.orderSubTotal||"",transactionId:e?.transactionId||t?.transactionId||"",productSellers:e?.productSellers||t?.productSellers||"",productUrls:e?.productUrls||t?.productUrls||"",productBrands:e?.productBrands||t?.productBrands||"",productCategories:e?.productCategories||t?.productCategories||"",productImages:e?.productImages||t?.productImages||"",startDate:e?.startDate||t?.startDate||"",endDate:e?.endDate||t?.endDate||"",isRoundTrip:e?.isRoundTrip||t?.isRoundTrip||"",confirmationState:e?.confirmationState||t?.confirmationState||""};return o.productTitleFromImage=this.dedupValues(o.productTitleFromImage),o}removePII(e,t,o){const a=U({},e);for(let e of Object.keys(a)){const i=a[e];a[e]=this.maskPiiWithCatch(i,e,t,o)}return a}maskPiiWithCatch(e,t,o,a){try{if(!e)return"";const i=this.personalDataRemover.maskDataInAString(e);return e&&!i&&this.logDebugOrErrorEvent("Pii removal set value to empty",!0,o,a,void 0,!0,{fieldName:t}),i}catch(t){return this.logDebugOrErrorEvent("Error masking PII",!0,o,a,void 0,!0,{error:t}),e}}dedupValues(e){if(e){const t=e.split(this.scraperService.getSeparator()).filter((e=>!!e)),o=new Set(t);return Array.from(o).join(this.scraperService.getSeparator())+this.scraperService.getSeparator()}return""}mergeConfirmationDataWithCartCaching(e,t,o,a,r){const{confirmationDetails:n,didFallbackToOldCart:s}=t?this.setConfirmationDetailsFromCartCaching(t):{confirmationDetails:new i.Z,didFallbackToOldCart:!1};n.currency=n.currency||"",n.orderConfirmationPageUrl=o,n.transactionId=e?.transactionId||"",s&&a.push("falling back to old cart data"),e?.productNames&&(r&&n.productNames?a.push(`productNames taken from cart page, product names from confirmation page: ${e.productNames}`):(n.productNames=e.productNames,a.push("productNames taken from confirmation page product selector"))),!n.productNames&&e?.productTitleFromImage&&(n.productNames=e.productTitleFromImage,a.push("productNames taken from image on confirmation page"));const c=e?this.getOrderTotalSubtotalAndCurrencyIfPresent(e):void 0;if(!n.currency&&c?.currency&&(n.currency=c.currency,a.push("currency taken from confirmation page")),c&&c.orderTotalToUse>0&&(n.purchaseTotal=`${n.currency}${c.orderTotalToUse}`,a.push("purchaseTotal taken from confirmation page")),c&&c.orderSubtotalToUse>0&&(n.orderSubTotalPrice=`${n.currency}${c.orderSubtotalToUse}`,a.push("orderSubTotalPrice taken from confirmation page")),e?.productQuantity&&(n.quantityPerItem=e.productQuantity),e?.productPrice&&(n.pricePerItem=e.productPrice),n.productNames){const e=n.productNames.split(this.scraperService.getSeparator()).filter((e=>!!e));n.numberOfItems=e.length.toString()}if(!n.purchaseTotal&&n.orderSubTotalPrice&&(n.purchaseTotal=n.orderSubTotalPrice,a.push("purchaseTotal taken from subTotal")),this.cashbackDao.getFeatureFlag("purchaseTotalInTransactionId",!1)&&n.transactionId&&!o.includes(n.transactionId)){const e=this.getPriceFromString(n.transactionId);if(!n.currency){const e=this.getCurrency(n.transactionId);e&&(n.currency=e,a.push("currency taken from transactionId"))}e>0&&(n.purchaseTotal=`${n.currency}${e}`,a.push("purchaseTotal taken from transactionId"))}if(!n.purchaseTotal){const e=this.getOrderTotalPromProductPrices(n.pricePerItem??"");e>0&&(n.purchaseTotal=`${n.currency}${e}`,a.push("Order total taken from product prices"))}return n}getPriceFromString(e){if(!e)return 0;const t=this.cashbackDao.getFeatureFlag("useExperimentalSeparatorHandlingforPriceRange",!1),o=e.split(this.scraperService.getSeparator()).filter((e=>!!e)).map((e=>(0,u.UK)(e,void 0,t))).filter((e=>e>0));return o.length>0?o[0]:0}getOrderTotalPromProductPrices(e){return e?e.split(this.scraperService.getSeparator()).filter((e=>!!e)).map((e=>this.getPriceFromString(e))).reduce(((e,t)=>e+t),0):0}createLogDataTravel(e,t,o,a,i,r,n){const s=this.personalDataRemover.deleteSecretsInURL(t.orderConfirmationPageUrl??"")??"";t.orderConfirmationPageUrl&&!s&&i.push("ConfirmationPageUrl was set to empty by personalDataRemover");const c={IsRoundTrip:o.isRoundTrip,StartDate:o.startDate,EndDate:o.endDate},d=this.cashbackDao.getPersonalizedCashback(),u=t.transactionId??"",h=this.cleanTravelData(c,t.productNames||"",e?.dateCleaningRegex||"",e?.dateSeparationRegex||""),p=h?.FlightLegs||r?.TravelData?.FlightLegs;return{EndDate:h?.EndDate||r?.TravelData?.EndDate||"",StartDate:h?.StartDate||r?.TravelData?.StartDate||"",IsRoundTrip:h?.IsRoundTrip||r?.TravelData?.IsRoundTrip||"",ConfirmationState:o.confirmationState||"",DomainType:e?.domainType||r?.TravelData?.DomainType||"",FlightLegs:p?JSON.stringify(p):"",BookingId:u,Name:this.removeTrailingSep(t.productNames||""),Price:t.purchaseTotal||"",RGuid:d?.rGuid??"",Currency:t.currency??"",Domain:(0,l.uE)(window.location.hostname),OrderConfirmationPageUrl:s,TransactionId:u,PersonalizationDataConsent:this.cashbackDao.getSanConsentFlag(),ExtractionId:this.extractionId,CartData:r?JSON.stringify(r):"",CartId:r?.CartId??"",Anid:a,EventId:this.GetEventId(),Latency:0,OldExtractionId:"",OldCartId:"",IsMobile:!1,ActiveCashbackOffers:this.getActivatedOffers(),RetailerDataDomain:this.cashbackDao.getCurrentDomain(),PageRegexUsed:n}}createLogData(e,t,o,a,i){const{isElectron:r,isChromeDriver:n,driverEvaluate:s,webdriverEvaluate:c,seleniumUnwrapped:d,windowCallPhantom:u,WINDOW_PHANTOM:h,windowPhantom:p}=this.getBrowserData(),m=this.cashbackDao.getSessionIds(),g=m?.retailerSessionId??"",C=m?.pageVisitId??"";let S=e.transactionId??"";const f=this.personalDataRemover.deleteSecretsInURL(e.orderConfirmationPageUrl??"")??"";e.orderConfirmationPageUrl&&!f&&a.push("ConfirmationPageUrl was set to empty by personalDataRemover");const{dynamicTransactionId:v,isValidDynamicTransactionId:A}=this.dynamicTransactionUtils.getDynamicTransactionId(this.cashbackDao.getRetailerSettings());let y=!1;A&&(a.push(`DynamicTransactionId is set for this transaction. Non dynamic transaction id is: ${S}`),S=v||S,y=!0);const P=this.cashbackDao.getPersonalizedCashback(),b=this.cashbackDao.getCashback(),E={Currency:e.currency??"",Domain:(0,l.uE)(window.location.hostname),DriverEvaluate:s?JSON.stringify(s):"",EventId:this.GetEventId(),IsChromeDriver:n,IsElectron:r,NavigatorWebdriver:navigator.webdriver??!1,NumberOfItems:e.numberOfItems??"",OrderConfirmationPageUrl:f,OrderConfirmationPageUrlRegex:(0,l.og)(f,this.cashbackDao.getConfirmationPageRegex()),OrderDiscountCode:e.orderDiscountCode??"",OrderDiscountPrice:e.orderDiscountPrice??"",OrderShippingPrice:e.orderShippingPrice??"",OrderSubTotalPrice:e.orderSubTotalPrice??"",OrderTaxesPrice:e.orderTaxesPrice??"",Platform:this.cashbackDao.getPlatform(),PricePerItem:e.pricePerItem??"",ProductIdSku:e.productIdSku??"",ProductNames:e.productNames??"",ProductSellerNames:e.productSellerNames??"",PurchaseTotal:e.purchaseTotal??"",QuantityPerItem:e.quantityPerItem??"",PersonalizationDataConsent:this.cashbackDao.getSanConsentFlag(),Rguid:P?.rGuid??"",SeleniumUnwrapped:d??"",TransactionId:S,WebdriverEvaluate:c??"",WindowCallPhantom:u??"",WindowPhantom:p?JSON.stringify(p):"",Window_Phantom:h?JSON.stringify(h):"",DomainCountry:"",RetailerDataDomain:this.cashbackDao.getCurrentDomain(),ExactConfirmationPageUrl:this.cashbackDao.getConfirmationPageRegex()??"",ESF:this.cashbackDao.getESF(),Anid:t,ActiveCashbackOffers:this.getActivatedOffers(),AffiliateCashbackMetadata:b?JSON.stringify(b):"",IsAADSignedIn:this.cashbackDao.isAadSignedIn(),PageUrlFields:o,PageVisitId:C,RetailerSessionId:g,DynamicTransactionId:v,IsDynamicTransaction:y,ProductBrandNames:this.getCachedProductBrands(e.productNames??"")??"",ProductUrls:e.productUrls??"",ProductCategories:this.getCachedProductCategories(e.productNames??"")??"",ExtractionId:this.extractionId,CartData:i?JSON.stringify(i):"",CartId:i?.CartId??"",OldExtractionId:"",OldCartId:"",AdsToken:P?.adsToken??""};return this.cashbackDao.getFeatureFlag("isMobile",!1)&&(E.IsMobile=!0),this.adjustCurrencies(E,a),E}getActivatedOffers(){const e=U(U({},this.cashbackDao.getPersonalizedCashback()||{}),{},{isAffiliateActivated:this.cashbackDao.getIsAffiliateActivated()});return JSON.stringify(e)}getCachedProductBrands(e){try{let t=this.getProductDataFromCachedProduct(e).map((e=>e.ProductBrand)).join(this.scraperService.getSeparator())+this.scraperService.getSeparator();const o=this.scraperService.getSeparator();return t=o.repeat(t.length/o.length)===t?"":t,t}catch(e){this.logDebugOrErrorEvent("Couldn't extract data from cached PDP info",!0,n.GV.UnknownPage,"",void 0,!0,{error:e})}return""}getCachedProductCategories(e){try{let t=this.getProductDataFromCachedProduct(e).map((e=>e.ProductCategory)).join(this.scraperService.getSeparator())+this.scraperService.getSeparator();const o=this.scraperService.getSeparator();return t=o.repeat(t.length/o.length)===t?"":t,t}catch(e){this.logDebugOrErrorEvent("Couldn't extract data from cached PDP info",!0,n.GV.UnknownPage,"",void 0,!0,{error:e})}return""}getProductDataFromCachedProduct(e){let t=[];if(e)try{const o=this.readProductCollectionData()??[],a=e?.split(this.scraperService.getSeparator());a&&a.pop();for(const e of a){let a="",i="";for(const t of o)(this.isAprefixOfB(e,t?.ProductName)||this.isAprefixOfB(t?.ProductName,e)||this.hasSimilarWords(e,t?.ProductName))&&(a=t?.ProductBrand??"",i=t?.ProductCategory??"");t.push({ProductName:e,ProductBrand:a,ProductCategory:i})}}catch(e){this.logDebugOrErrorEvent("Couldn't extract data from cached product PDP info",!0,n.GV.UnknownPage,"",void 0,!0,{error:e})}return t}hasSimilarWords(e,t){if(!e||!t)return!1;const o=e.split(" "),a=t.split(" ");return o.filter((e=>a.includes(e))).length>=Math.min(o.length,a.length)/2}isAprefixOfB(e,t){return e=this.removeSymbolsAndSpacesFromString(e??"")??"",t=this.removeSymbolsAndSpacesFromString(t??"")??"",!(!e||!t)&&t.toLowerCase().startsWith(e.toLowerCase())}removeSymbolsAndSpacesFromString(e){return e.replace(/[,.?!@#$%^&*()[\]{}\\|?' _+=/:;<> ]/g,"")}saveTransactionIdToLocalStorage(e){const t=this.cashbackDao.getCurrentDomain();if(!e||!t)return;const o=this.getSavedTransactionIds();o[t]||(o[t]={});const a=(new Date).getTime();if(Object.values(o[t]).length>=this.MAX_TRANSACTIONS_IN_LOCALSTORAGE){let e={id:"",ts:a};Object.keys(o[t]).forEach((a=>{const i=o[t][a],r=parseInt(i);r<e.ts&&(e={id:a,ts:r})})),delete o[t][e.id]}o[t][e]=a.toString(),this.cashbackDao.saveToLocalCache(M,JSON.stringify(o))}isTransactionIdSaved(e){if(!e)return!1;const t=this.getSavedTransactionIds(),o=this.cashbackDao.getCurrentDomain();return Boolean(t&&t[o]&&t[o][e])}getSavedTransactionIds(){return this.cashbackDao.readFromLocalCache(M)??{}}clearDynamicTransactionId(){this.cashbackDao.saveToLocalCachePersistentAllDomains(c.Q.DynamicTransactionId,"")}logCheckoutPageData(e,t,o,a,i){const r=this.cashbackDao.getSanConsentFlag(),s=r||this.canLogPersonalDebugData(),c=this.cashbackDao.getSessionIds(),l={PageType:t,PageRegexUsed:o,Metadata:JSON.stringify({isFromCartMonitor:a}),Domain:this.cashbackDao.getCurrentDomain(),PageUrl:s?this.getCurrentUrlValue(!0):"",ExtractionId:this.extractionId,PersonalizationDataConsent:r,PageVisitId:c?.pageVisitId??"",RetailerSessionId:c?.retailerSessionId??"",Latency:i,CartData:e,Message:"Cart extracted"};this.getActivatedOffers()&&(l.ActiveCashbackOffers=this.getActivatedOffers()),this.logDebuggMesageToConsole("logging checkout page event",l),this.logger.LogInfoWithEvenType(l.Message,n.R.CartDataExtraction,l,this.cashbackDao.getImpressionId()),this.cashbackDao.getFeatureFlag("shouldSendWapiCartEventInExtractionService",!1)&&this.sendWAPICartEvent(e,this.cashbackDao.getCurrentDomain())}logExtractionStartOrEnd(e,t,o,a,i,r={}){if(this.cashbackDao.getFeatureFlag("disableStartAndEndExtractionLogs",!0)){if(t!==n.GV.ConfirmationPage&&t!==n.GV.CheckoutPage)return;if(t===n.GV.CheckoutPage&&e)return}const s="Extraction "+(e?"started":"ended"),c=this.createEventForSelectorLogger(t,o,U(U({},r),a),s,"",!1,i,void 0,a?.extractionTime);this.logSelectorDataEvent(c)}logDebugOrErrorEvent(e,t,o,a,i,r=!1,n){if(!t&&this.cashbackDao.getFeatureFlag("disableNonRequiredExtractionLogs",!0))return;const s=this.createEventForSelectorLogger(o,a,n,e,"",r,i,void 0);this.logSelectorDataEvent(s)}logSelectorDataEvent(e){this.logDebuggMesageToConsole(e.Message,e),this.logger.LogInfoWithEvenType(e.Message,n.R.SelectorDataExtraction,e,this.cashbackDao.getImpressionId())}logPurchasePageDataToDebug(e,t,o,a,i={},r){if(!e)return;e.Anid="",this.logDebuggMesageToConsole("logging purchase event to log table only",e);const s=this.cashbackDao.getSanConsentFlag()?i:{};e.CartData=void 0;const c=this.createEventForSelectorLogger(o,a,U(U({confirmationEvent:e},s),{},{logMessages:r}),"New purchase extraction event","",!1,t);this.logger.LogInfoWithEvenType(c.Message,n.R.SelectorDataExtraction,c,this.cashbackDao.getImpressionId())}logPurchasePageData(e,t,o,a){const i=this.cashbackDao.getFeatureFlag("logOldCarts",!1)?t:{},r=U(U({isNewExtraction:!0,extractionId:this.extractionId},i),{},{logMessages:o});a&&(r.isTravel=a),this.logger.LogInfoWithEvenType(JSON.stringify(r),a?n.R.TravelConfirmationPageDetails:n.R.ConfirmationPageDetails,e,this.cashbackDao.getImpressionId()),this.logDebuggMesageToConsole("logging purchase event","IsTravel",a,e),this.sendUetEvent(e.EventId,a?"TravelConfirmationPage":n.GV.ConfirmationPage),a||p.Q.sendWAPIPurchaseData(e)}readCartData(){const e=this.readFromLocalAndPersistentStorage(C._.CartDataKey);return e&&(e.data.StorageSource=e.isFromLocal?"local":e.isFromPersistent?"persistent":""),e?.data}getOrderTotalSubtotalAndCurrencyIfPresent(e){let t=0,o=0;const a=this.getPriceFromString(e.purchaseTotal),i=this.getPriceFromString(e.orderSubTotal);a>0&&(t=a),i>0&&(o=i,t=t>0?t:i);let r=this.getCurrency(e.purchaseTotal);return r||(r=e.productPrice?this.getCurrency(e.productPrice):""),r||(r=e.orderSubTotal?this.getCurrency(e.orderSubTotal):""),{orderTotalToUse:t,orderSubtotalToUse:o,currency:r}}setConfirmationDetailsFromCartCaching(e){const t=new i.Z;t.pricePerItem=e.PricePerItem??"",t.quantityPerItem=e.QuantityPerItem??"",t.productUrls=e.ProductUrls??"",t.productNames=e.ProductNames??"",t.productSellerNames=e.ProductSellers??"";const o=e.Currency??"";t.currency=o;const a=e.OrderTotal>0?e.OrderTotal:0,r=e.OrderSubTotal&&e.OrderSubTotal>=0?e.OrderSubTotal:0,n=a>0?a:r;t.orderSubTotalPrice=r>0?`${o}${r}`:"",t.purchaseTotal=n>0?`${o}${n}`:"";let s=!1;return this.cashbackDao.getFeatureFlag("shouldFallBackToOldCartIfEmpty",!1)&&(s=this.fallbackConfirmationDetailsToOldCartCaching(t)),{confirmationDetails:t,didFallbackToOldCart:s}}fallbackConfirmationDetailsToOldCartCaching(e){const t=this.scraperService.getSeparator(),o=this.GetLastCartData()||this.getOldCartFromPersistent();let a=!1;if(!o)return a;const i=o.Products.map((e=>e.productPrice)).join(t)+t,r=o.Products.map((e=>e.productQuantity)).join(t)+t,n=o.Products.map((e=>e.productTitle)).join(t)+t,s=o.Products.map((e=>e.productSeller)).join(t)+t,c=o.OrderTotal&&o.OrderTotal>0?o.OrderTotal:0,l=o.OrderSubTotal&&o.OrderSubTotal>=0?o.OrderSubTotal:0,d=c>0?c:l;return!e.currency&&o.Currency&&(e.currency=o.Currency,a=!0),!e.pricePerItem&&i&&(e.pricePerItem=i,a=!0),!e.quantityPerItem&&r&&(e.quantityPerItem=r,a=!0),!e.productUrls&&o.ProductUrls&&(e.productUrls=o.ProductUrls,a=!0),!e.productNames&&n&&(e.productNames=n,a=!0),!e.productSellerNames&&s&&(e.productSellerNames=s,a=!0),!e.orderSubTotalPrice&&l>0&&(e.orderSubTotalPrice=`${e.currency}${l}`,a=!0),!e.purchaseTotal&&d>0&&(e.purchaseTotal=`${e.currency}${d}`,a=!0),a}GetTimeoutForSelector(e,t,o){return e?o&&void 0!==o[e]?o[e]:o?.other&&void 0!==o.other[e]?o.other[e]:o?.other&&void 0!==o.other?.all?o.other.all:t??this.requiredValuesKeyNames[e]?this.DEFAULT_EXTRACTION_TIMEOUT:this.DEFAULT_EXTRACTION_TIMEOUT_NOT_REQUIRED:0}IsAtLeaseOneRequiredFieldPresent(e){return Boolean(e.transactionId||e.productNames||e.purchaseTotal&&"0"!==e.purchaseTotal)}logExtractionResultsToConsole(e,t,o,a,i,r,n,s=void 0){r&&this.logDebuggMesageToConsole("selectors extractByValues",r,"result",e),n&&this.logDebuggMesageToConsole("selectors extractByValues_Automated",n,"result",t),this.logDebuggMesageToConsole("result extractedData_merged",o),a&&this.logDebuggMesageToConsole("old cartCachingData",a),i&&this.logDebuggMesageToConsole("new cartCachingData",i),s&&this.logDebuggMesageToConsole("mergedCart",s)}LogSelectorExtractionStats(e,t,o,a,i,r,s){if(this.cashbackDao.getFeatureFlag("disableNonRequiredExtractionLogs",!0))return;if(!e.selectorStats?.length&&0===t.length&&0===o.length)return;const c=this.GetBrokenSelectorsData(a,i),l=this.GetBrokenSelectorsData(r,s);e.selectorStats.forEach((t=>{t.extractedValue=this.maskPiiWithCatch(t.extractedValue,t.selectorKeyName,e.pageType,e.pageRegexData)}));const d={selectorExtractionStats:e,brokenSelectorsData:t,brokenSelectorsDataAutomated:o,brokenSelectors:c,brokenSelectorsAutomated:l},u=this.createEventForSelectorLogger(e.pageType??n.GV.UnknownPage,e.pageRegexData??"",d,"Selector Stats in Scrapping Service","",!1,void 0);this.logSelectorDataEvent(u)}GetBrokenSelectorsData(e,t){if(!e)return;const o={};return Object.keys(e).forEach((a=>{if(this.requiredValuesKeyNames[a]){const i=e[a],r=t?t[a]:void 0;i?.selector&&!r&&(o[a]?o[a]+=`; ${i.selector}`:o[a]=i.selector)}})),Object.keys(o).length>0?o:void 0}GetMissingRequiredFieldsMessage(e){return e.productNames&&e.purchaseTotal&&"0"!==e.purchaseTotal&&e.transactionId?"":`${e.productNames?"":"Empty productNames;"}${e.purchaseTotal&&"0"!==e.purchaseTotal?"":"Empty purchaseTotal;"}${e.transactionId?"":"Empty transactionId;"}`}GetEventId(){let e=r.v.uuidv4();return e&&""!==e||(e=this.uuidv4()),e}uuidv4(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}getBrowserData(){let e="",t="",o="",a="",i=!1;const r=window?.windowCallPhantom,n=window?._phantom,s=window?.phantom;return document?.documentElement?.hasAttribute("__selenium_unwrapped")&&(e=document.documentElement.getAttribute("__selenium_unwrapped")),document?.documentElement?.hasAttribute("__webdriver_evaluate")&&(t=document.documentElement.getAttribute("__webdriver_evaluate")),document?.documentElement?.hasAttribute("__driver_evaluate")&&(o=document.documentElement.getAttribute("__driver_evaluate")),document?.documentElement?.hasAttribute("$cdc_asdjflasutopfhvcZLmcfl_")&&(a=typeof document.documentElement.getAttribute("$cdc_asdjflasutopfhvcZLmcfl_")),i="undefined"!=typeof window&&"object"==typeof window.process&&"renderer"===window.process?.type||!("undefined"==typeof process||"object"!=typeof process.versions||!process.versions.hasOwnProperty("electron")),{isElectron:i,isChromeDriver:a,driverEvaluate:o,webdriverEvaluate:t,seleniumUnwrapped:e,windowCallPhantom:r,WINDOW_PHANTOM:n,windowPhantom:s}}createEventForSelectorLogger(e,t,o={},a,i,r,n,s=void 0,c){const l=this.cashbackDao.getSanConsentFlag(),d=l||this.canLogPersonalDebugData();o.isAttributionEnabled=d;const u=this.cashbackDao.getSessionIds(),h={IsBrokenSelectorDetected:!1,IsPartialBrokenSelectorDetected:!1,BrokenSelectors:"",FullSelectorUsed:"",PartialSelectorUsed:"",Currency:n?.Currency??"",ExtractionResult:d&&s?JSON.stringify(s):"",CartData:d&&n?JSON.stringify(n):"",ErrorMessage:i,Metadata:o?JSON.stringify(o):"",Message:a,IsError:r,PageUrl:d?this.getCurrentUrlValue(!0):"",PageType:e,PageRegexUsed:d?t:"",Domain:this.cashbackDao.getCurrentDomain(),AFDMarket:this.cashbackDao.getAfdMarket(),IsSignedIn:this.cashbackDao.isSignedIn(),PageVisitId:u?.pageVisitId??"",RetailerSessionId:u?.retailerSessionId??"",PersonalizationDataConsent:l,ExtractionId:this.extractionId,Latency:c};return this.getActivatedOffers()&&(h.ActiveCashbackOffers=this.getActivatedOffers()),h}IsNewCart(e,t){return t?e.Currency!==t.Currency?(this.logDebuggMesageToConsole("New and old cart difference: Currency"),!0):e.OrderTotal!==t.OrderTotal?(this.logDebuggMesageToConsole("New and old cart difference: OrderTotal"),!0):e.ProductNames!==t.ProductNames?(this.logDebuggMesageToConsole("New and old cart difference: ProductNames"),!0):e.OrderSubTotal!==t.OrderSubTotal?(this.logDebuggMesageToConsole("New and old cart difference: OrderSubTotal"),!0):e.ExtractionPageRegex!==t.ExtractionPageRegex&&(this.logDebuggMesageToConsole("New and old cart difference: ExtractionPageRegex"),!0):(this.logDebuggMesageToConsole("no cached cart"),!0)}getExtractionSelectorsForPurchasePage(e,t,o,a,i,r,n){if(!e&&!t)return;const c=e?.productDetailsData&&e.productDetailsData.length>0?e.productDetailsData[0]:void 0,l=(0,d.uv)(t?.bookingIdSelector||e?.transactionIdSelector||"",!1),u={productQuantity:this.createSelectorSetting(c?.productQuantitySelector,s.fk.productQuantity),productNames:this.createSelectorSetting(t?.nameSelector||c?.productIdSelector,s.fk.productNames),productTitleFromImage:this.createSelectorSetting(c?.productImageSelector,s.fk.productTitleFromImage),productPrice:this.createSelectorSetting(c?.productPriceSelector,s.fk.productPrice),productSkus:this.createSelectorSetting(c?.productIdSkuSelector,s.fk.productSkus),purchaseTotal:this.createSelectorSetting(t?.totalPriceSelector||e?.purchaseTotalSelector,s.fk.purchaseTotal),orderSubTotal:this.createSelectorSetting(e?.orderSubTotalPriceSelector,s.fk.orderSubTotal),transactionId:this.createSelectorSetting(l,s.fk.transactionId),productSellers:this.createSelectorSetting("",s.fk.productSellers),productUrls:this.createSelectorSetting("",s.fk.productUrls),productBrands:this.createSelectorSetting("",s.fk.productBrands),productCategories:this.createSelectorSetting("",s.fk.productCategories),productImages:this.createSelectorSetting("",s.fk.productImages),startDate:this.createSelectorSetting(t?.startDateSelector,s.LP.startDate),endDate:this.createSelectorSetting(t?.endDateSelector,s.LP.endDate),isRoundTrip:this.createSelectorSetting(t?.isRoundTripSelector,s.LP.isRoundTrip),confirmationState:this.createSelectorSetting(t?.confirmationStateSelector,s.LP.confirmationState)};return this.adjustSelectors(u,a,i,r,n),this.isAtLeastOneSelectorPresent(u)?this.addExtractMultipleFlag(u,o):void 0}adjustSelectors(e,t,o,a,i){e&&(t&&(e.purchaseTotal&&(e.purchaseTotal.selector=""),e.orderSubTotal&&(e.orderSubTotal.selector="")),o&&e.productNames&&(e.productNames.selector=""),a&&e.productTitleFromImage&&(e.productTitleFromImage.selector=""),!i&&e.transactionId&&(e.transactionId.selector=""))}getExtractionSelectors(e,t,o,a){if(!t&&!e)return;const i=t?.productSelector??"",r=t?.cartSelector??"",n=e?.travelCheckoutSelectors,c={productQuantity:this.createSelectorSetting(t?.productQuantitySelector,s.fk.productQuantity,r,i),productNames:this.createSelectorSetting(n?.nameSelector||t?.productTitleSelector||o?.productTitleSelector,s.fk.productNames,r,i),productPrice:this.createSelectorSetting(t?.productPriceSelector||o?.productPriceSelector,s.fk.productPrice,r,i),productSkus:this.createSelectorSetting(t?.productIdSkuSelector||o?.productASIN,s.fk.productSkus,r,i),productTitleFromImage:this.createSelectorSetting(t?.productImageSelector||o?.productImageSelector,s.fk.productTitleFromImage,r,i),purchaseTotal:this.createSelectorSetting(n?.priceSelector||e?.orderTotalDataElementSelector,s.fk.purchaseTotal),orderSubTotal:this.createSelectorSetting(e?.orderSubTotalElementSelector,s.fk.orderSubTotal),transactionId:this.createSelectorSetting("",s.fk.transactionId),productSellers:this.createSelectorSetting(t?.productSellerSelector,s.fk.productSellers,r,i),productUrls:this.createSelectorSetting(t?.productUrlSelector,s.fk.productUrls,r,i),productBrands:this.createSelectorSetting(o?.productBrandSelector,s.fk.productBrands,r,i),productCategories:this.createSelectorSetting(o?.productCategoryListSelector,s.fk.productCategories,r,i),productImages:this.createSelectorSetting(t?.productImageSelector||o?.productImageSelector,s.fk.productImages,r,i),startDate:this.createSelectorSetting(n?.startDateSelector,s.LP.startDate),endDate:this.createSelectorSetting(n?.endDateSelector,s.LP.endDate),isRoundTrip:this.createSelectorSetting(n?.isRoundTripSelector,s.LP.isRoundTrip),confirmationState:this.createSelectorSetting("",s.LP.confirmationState)};return this.isAtLeastOneSelectorPresent(c)?this.addExtractMultipleFlag(c,a):void 0}isAtLeastOneSelectorPresent(e){return!!e&&!!Object.values(e).find((e=>Boolean(e.selector)))}getExtractionSelectorsAutomated(e,t,o,a,i,r){if(!e?.details)return;const n={productQuantity:this.createSelectorSetting(e.details.productQuantity,s.fk.productQuantity),productNames:this.createSelectorSetting(e.details.productName,s.fk.productNames),productPrice:this.createSelectorSetting(e.details.productPrice,s.fk.productPrice),productSkus:this.createSelectorSetting(e?.details?.productId,s.fk.productSkus),productTitleFromImage:this.createSelectorSetting(e.details.getProductNamesFromImg,s.fk.productTitleFromImage),purchaseTotal:this.createSelectorSetting(e.details.orderTotalPrice,s.fk.purchaseTotal),orderSubTotal:this.createSelectorSetting(e.details.orderSubTotalPrice,s.fk.orderSubTotal),transactionId:this.createSelectorSetting(e.details.orderId,s.fk.transactionId),productSellers:this.createSelectorSetting("",s.fk.productSellers),productUrls:this.createSelectorSetting("",s.fk.productUrls),productBrands:this.createSelectorSetting("",s.fk.productBrands),productCategories:this.createSelectorSetting("",s.fk.productCategories),productImages:this.createSelectorSetting(e.details.productImgSelector,s.fk.productImages),startDate:this.createSelectorSetting("",s.LP.startDate),endDate:this.createSelectorSetting("",s.LP.endDate),isRoundTrip:this.createSelectorSetting("",s.LP.isRoundTrip),confirmationState:this.createSelectorSetting("",s.LP.confirmationState)};return this.adjustSelectors(n,o,a,i,r),this.addExtractMultipleFlag(n,t)}getCurrentUrlValue(e){const t=this.cashbackDao.getLastCommittedURL();return e?this.personalDataRemover.getCurrentUrlValue(e,t):t}createSelectorSetting(e,t,o="",a="",i=void 0,r=void 0){const n=r??this.selectorTimeouts,c={selector:e??"",timeout:this.GetTimeoutForSelector(t,i,n),keyName:t};return t===s.fk.productUrls&&(c.isLink=!0),t===s.fk.productImages&&(c.isImgUrl=!0),t===s.fk.productNames&&(c.shouldSplitSelector=!1),this.shouldUsePlainWait()&&(c.usePlainWait=!0),o&&!this.cashbackDao.getFeatureFlag("removeCartParentSelector",!1)&&(c.parentElementSelector=o),o&&(c.parentElementSelector=o),a&&(c.productElementSelector=a),c}addExtractMultipleFlag(e,t){const o=t===n.GV.ProductPage,a={productQuantity:!0,productNames:!o,productPrice:!0,purchaseTotal:!0,orderSubTotal:!0,transactionId:!1,productTitleFromImage:!0,productSkus:!0,productSellers:!0,productUrls:!0,productBrands:!o,productCategories:!o,productImages:!0,startDate:!0,endDate:!0,isRoundTrip:!1,confirmationState:!1};return Object.keys(e).forEach((t=>{if(a[t]&&e[t]){const o=a[t]??!1;e[t].shouldExtractAll=o}})),e}addOrUpdateProductInfoInCollection(e,t){if(e.ProductName)try{const t=this.readProductCollectionData()??[],o=t?.findIndex((t=>t.ProductName===e.ProductName));-1!==o?t[o]=e:(t.length>=100&&t.shift(),t.push(e)),this.saveProductCollectionData(t)}catch(o){this.logDebugOrErrorEvent("Couldn't add product to collection",!0,t,"",void 0,!0,{error:o,size:this.getObjectSize(e)})}}isValidPageUrl(e){return(e||this.getCurrentUrlValue(!1)).startsWith("http")}getLocalStorageKeyForProductCollection(){return B}logDebuggMesageToConsole(...e){}sendUetEvent(e,t){const o=this.cashbackDao.getImpressionId(),a=(0,d.SF)(e,t,this.cashbackDao.getCurrentDomain(),o);this.logger.LogInfoWithEvenType("ConfirmationPage UET Event",n.R.ConfirmationPageUetEvent,a,o)}cleanTravelData(e,t,o,a){if(!e)return;const i=(0,d.$3)(e.StartDate),r=(0,d.$3)(e.EndDate),n=(0,d.$3)(t);if(i.length>0){const t={startDate:i.join(this.scraperService.getSeparator())+this.scraperService.getSeparator(),endDate:r.join(this.scraperService.getSeparator())+this.scraperService.getSeparator(),name:n.join(this.scraperService.getSeparator())+this.scraperService.getSeparator()};e.FlightLegs=t}return(0,m.kO)(e.StartDate,e.EndDate,a)&&([e.StartDate,e.EndDate]=(0,m.Ox)(e.StartDate,e.EndDate,a)),e.StartDate=(0,m.Pf)(i[0]||e.StartDate,o),e.EndDate=(0,m.Pf)(r[0]||e.EndDate,o),void 0!==Object.values(e).find((e=>Boolean(e)))?e:void 0}removeTrailingSep(e){let t=e||"";const o=t.split(this.scraperService.getSeparator());return o.pop(),1===o.length&&(t=o[0]),t}sendWAPICartEvent(e,t,o=!1){const a=this.getProducts(e.Products),i=new g.d;i.IsCartEmpty=o,i.Domain=t,i.PageURL=location.pathname,i.CartValue=e.OrderTotal||e.OrderSubTotal||0,i.FCurrency=e.Currency,i.Products=a.map((e=>{const t=new g.H;return t.ProductTitle=e.productTitle,t.ProductPrice=e.productPrice,t.ProductQuantity=e.productQuantity,t.ProductUrl=e.productUrl,t})),p.Q.sendWAPICartData(i)}getProducts(e){try{return e?JSON.parse(e):[]}catch(e){return this.logDebuggMesageToConsole("Couldn't get products"),[]}}dispatchCartExtractionCompleteEvent(e,t,o){const a={isSuccessful:o===s._N.EXTRACTION_SUCCESSFULL||o===s._N.EXTRACTION_SUCCESSFULL_BUT_MISSING_FIELDS,isNewCart:o!==s._N.CACHED_CART_DATA_NOT_SENT,cartData:t,pageType:e,status:o},i=new CustomEvent(d.f5,{detail:a});window.dispatchEvent(i)}static OnCartCompletion(e){window.addEventListener(d.f5,(t=>{const o=t?.detail;e(o)}))}}},9442:function(e,t,o){var a=o(4872),i=o(1656),r=o(7776),n=o(2315);t.Z=class{Init(){const e=n.Z.getApiResponse();return i.R.isExperimentActive(a.H.showPaymentOptions)&&r.Z.GetAndSendExpressCheckoutPageGMV(e),Promise.resolve()}PostValidation(){return Promise.resolve()}}},2020:function(e,t,o){o.d(t,{EV:function(){return d},Vl:function(){return h},tM:function(){return u}});var a=o(4872),i=o(1656);const r=864e5;function n(e){try{return e.split(",").map((e=>parseInt(e)))}catch(e){return[]}}function s(e){try{return parseInt(e)}catch(e){return 0}}const c=[17],l=90;function d(){const e=i.R.getServiceExperimentValue(a.H.globalExpirableOrigins),t=i.R.getServiceExperimentValue(a.H.domainExpirableOrigins),o=i.R.getServiceExperimentValue(a.H.globalExpirationRate),r=i.R.getServiceExperimentValue(a.H.domainExpirationRate);return{globalExpirableOrigins:e?n(e):c,domainExpirableOrigins:t?n(t):c,globalExpirationRate:o?s(o):l,domainExpirationRate:r?s(r):l,curTime:i.R.isExperimentActive(a.H.mockCurrentTimeForExpiration)?parseInt(i.R.getServiceExperimentValue(a.H.mockCurrentTimeForExpiration)??"0"):Date.now()}}let u=function(e){return e.NoAutoOpenPrefDataItem="NoAutoOpenPrefDataItem",e.NoTimeLastAutoOpenInPrefData="NoTimeLastAutoOpenInPrefData",e.NoPopupOriginationInPrefData="NoPopupOriginationInPrefData",e.OriginNotAllowedToExpire="OriginNotAllowedToExpire",e.NotExpired="NotExpired",e.Expired="Expired",e}({});function h(e,t){if(!t)return u.NoAutoOpenPrefDataItem;if(!t.timeLastAutoOpen)return u.NoTimeLastAutoOpenInPrefData;if(!t.popupOrigination)return u.NoPopupOriginationInPrefData;let o=0;if(t.blockedForSite&&e.domainExpirableOrigins.indexOf(t.popupOrigination)>-1?o=e.domainExpirationRate:!t.blockedForSite&&e.globalExpirableOrigins.indexOf(t.popupOrigination)>-1&&(o=e.globalExpirationRate),!o)return u.OriginNotAllowedToExpire;const a=1+(t.reblockTimes?.length??0),i=t.timeLastAutoOpen+a*o*r;return e.curTime>=i?u.Expired:u.NotExpired}},5267:function(e,t,o){o.d(t,{$3:function(){return F},AS:function(){return C},Ae:function(){return P},C$:function(){return U},E:function(){return T},IL:function(){return R},Im:function(){return O},J8:function(){return Z},QF:function(){return k},RT:function(){return f},SF:function(){return M},Tb:function(){return v},_B:function(){return D},_e:function(){return m},dQ:function(){return _},eH:function(){return E},f5:function(){return u},gV:function(){return B},io:function(){return N},k1:function(){return h},ql:function(){return y},sB:function(){return I},uv:function(){return w},vU:function(){return g}});var a=o(2370),i=o(5144),r=o(3634),n=o(2265),s=o(6493),c=o(6577);function l(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,a)}return o}function d(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?l(Object(o),!0).forEach((function(t){(0,a.Z)(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):l(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}const u="CartExtractionCompleted",h="<SEP>",p=(e,t)=>{if(!e&&!t)return;if(!e||!t)return e||t;const o=d(d({},t),e),a=Object.keys(t);for(const e of a)if(o[e]&&"string"==typeof o[e]&&"string"==typeof t[e]&&o[e]!==t[e]){const a=o[e],i=t[e],r=new Set(a.split(",")),n=i.split(",").filter((e=>!r.has(e)));n.length>0&&(o[e]+=","+n.join(","))}return o},m=(e,t)=>{const o=p(e,t);if(o){const a=p(e.cartSelectors,t.cartSelectors),i=p(e.catalogSelectors,t.catalogSelectors),r=p(e.travelCheckoutSelectors,t.travelCheckoutSelectors);a&&(o.cartSelectors=a),i&&(o.catalogSelectors=i),r&&(o.travelCheckoutSelectors=r)}return o||t||e},g=(e,t)=>{const o=e.split(":")[1];return o&&t.includes(o)?v(o,t):""},C=(e,t)=>{try{const o=e.split(":")[1];if(!o)return"";const a=A(t),i=a?.pathname;if(!i)return"";const[n,s]=o.split(r.P5),c=i.split(n)[1];return s?c.split(s)[0]:c}catch(e){return""}},S=(e,t)=>{try{const o=new RegExp(e.toLowerCase());if(o){const e=t.toLowerCase().match(o),a=e?.groups&&e.groups.orderid||"";if(a)return a}}catch(e){}return""},f=(e,t)=>{try{if(!e||!t)return"";const o=S(e,t);if(o)return o;const a=e.replace("\\","\\\\");return S(a,t)}catch(e){return""}},v=(e,t)=>{const o=t.split("?");if(o.shift(),!o||0===o.length||!e)return"";for(const t of o){const o=new URLSearchParams(t);for(const t of o.entries())if(t[0].includes(e))return t[1]}return""},A=e=>{try{return new URL(e)}catch(e){return}},y=(e,t)=>{const o=e?.split(",")??[];for(let e of o)if(e.startsWith(r.$S)||e.startsWith(r.js)){const o=g(e,t);if(o)return o}else if(e.startsWith(r.m7)){const o=C(e,t);if(o)return o}return""},P=e=>e.startsWith(r.$S)||e.startsWith(r.m7)||e.startsWith(r.js),b=async(e,t,o,a)=>{const r=[];try{if(e.length>0&&t)for(const n of e)if(n.urlRegex){const e=N(t,n.urlRegex);if(r.push(e.errorMessage),e.isMatch){if(n.type!==i.u3.PurchaseConfirmed)return n.type===i.u3.Checkout?{pageType:i.GV.CheckoutPage,errorMessage:r.filter((e=>""!==e?.trim())).join("|")}:{pageType:i.GV.UnknownPage,errorMessage:r.filter((e=>""!==e?.trim())).join("|")};{if(!n.validationSelector)return{pageType:i.GV.ConfirmationPage,errorMessage:r.filter((e=>""!==e?.trim())).join("|")};if(await a(n.validationSelector,o))return{pageType:i.GV.ConfirmationPage,errorMessage:r.filter((e=>""!==e?.trim())).join("|")};const e=I(n);if(f(e,t))return{pageType:i.GV.ConfirmationPage,errorMessage:r.filter((e=>""!==e?.trim())).join("|")}}}}return{pageType:i.GV.UnknownPage,errorMessage:r.filter((e=>""!==e?.trim())).join("|")}}catch(e){return r.push(e.toString()),{pageType:i.GV.UnknownPage,errorMessage:r.filter((e=>""!==e?.trim())).join("|")}}},E=(e,t,o=[])=>{if(e?.checkoutPageRegex){const a=N(t,e.checkoutPageRegex);if(o.push(a.errorMessage),a.isMatch)return{pageType:i.GV.CheckoutPage,errorMessage:o.filter((e=>""!==e?.trim())).join("|")}}if(e?.checkoutPageUrl){const a=[...e.allCheckoutPages.filter((e=>e.pageType===i.GV.CheckoutPage||e.pageType===i.GV.NoInputCheckoutPage||!e.pageType)).map((e=>e.checkoutPageUrl)),...e.allFinalCheckoutPages.map((e=>e.checkoutPageUrl))].join(","),r=N(t,e.checkoutPageUrl,!0),n=N(t,a,!0);if(o.push(r.errorMessage),o.push(n.errorMessage),r.isMatch&&n.isMatch)return{pageType:i.GV.CheckoutPage,errorMessage:o.filter((e=>""!==e?.trim())).join("|")}}return{pageType:i.GV.UnknownPage,errorMessage:"",regexErrors:o}},T=async(e,t,o,a,r,n,s,c)=>{const l=_(e,t,r);if(l!==i.GV.UnknownPage)return{pageType:l,errorMessage:""};let u,h=!1;if(s){if(u=await b(o?.allAutomatedSelectors||[],e,h,c),u&&u.pageType!==i.GV.UnknownPage)return d(d({},u),{},{isFromAutomated:!0});h=!0}const p=await(async(e,t,o,a,r)=>{let n=[];if(e?.orderConfirmationPageUrl){const s=N(t,e.orderConfirmationPageUrl);if(n.push(s.errorMessage),s.isMatch&&(!o?.confirmationPageValidationSelector||await r(o.confirmationPageValidationSelector,a)))return{pageType:i.GV.ConfirmationPage,errorMessage:n.filter((e=>""!==e?.trim())).join("|")}}const s=E(e,t,n);if(s.pageType!==i.GV.UnknownPage)return s;if(s?.regexErrors&&(n=s.regexErrors),e?.productPageUrlRegex){const o=N(t,e.productPageUrlRegex);if(n.push(o.errorMessage),o.isMatch)return{pageType:i.GV.ProductPage,errorMessage:n.filter((e=>""!==e?.trim())).join("|")}}if(e?.productPageUrl){const o=N(t,e.productPageUrl,!0);if(n.push(o.errorMessage),o.isMatch)return{pageType:i.GV.ProductPage,errorMessage:n.filter((e=>""!==e?.trim())).join("|")}}if(e?.searchQueryUrlRegex){const o=N(t,e.searchQueryUrlRegex);if(n.push(o.errorMessage),o.isMatch)return{pageType:i.GV.SearchPage,errorMessage:n.filter((e=>""!==e?.trim())).join("|")}}return{pageType:i.GV.UnknownPage,errorMessage:n.filter((e=>""!==e?.trim())).join("|")}})(o,e,a,h,c);return p.pageType!==i.GV.UnknownPage&&p.pageType!==i.GV.HomePage?p:n?{pageType:i.GV.UnknownPage,errorMessage:p.errorMessage}:(u||(u=await b(o?.allAutomatedSelectors||[],e,!0,c)),d(d({},u),{},{isFromAutomated:!0}))},I=e=>O(e?.urlFields),O=e=>e?e[c.Fw.OrderId]??"":"",D=(e,t,o,a=!1)=>{if(e&&e.length>0&&t)for(const i of e)if(i.checkoutPageUrl&&(i.pageType===o||!i.pageType&&!a)&&N(t,i.checkoutPageUrl,!0).isMatch)return i},k=(e,t,o)=>{const a=[];if(e&&e.length>0)for(let i=0;i<e.length&&(!N(t,e[i].confirmationPageUrl||"",!0).isMatch||(a.push(e[i]),!o));i++);return a},R=(e,t,o,a=!1)=>{try{if(t.length>0&&o){const r=(e=>{switch(e){case i.GV.CheckoutPage:return i.u3.Checkout;case i.GV.ConfirmationPage:return i.u3.PurchaseConfirmed}})(e);for(const e of t)if(e.urlRegex&&(e.type===r||!e.type&&!a)&&N(o,e.urlRegex).isMatch)return e}return}catch(e){return}},w=(e,t)=>e.split(",").filter((e=>t?P(e):!P(e))).join(","),N=(e,t,o=!1)=>{if(!e||!t)return{isMatch:!1,errorMessage:""};t="("+t+")",o&&(t=t.replace(/[,]+/g,"|"));const a=x(e,t);return a.errorMessage?x(e,t.replace(/[\\]+/g,"")):a},x=(e,t)=>{try{return{isMatch:new RegExp(t.toLowerCase()).test(e.toLowerCase()),errorMessage:""}}catch(e){return{isMatch:!1,errorMessage:e.toString()}}},_=(e,t,o)=>U(e,t,o)?i.GV.HomePage:i.GV.UnknownPage,U=(e,t,o)=>{if(e&&t){const a=e.endsWith(t)||e.endsWith(`${t}/`);if(a)return a;if(o)return e.endsWith(`${t}/${o}`)||e.endsWith(`${t}/${o}/`)}return!1},B=e=>!e||![i.GV.HomePage,i.GV.SearchPage,i.GV.ProductPage].includes(e),M=(e,t,o,a)=>{let i="",r="";const n=document.querySelectorAll('[id^="batBeacon"] > img');if(n)for(const e of n)if(e?.currentSrc){const t=new URL(e.currentSrc),o=t?.searchParams.get("mid"),a=t?.searchParams.get("ti");o&&a&&(i+=o+",",r+=a+",")}return i=i.length>0?i.substring(0,i.length-1):"",r=r.length>0?r.substring(0,r.length-1):"",{Domain:o,EventId:e,ImpressionId:a,Mid:i,PageType:t,TagId:r}},L=(e,t,o,a)=>a.length===e&&o<a.length?a[o]:t,F=(e,t)=>{const o=e?.split(h)||[];return o.pop(),void 0===t||o.length===t?o:[]},Z=(e,t)=>{const o=[];return e=((e,t)=>{const o=(e=>{const t=F(e.ProductNames),o=t.length;return{productNames:t,productPrice:F(e.PricePerItem,o),productUrls:F(e.ProductUrls,o),productImages:F(e.ProductImg,o),productQuantity:F(e.QuantityPerItem,o),productSellers:F(e.ProductSellers,o),productBrands:F(e.ProductBrandNames,o),productSkus:F(e.ProductIds,o),productCategories:F(e.ProductCategoryListNames,o),transactionId:[],purchaseTotal:[],orderSubTotal:[],productTitleFromImage:[]}})(e);if(0===t.length&&(t=o.productNames.map((e=>({productNames:e})))),o[n.fk.productNames].length!==t.length&&0!==t.length)return t;const a=Object.keys(n.fk),i=a.filter((e=>void 0!==t.find((t=>!!t[e]))));return t=t.map(((e,r)=>{for(const n of a)if(!i.includes(n)){const a=e[n],i=L(t.length,a,r,o[n]);void 0!==i&&(e[n]=i)}return e}))})(t,e),e.forEach((e=>{(e.productNames||e.productTitleFromImage)&&(e.productNames=e.productNames||e.productTitleFromImage),o.push(((e,t)=>{const o={};return Object.keys(e).forEach((a=>{let i=e[a];a===n.fk.productPrice?i=(0,s.UK)(i,t):a===n.fk.productQuantity&&(i=parseInt(G(i)||"0")),n.uy[a]?o[n.uy[a]]=i:o[a]=i})),o})(e,t.Currency))})),o},G=e=>e.replace(/[^\d.]/g,"")},4875:function(e,t,o){o.d(t,{H:function(){return p},w:function(){return h}});var a=o(4872),i=o(1656),r=o(5144),n=o(5683),s=o(7689),c=o(8025),l=o(6790),d=o(25),u=o(4899);let h=!1;function p(e){if(!i.R.isExperimentActive(a.H.purchaseConfirmation))return;const t=n.Wf.POST_PURCHASE,o=l.b.getLocalizedStringForServerButtonText(t,[]);if(!o)return;const p=[n.SG.SERVER_BUTTON_TEXT.toString(),3e3.toString(),.3.toString(),(!0).toString(),"-1",(!0).toString(),t.toString(),o];c.Q.sendMessage(d.EI.AnimateTextInOmnibox,p),h=!0;const m={Domain:(0,s.S8)(),PageUrl:(0,s.Ek)()};(0,u.S)(m,r.R.ConfirmationPageValidation,"Omnibox purchase confirmation shown",r.in.Information,e)}},9368:function(e,t,o){o.d(t,{Ox:function(){return r},Pf:function(){return a},kO:function(){return i}});const a=(e,t)=>{if(!e)return"";if(!t)return e;try{const o=new RegExp(t),a=e.match(o);return a?a[1]:e}catch(t){return e}},i=(e,t,o)=>{if(!e||!t||!o)return!1;if(e!==t)return!1;try{const t=new RegExp(o,"u"),a=e.match(t);return!!(a&&a.length>2)}catch(e){return!1}},r=(e,t,o)=>{const a=new RegExp(o,"u"),i=e.match(a);return i&&i.length>2?[i[1].trim(),i[2].trim()]:[e,t]}},1849:function(e,t,o){var a=o(9247),i=o(6493),r=o(2056);class n{static async WaitAndGetCartValue(e,t,o){const r=e;let s={OrderTotal:-1,Currency:(0,i.N6)(t)??"$",PageCurrency:""};return a.ZP.IsValidDataField(r)&&(s=await a.ZP.WaitForCondition((async()=>n.GetCartValue(r,t)?.OrderTotal>0),o??1e4).then((()=>n.GetCartValue(r,t))).catch((()=>s))),s}static async WaitAndGetCartValue2(e,t,o){let r={OrderTotal:-1,Currency:(0,i.N6)(t)??"$",PageCurrency:""};return a.ZP.IsValidDataField(e)&&(r=await a.ZP.WaitForCondition((async()=>n.TrySimpleGetCartValue(e,t)?.OrderTotal>0),o??1e4).then((()=>n.TrySimpleGetCartValue(e,t))).catch((()=>r))),r}static TrySimpleGetCartValue(e,t){const o=document.querySelector(e);let a=-1,r=(0,i.N6)(t)??"$";const n=o?.textContent??"";a=(0,i.K)(n,r);const s=(0,i.cU)(n,!0);return r=(0,i.Cl)(s,t),{OrderTotal:a,Currency:r,PageCurrency:s}}static GetCartValue(e,t){let o=-1,a=(0,i.N6)(t)??"$";const n=r.Z.GetOrderTotalString(e);o=(0,i.K)(n)??-1;const s=(0,i.cU)(n,!0);return a=(0,i.Cl)(s,t),{OrderTotal:o,Currency:a,PageCurrency:s}}}t.Z=n},2056:function(e,t,o){var a=o(4865),i=o(815),r=o(5144),n=o(9088),s=o(9247),c=o(1544),l=o(7689),d=o(9448),u=o(9249),h=o(66),p=o(1024),m=o(9206),g=o(1775),C=o(2820),S=o(1656);class f{static GetBoxValue(e){if(s.ZP.IsValidDataField(e))try{const t=f.GetTextValue(e);return t?t.trim():t}catch(e){throw Error(e.message)}return""}static ParseBackgroundAutoApplyStateData(e){const t=f.GetBackgroundAutoApplyStateString(e);return(0,a.TF)(t)?null:u.Z.CreateFromObject(JSON.parse(t))}static GetBackgroundAutoApplyStateString(e){const t=p.Z.GetBackgroundAAKeyName();return"string"==typeof e[t]?e[t]:e[t]?.value}static parseDate(e){const t=e?.split(",");let o,a="";if(1===t?.length){const i=(new Date).getDate(),r=new Date;if(r.setHours(0,0,0,0),r.setDate(i+1),o=r,a=t[0].trim().split("-")[1],!a)throw new Error(`Unable to parse date: ${e}`)}else if(2===t?.length){const e=t[1].trim(),a=t[0].trim().split("Â "),i=a[1].trim(),r=a[0].trim();o=new Date(`${i} ${r} ${e}`)}else if(3===t?.length){if(t[0].toLowerCase().includes("today"))o=new Date,o.setHours(0,0,0,0);else{const e=(new Date).getFullYear(),a=t[1].trim().split(" "),i=a[1].trim(),r=a[0].trim();o=new Date(`${r} ${i}, ${e}`)}if(a=t[2].trim().split("-")[1],!a)throw new Error(`Unable to parse date: ${e}`)}else o=new Date("");if(!a)return o;try{const e=this.parseHour(a);if(Number.isNaN(e))return o;o.setHours(e)}catch(e){}return o}static parseHour(e){let t=+e?.match(/\d{1,2}/i)[0];const o=e?.match(/(A|P)M/i)[0];return"pm"===o.toLowerCase()&&(t+=12),+t}static SendLogEvent(e,t,o,a,i,n,s,c,d,u){const h={Currency:i,Domain:c??(0,l.S8)(),EdgeFlyoutStatus:s?.EdgeFlyoutStatus,Metadata:s?.Metadata,PageUrl:(0,l.Ek)(),StartingPrice:a??-1,Status:o,AutoApplyValidationReason:d,CheckoutValidationMetadata:JSON.stringify(u)};f.SendLogEventMessage(h,n??r.R.CheckoutPageValidation,e,t,r.in.Information)}static SendLogEventMessage(e,t,o,a,r){const s={};if(s.JsonData=JSON.stringify(e),s.EventType=t,s.LogLevel=r,s.Message=a,s.ClientContext=new i.Z(c.Z.GetClientName(),n.W1,c.Z.GetBuildVersion(),c.Z.enabledServiceFlights,S.R.GetServiceExperiments()),o&&(s.ImpressionId=o),(0,g.st)(s,e,C.Z.GetLocalDataService().GetLogBlockConfig()))return;const l=[JSON.stringify(s)];f.SendMessage(d.H.LogScriptTelemetry,l)}static SendMessage(e,t){m.f.postMessageToHost(e,t)}static AddOnClickEventWithCallback(e,t=!0){const o=()=>{e(),t&&document.body.removeEventListener("click",o)};document.body.addEventListener("click",o)}static StartEdgeDriver(e,t){this.Invoke(d.H.StartEdgeDriver,e,t)}static SendStorageMessage(e,t){f.SendMessage(d.H.SetStorageValue,[e,t])}static DeleteKeyFromPersistentStorage(e){f.SendStorageMessage(e,JSON.stringify({value:null}))}static SendNavigateToUrlMessage(e){f.SendMessage(d.H.NavigateToUrlBackground,[e,e])}static SendStringStorageMessage(e,t){f.SendMessage(d.H.SetStorageValue,[e,JSON.stringify({value:t})])}static SendNumberStorageMessage(e,t){f.SendMessage(d.H.SetStorageValue,[e,JSON.stringify({value:t})])}static SendBooleanStorageMessage(e,t){f.SendMessage(d.H.SetStorageValue,[e,JSON.stringify({value:t})])}static SendPurchaseConfirmationLog(e,t,o,a,i,n){const s={CartId:i,Currency:n?.Currency,Domain:e,PageCurrency:n?.PageCurrency,PageUrl:(0,l.Ek)(),StartingPrice:n?.OrderTotal??-1,Status:a};f.SendLogEventMessage(s,r.R.PurchaseConfirmation,t,o,r.in.Information)}static GetValidationLogMessage(e,t,o){return e?"Checkout Page is Valid":t?"Checkout Page is disabled or does not exist":o?"Checkout Page is Invalid - Invalid Selectors":"Checkout Page is Invalid"}static GetOrderTotalString(e,t){if(!s.ZP.IsValidDataField(e))return"";const o=e.split(",");for(let e=0;e<o.length;e++){const a=o[e];try{const e=f.GetBoxValuePageQueryUtils(a,t);if(e&&e.match(/[0-9]/))return e}catch(t){if(e===o.length-1)return""}}return""}static IsValidPDPUrlHeuristic(e,t=""){return!(0,a.TF)(e)&&e.includes(t)&&e.includes("/")&&!e.endsWith("#")&&!["help","credit","conditions","privacy","terms","about","faq","returns","careers","account"].some((t=>e.includes(t)))}static Invoke(e,...t){m.f.postMessageToHost("Invoke",[e,...t])}static GetBoxValuePageQueryUtils(e,t){if(s.ZP.IsValidDataField(e))try{return h.Z.GetTextValue(e,t)}catch(e){throw Error(e.message)}return""}static GetTextValue(e){const t=e.split(";"),o=h.Z.GetFirstVisibleElement(t[0]);let a=o;if(void 0===a)return"";let i=a.innerText;if(1===t.length)a=h.Z.NormalizeIfSuperscripted(o),i=a.innerText;else{const e=h.Z.GetFirstVisibleElement(t[1]);if(e&&e.innerText){const t="."+e.innerText;if(a.contains(e)){const e=a.cloneNode(!0);e.childNodes.forEach((t=>{t.nodeType===Node.ELEMENT_NODE&&e.removeChild(t)})),i=e?.innerText?e.innerText:i}i+=t}}return h.Z.StripInvalidJSONCharacters(i)}}t.Z=f},2820:function(e,t,o){o.d(t,{Z:function(){return qe}});var a=o(2370),i=o(3825),r=o(9567),n=o(7778),s=o(9518),c=o(8574),l=o(529),d=o(3873),u=o(2960),h=o(5144),p=o(9247),m=o(6493),g=o(3491),C=o(7900),S=o(3686),f=o(4440),v=o(2056);function A(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,a)}return o}function y(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?A(Object(o),!0).forEach((function(t){(0,a.Z)(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):A(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}var P=class{constructor(e){(0,a.Z)(this,"webAssistQueryService",void 0),this.webAssistQueryService=e}async TryCollectCartInformation(e,t,o,a,i,r){try{await this.CollectCartInformation(e,t,o,a,i,r)}catch(t){const o={cartId:r??"",cartUrl:location.pathname,domain:e};this.LogCartExtractionEvent(o,h.R.CartExtraction,t?.message,h.in.Error,a)}}async CollectCartInformation(e,t,o,a,i,r){const n=new S.Z;n.domain=e,n.cartValue=t.OrderTotal,n.currency=t.Currency,n.cartUrl=location.pathname,n.cartId=r??u.Z.uuidv4(),n.products=[];let s,c=0,l=null,d=null;if(await(0,p.dz)((async()=>(s=document.querySelectorAll("img"),void 0!==s&&s.length>0)),5e3),await(0,p._R)(1e4),s=document.querySelectorAll("img"),void 0===s||s.length<=0){const e="Unable to automatically find products in cart";this.LogCartExtractionEvent(n,h.R.CartExtractionError,e,h.in.Error,a)}else{for(const t of s){if(!this.isVisible(t))continue;if(this.isAtTopOfPage(t))continue;if(0===c&&!this.isInViewPort(t))continue;const o=this.findProductContainer(t);if(0===c&&t.offsetHeight>0){const a=this.isPotentialCartItem(t,o,e);if(!a||!o)continue;c=t.offsetHeight,l=o,n.products.push(a)}else if(c===t.offsetHeight){const a=this.isPotentialCartItem(t,o,e);if(!a||!o)continue;if(null==d){if(!l)continue;if(d=this.getCommonParent(l,o),null==d)continue}const i=Node.DOCUMENT_POSITION_CONTAINED_BY;if(!(d.compareDocumentPosition(o)&i))continue;n.products.push(a)}}if(await this.augmentWithWebAssist(n.products,e,i),n.products=[],n.products?.length>0){const e="Successfully automatically extracted Cart Information";this.LogCartExtractionEvent(n,h.R.CartExtraction,e,h.in.Information,a),this.StoreCartInfoInLocalStorage(n,t)}else{const o=this.scrapeCandidateUrls(e),r=await this.generateWebassistProducts(o,i);if(r?.length>0){n.products=r;const e="Successfully automatically extracted Cart Information via webassist scraping";this.LogCartExtractionEvent(n,h.R.CartExtraction,e,h.in.Information,a),this.StoreCartInfoInLocalStorage(n,t)}else{const e="Unable to automatically get enough info about products in cart";this.LogCartExtractionEvent(n,h.R.CartExtractionError,e,h.in.Error,a)}}}}async augmentWithWebAssist(e,t,o){if(!e||0===e.length)return;const a=e.map((e=>this.normalizeUrl(e.productUrl,t))),i=await this.webAssistQueryService.QueryWebAssistUrls(o,a);i&&e.forEach((e=>{if(e?.productUrl){const o=this.normalizeUrl(e.productUrl,t);if(this.HasValidWebAssistEntry(i,o)){const t=i[o];t.entity&&this.AugmentProductWithWebAssistProduct(e,t)}}}))}normalizeUrl(e,t){return e?e.startsWith("http")?e:`https://www.${t}${e}`:""}isVisible(e){return e.offsetHeight>0&&e.offsetWidth>0&&"hidden"!==e.style.visibility&&"none"!==e.style.display}isAtTopOfPage(e){return window.pageYOffset+(e.getBoundingClientRect()?.top??0)<200}isInViewPort(e){const t=e.getBoundingClientRect(),o=t.left,a=t.top;return!0===document.elementFromPoint(o,a)?.isSameNode(e)}isPotentialCartItem(e,t,o){if(null==t)return null;const a=t.tagName.toLocaleLowerCase();if("html"===a||"body"===a)return null;const i=[...t.querySelectorAll("a")].filter((e=>v.Z.IsValidPDPUrlHeuristic(e.href,o)));if(i.length<=0)return null;const r=i[0],n=r.href,s=new f.Z;s.productUrl=n;let c=r.innerText??r.getAttribute("title");if(""===c&&i.length>1)for(let e=1;e<i.length&&""===c;e++)c=i[e].innerText??i[e].getAttribute("title");""===c&&(c=e.getAttribute("title")??e.getAttribute("alt")??""),s.productTitle=c,s.productImg=e.getAttribute("src")??"";const l=this.GetPrices(t);return l?.length&&(s.productPrice=this.GetMinimumPrice(l)),s}GetMinimumPrice(e){const t=(0,m.cU)(e[0]);return Math.min(...e.map((e=>parseFloat(e.replace(t,"").replace(/,/g,"")))))}findProductContainer(e){let t=e.parentElement;for(;null!=t&&"BODY"!==t.nodeName;){const e=this.GetPrices(t);if(e?.length&&t.querySelector("a"))return t;t=t.parentElement}return null}GetPrices(e){const t=(0,m.cU)(e.innerText);if(t&&(0,m.$g)(t)){const o=new RegExp("("+(0,m.So)(t)+"[0-9,]+(?:.[0-9]{1,2}){0,1})","g");return e.innerText.match(o)}return[]}getCommonParent(e,t){let o=e.parentElement;if(e===t)return o;if(null==o)return null;const a=Node.DOCUMENT_POSITION_CONTAINED_BY;let i=o.compareDocumentPosition(t);for(;!(i&a);){if(o=o.parentElement,null==o)return null;i=o.compareDocumentPosition(t)}const r=o.tagName.toLocaleLowerCase();return"html"===r||"body"===r?null:o}HasValidWebAssistEntry(e,t){return e.hasOwnProperty(t)}AugmentProductWithWebAssistProduct(e,t){const o=t.entity;e.foundInWebAssist=!0,e.webAssistTitle=t.title??o.name,e.webAssistImg=o.image;const a=this.CleanWebAssistPrice(o.price_value);a&&(e.webAssistPrice=a)}scrapeCandidateUrls(e){const t=Array.from(document.querySelectorAll("a")).filter((e=>e.href&&""!==e.href&&"#"!==e.href)).filter((e=>!this.isAtTopOfPage(e))).map((e=>e.href)).filter((t=>v.Z.IsValidPDPUrlHeuristic(t,e)));return[...new Set(t)]}async generateWebassistProducts(e,t){const o=await this.webAssistQueryService.QueryWebAssistUrls(t,e),a=[];if(o)for(const e in o)if(o[e].entity){const t=new f.Z;t.productUrl=e,this.AugmentProductWithWebAssistProduct(t,o[e]),a.push(t)}return a}LogCartExtractionEvent(e,t,o,a,i){const r=qe.GetLocalDataService(),n=r.GetSessionIds()?.retailerSessionId??"",s=r.GetSessionIds()?.pageVisitId??"";e=y(y({},e),{},{PageVisitId:s,RetailerSessionId:n}),v.Z.SendLogEventMessage(e,t,i,o,a)}StoreCartInfoInLocalStorage(e,t){const o=new C.Vr;o.OrderTotal=t.OrderTotal,o.CartDataCreationTime=Date.now(),o.CartId=e.cartId,(0,g.Xo)(C.OY,JSON.stringify(o))}CleanWebAssistPrice(e){if(e)try{const t=(e=e.replace(/\s/g,"")).split("-");return(0,m.K)(t[0])}catch(e){}}},b=o(9088),E=o(1544),T=o(7689),I=o(9315),O=o(66),D=class{isCancellationPageValid(e){return!(!e.cancellationPageTelemetry?.cancellationPageUrlRegex||""===e.cancellationPageTelemetry.cancellationPageUrlRegex)&&new RegExp(e.cancellationPageTelemetry.cancellationPageUrlRegex,"i").test((0,T.Ek)())}GetAndSendCancellationPageData(e,t){let o="";e?.cancellationPageTelemetry?.transactionIdSelector&&""!==e?.cancellationPageTelemetry?.transactionIdSelector&&(o=v.Z.GetBoxValue(e.cancellationPageTelemetry.transactionIdSelector));let a="";e?.cancellationPageTelemetry?.totalPriceSelector&&""!==e?.cancellationPageTelemetry?.totalPriceSelector&&(a=v.Z.GetBoxValue(e.cancellationPageTelemetry.totalPriceSelector));let i="";e?.cancellationPageTelemetry?.cancellationTextSelector&&""!==e?.cancellationPageTelemetry?.cancellationTextSelector&&(i=v.Z.GetBoxValue(e.cancellationPageTelemetry.cancellationTextSelector));let r="",n="";if(e?.cancellationPageTelemetry?.productTitleSelector&&""!==e?.cancellationPageTelemetry?.productTitleSelector){const t=O.Z.RunQuerySelectorAll(e?.cancellationPageTelemetry?.productTitleSelector);if(t.length>0)for(const e of t)e&&e.textContent&&(r+=e.textContent?.trim()+"<SEP>")}let s="";if(e?.cancellationPageTelemetry?.pricePerItemSelector&&""!==e?.cancellationPageTelemetry?.pricePerItemSelector){const t=O.Z.RunQuerySelectorAll(e?.cancellationPageTelemetry?.pricePerItemSelector);if(t.length>0)for(const e of t)e&&e.textContent&&(s+=e.textContent?.trim()+"<SEP>")}if(e?.cancellationPageTelemetry?.productQuantitySelector&&""!==e?.cancellationPageTelemetry?.productQuantitySelector){const t=O.Z.RunQuerySelectorAll(e?.cancellationPageTelemetry?.productQuantitySelector);if(t.length>0)for(const e of t)e&&e.textContent&&(n+=e.textContent?.trim()+"<SEP>")}const c={CancellationPageUrl:(0,T.Ek)(),Domain:(0,T.S8)(),TransactionId:o,CancellationPageText:i,ProductNames:r,QuantityPerItem:n,PricePerItem:s,TotalPrice:a},l={};l.JsonData=JSON.stringify(c),l.EventType="CancellationPageDetails",l.LogLevel="Information",l.Message="Cancellation Page Details",l.ClientContext={AppInfoClientName:E.Z.GetClientName(),JSVersion:b.yJ},t&&(l.ImpressionId=t);const d=[JSON.stringify(l)];I.R.postMessageToHost("LogScriptTelemetry",d)}},k=o(7664),R=o(4993),w=o(9206),N=o(3769),x=o(7944),_=o(1495),U=o(8025),B=o(1501),M=o(5267),L=o(4872),F=o(1656);function Z(){return F.R.isExperimentActive(L.H.collectAllFragments)}var G=class{constructor(){(0,a.Z)(this,"IsBatBeaconFound",!1),(0,a.Z)(this,"DISALLOWED_NAMES",new Set(["addr","city","cell","dob","email","data-gtm","mob","phone","secret","social","ssn","tel","zip","pass","payment","cvv","ccv"]))}GetPageType(e,t,o){if(F.R.isExperimentActive(L.H.disablePageTypeCollectionForFragments))return h.GV.UnknownPage;const a=(0,M.dQ)(t,o,e?.aFDMarket??"");if(a!==h.GV.UnknownPage)return a;const i=((e,t)=>e?.orderConfirmationPageUrl&&(0,M.io)(t,e.orderConfirmationPageUrl).isMatch?h.GV.ConfirmationPage:e?.checkoutPageUrl&&(0,M.io)(t,e.checkoutPageUrl,!0).isMatch?h.GV.CheckoutPage:e?.productPageUrlRegex&&(0,M.io)(t,e.productPageUrlRegex).isMatch||e?.productPageUrl&&(0,M.io)(t,e.productPageUrl,!0).isMatch?h.GV.ProductPage:e?.searchQueryUrlRegex&&(0,M.io)(t,e.searchQueryUrlRegex).isMatch?h.GV.SearchPage:h.GV.UnknownPage)(e?.retailerData,t);return i!==h.GV.UnknownPage&&i!==h.GV.HomePage?i:((e,t)=>{try{if(e.length>0&&t)for(const o of e)if(o.urlRegex&&(0,M.io)(t,o.urlRegex).isMatch)return o.type===h.u3.PurchaseConfirmed?h.GV.ConfirmationPage:o.type===h.u3.Checkout?h.GV.CheckoutPage:h.GV.UnknownPage;return h.GV.UnknownPage}catch(e){return h.GV.UnknownPage}})(e?.retailerData?.allAutomatedSelectors||[],t)}IsCollectionAllowed(e){return"en-us"!==e||this.isPrivacyBadgeShown()}isPrivacyBadgeShown(){return!!_.Q?.PrivacyBadgeViewCount&&parseInt(_.Q.PrivacyBadgeViewCount,10)>=2}CollectFragment(e){const t=Z();if((e.retailerData?.isAOCFragmentCollectionEnabled||t)&&(0,T.Ek)()?.startsWith("https:")&&this.IsCollectionAllowed(e?.aFDMarket)){const o=(0,T.Ek)(),a=t?"1":e.retailerData?.aOCFragmentCollectionRate??"0",i=Math.random();if(a&&i<parseFloat(a)){const t=e.retailerData?.domainName||(0,T.uE)(window.location.hostname),i=this.GetPageType(e,o,t),r=F.R.isExperimentActive(L.H.fragmentPageTypeFiltering),n=!r||r&&(0,M.gV)(i),s=qe.GetLocalDataService(),c=s.GetSessionIds()?.retailerSessionId??"",l=s.GetSessionIds()?.pageVisitId??"",d=this.getPiiRemovalSelector(e.retailerData,i,(0,T.Ek)());if(n){const o=new B.Z(e?.retailerData?.settings).GetFragmentCollectionTimeout(i)??0;"complete"===document.readyState?setTimeout((async()=>{this.sendHtmlFragment(t,"",a,i,e?.impressionId??"",c,l,"",!1,d)}),o):document.onreadystatechange=()=>{"complete"===document.readyState&&setTimeout((async()=>{this.sendHtmlFragment(t,"",a,i,e?.impressionId??"",c,l,"",!1,d)}),o)}}}}}async CollectFragmentOnConfirmationPage(e,t,o,a=!0){try{const i=(0,T.Ek)();if(!i?.startsWith("https:")||!this.IsCollectionAllowed(t))return;const r=h.GV.ConfirmationPage,n=new B.Z(e?.retailerData?.settings),s=Z()?1:n.GetCollectionRate(i,r,a)??0;if(0===s||Math.random()>=s)return;const c=qe.GetLocalDataService(),l=c.GetSessionIds()?.retailerSessionId??"",d=c.GetSessionIds()?.pageVisitId??"",u=e?.retailerData?.domainName||(0,T.uE)(window.location.hostname),p=e?.retailerData?.confirmationPageTelemetry?.piiRemovalSelector??"";await this.sendHtmlFragment(u,"",`${s}`,r,e.impressionId,l,d,o,!0,p)}catch(e){}}async sendHtmlFragment(e,t,o,a,i,r,n,s="",c=!1,l=""){let d=-1,u=null;if(c){u=this.cloneNodeWithPlaceholders(document.documentElement,!1,performance.now());const t=performance.now();this.MaskPiiData(u,e),d=performance.now()-t}else{const e=performance.now();u=this.cloneNodeWithPlaceholders(document.documentElement,!1,performance.now()),this.IsBatBeaconFound=!1,d=performance.now()-e}const p={Domain:e,TimeToMask:d.toString(),PageType:a,PageUrl:(0,T.Ek)(),EncryptionKey:"",HtmlFragment:"",aOCFragmentCollectionRate:o,RetailerSessionId:r,PageVisitId:n,isConfirmationPage:`${c}`};if(!u)return;if(this.maskDataInADocumentBySelector(u,l),t){const e=await this.getSymmetricEncryptionKey(),o=await this.encryptData(e,u.outerHTML),a=await this.encryptSymmetricKey(t,e);p.EncryptionKey=a,p.HtmlFragment=o}else p.HtmlFragment=btoa(encodeURIComponent(u.outerHTML));if(!p.HtmlFragment)return;let m=c?"[Confirmation] Html Fragment collection":"[AOC] Html Fragment collection";s&&(m=`${m}; ${s}`),c?this.sendConfirmationPageLog(p,m):U.Q.sendLogEventMessageV2(p,h.R.HtmlFragment,i,m,h.in.Information)}sendConfirmationPageLog(e,t,o=!1){const a={};a.JsonData=JSON.stringify(e),a.EventType="HtmlFragment",a.LogLevel=o?"Error":"Information",a.Message=t,a.ClientContext={AppInfoClientName:E.Z.GetClientName(),JSVersion:b.yJ};const i=[JSON.stringify(a)];I.R.postMessageToHost("LogScriptTelemetryV2",i)}MaskPiiData(e,t){const o=e?.getElementsByTagName("*"),a=new Set(["script"]),i=performance.now();try{for(let e=0;e<=o?.length;e++){let r=!1;const n=performance.now();if(n-i>3e5)return void this.sendConfirmationPageHtmlFragmentLogError(window.location.pathname,t,"Masking timeout",(n-i).toString());if(void 0!==o[e]&&null!==o[e]&&null!==o[e].textContent){const t=o[e];if("yes"===t.getAttribute("data-processed"))continue;const i=t.getAttribute("name");(a.has(t.tagName?.toLowerCase())||i&&this.DISALLOWED_NAMES.has(i))&&(this.maskTextNodes(t),r=!0);const n=t.getAttributeNames();for(const e of n)for(const o of this.DISALLOWED_NAMES)if(t.getAttribute(e)?.toLowerCase()?.includes(o)){r||(this.maskTextNodes(t),r=!0),t.setAttribute("value","****");break}t.setAttribute("data-processed","yes")}}}catch(e){this.sendConfirmationPageHtmlFragmentLogError(window.location.pathname,t,"Masking error: "+e,(performance.now()-i).toString())}return!0}maskTextNodes(e){if(e&&"yes"!==e.getAttribute("data-processed")){"SCRIPT"===e.tagName?.toLocaleUpperCase()&&(e.textContent="Mask script content");for(const t of e.children)3===t.nodeType||4===t.nodeType?t.textContent="Masked":this.maskTextNodes(t),t.setAttribute("data-processed","yes");e.setAttribute("data-processed","yes")}}cloneNodeWithPlaceholders(e,t,o){if(performance.now()-o>12e4)return null;if("SCRIPT"===e.tagName?.toLocaleUpperCase())return null;if(e.nodeType===Node.TEXT_NODE){const o=e.cloneNode(!1);return t&&(o.textContent="*****"),o}if(e.nodeType===Node.ELEMENT_NODE){if("hidden"===window.getComputedStyle(e).visibility)return null;if(!this.IsBatBeaconFound){const t=e.getAttribute("id");if(t&&t.startsWith("batBeacon"))return null;this.IsBatBeaconFound=!0}const t=e.cloneNode(!1);let a=!1;const i=e.getAttributeNames();for(const t of i){if(this.DISALLOWED_NAMES.has(t.toLowerCase())){a=!0;break}for(const o of this.DISALLOWED_NAMES)if(e.getAttribute(t)?.toLowerCase()?.includes(o)){a=!0;break}if(a)break}for(const i of e.childNodes){const e=this.cloneNodeWithPlaceholders(i,a,o);e&&t.appendChild(e)}return t}return null}async getSymmetricEncryptionKey(){const e=await window.crypto.subtle.generateKey({name:"AES-GCM",length:128},!0,["encrypt","decrypt"]),t=await window.crypto.subtle.exportKey("raw",e);return this.bufferToBase64(t)}bufferToBase64(e){return window.btoa(String.fromCharCode(...new Uint8Array(e)))}base64ToBuffer(e){const t=window.atob(e),o=t.length,a=new Uint8Array(o);for(let e=0;e<o;e++)a[e]=t.charCodeAt(e);return a.buffer}concatArrayBuffers(e,t){const o=new Uint8Array(e.byteLength+t.byteLength);return o.set(new Uint8Array(e),0),o.set(new Uint8Array(t),e.byteLength),o.buffer}async encryptData(e,t){const o=(new TextEncoder).encode(t),a=await window.crypto.subtle.importKey("raw",this.base64ToBuffer(e),"AES-GCM",!0,["encrypt","decrypt"]),i=window.crypto.getRandomValues(new Uint8Array(12)),r={iv:i,name:"AES-GCM"},n=await window.crypto.subtle.encrypt(r,a,o),s=this.concatArrayBuffers(i.buffer,n);return this.bufferToBase64(s)}async encryptSymmetricKey(e,t){const o=await crypto.subtle.importKey("spki",this.base64ToBuffer(e),{name:"RSA-OAEP",hash:{name:"SHA-256"}},!1,["encrypt"]),a=await crypto.subtle.encrypt({name:"RSA-OAEP"},o,(new TextEncoder).encode(t));return this.bufferToBase64(a)}sendConfirmationPageHtmlFragmentLogError(e,t,o,a){const i={Domain:t,EncryptionKey:"",HtmlFragment:"",OrderConfirmationPageUrl:e,TimeToMask:a};this.sendConfirmationPageLog(i,o,!0)}maskDataInADocumentBySelector(e,t){if(e&&t)try{const o=e.querySelectorAll(t);if(o&&o.length>0)for(const e of o){const t=e.textContent;t&&(e.textContent="*".repeat(t.length))}}catch(e){}}getPiiRemovalSelector(e,t,o){let a="";if(!e||!o||!t)return a;if(t===h.GV.ConfirmationPage&&(a=e?.confirmationPageTelemetry?.piiRemovalSelector??""),""===a){const i=(0,M._B)(e?.allCheckoutPages,o,t);a=i?.piiRemovalSelector??""}return a}};let H=function(e){return e.Quotient="q",e.Ibotta="i",e.Self="s",e.FirstParty="1p",e.SPB="spb",e.Unknown="unknown",e}({});var V=o(3557),W=o(5590),K=o(8018),z=class{constructor(e,t){(0,a.Z)(this,"RelatedOffer",void 0),(0,a.Z)(this,"RelatedOfferShownURL",void 0),this.RelatedOffer=e,this.RelatedOfferShownURL=t}},j=o(9645),Q=o(9215),J=o(1310);const Y=(e,t,o,a,i=!1)=>{const r=e?.offersType===H.SPB,n=new j.Z(r?h.xu.ICSPBPdpOffersNoShow:h.xu.ICQtPdpOffersNoShow),s=`${e?.offersType} offer not shown`;n.Metadata=JSON.stringify({userInfo:t,responseData:e,isExactMatch:!!e?.offer,relatedOffersLength:e?.relatedOffers?.length||0,isPdpSpb:r,isPdpQt:e?.offersType===H.Quotient,isError:i,pageTitle:document?.title}),v.Z.SendLogEvent(o,s,"",void 0,void 0,h.R.EdgeFlyoutStatus,n)},X=e=>{try{const t=_.Q?.GroceryCashbackActivated,o=((0,Q.rm)(t)??{})[e]??void 0;return o?.fullItems?Object.keys(o.fullItems):[]}catch(e){return[]}};var q=o(2714);class $ extends q.Z{constructor(...e){super(...e),(0,a.Z)(this,"localDataService",void 0),(0,a.Z)(this,"validationMessageService",void 0),(0,a.Z)(this,"cashBackResponse",void 0)}async Init(){this.localDataService=qe.GetLocalDataService(),this.validationMessageService=qe.GetValidationMessageService()}GetPopupOriginationList(){return[V.sR.AUTO_SHOW_GROCERY_ITEMIZED_CASHBACK_LANDING,V.sR.AUTO_SHOW_SPB_CASHBACK_LANDING]}CanAutoOpen(){const e=this.localDataService.GetCheckoutPageData(),t=e?.retailerData?.domainName||"";if(!this.cashBackResponse)return!1;const{shouldShow:o}=this.ProcessPDPResponse(this.cashBackResponse,t);return o}async PostValidation(){}SetCashbackResponse(e){this.cashBackResponse=e}ProcessPDPResponse(e,t){let o=!1;try{const i=qe.GetLocalDataService().GetSubmittedIds()||[],r=this.localDataService.GetIsClippingSent(),n=this.localDataService.GetUserInfo(),s=this.localDataService.GetImpressionId(),c=_.Q?.ICIsPendingTransactionPresent??!1;if(e.offersType===H.Quotient&&c)return Y(e,n,s),{shouldShow:!1,isSpb:o};let l=!1,d=K.c.PDP;if(e.offersType===H.Quotient){l=((e,t,o,a,i)=>{if(!0===i)return!1;if(!e)return!1;if(!e.shouldAutoShow)return!1;if(e.offersType!==H.Quotient)return!1;if(!(e.offer||e.relatedOffers&&0!==e.relatedOffers.length))return!1;if(_.Q.ICIsPendingTransactionPresent)return!1;const r=new Set([...X(t)]),n=new Set(o);let s=!1;return e.offer?.id&&(s=!r.has(e.offer.id)&&!n.has(e.offer.id)&&0!==e.offer.cashbackProducts.length),!!s})(e,t,i,0,r);const a=this.localDataService.GetData("variations"),c=a?JSON.parse(a):{},u=!!c.relatedOfferOnAddToCart&&"enabled"===c.relatedOfferOnAddToCart,p=((e,t)=>{if(e&&e.relatedOffers){const o=X(t),a=new Set([...o]),i=e.relatedOffers.filter((e=>{if(e.cashbackProducts&&e.cashbackProducts.length>0){const t=e.cashbackProducts[0];if(e.value&&t.price&&t.image&&!a.has(e.id))return!0}return!1}));if(i.length>0)return i[0]}return null})(e,t);if(p&&u){const e=new z(p,(0,T.Ek)());this.validationMessageService.SendStringStorageMessage(W.Q.ICRelatedPDPOffer,JSON.stringify(e))}if(!l)return{shouldShow:!1,isSpb:o};d=K.c.PDP,((e,t,o)=>{const a={isExactMatch:!!e.offer,relatedOffersLength:e.relatedOffers?.length||0,isPdpSpb:!0,pageTitle:document?.title};J.Z.LogSPBTelemetry(h.xu.ICQtPdpOffersShow,"Qt pdp shown",e,t,o,a)})(e,n,s)}else if(e.offersType===H.SPB){if(o=!0,l=!!(a=e)&&!!a.shouldAutoShow&&a.offersType===H.SPB&&!!(a.offer||a.relatedOffers&&0!==a.relatedOffers.length),!l)return{shouldShow:!1,isSpb:o};d=K.c.PdpSPB,((e,t,o)=>{const a={isExactMatch:!!e.offer,relatedOffersLength:e.relatedOffers?.length||0,isPdpSpb:!0,pageTitle:document?.title};J.Z.LogSPBTelemetry(h.xu.ICSPBPdpOffersShow,"Spb pdp shown",e,t,o,a)})(e,n,s)}const u={};return u.cashbackData=e,u.currentUrl=(0,T.Ek)(),u.type=d,u.pageTitle=(0,T.AL)(),this.validationMessageService.SendStringStorageMessage(W.Q.ICCurrentPageInfo,JSON.stringify(u)),this.localDataService.SetICNotificationType(d),this.validationMessageService.SendStringStorageMessage(W.Q.ICNotificationType,d),{shouldShow:!0,isSpb:o}}catch(t){Y(e,void 0,this.localDataService.GetImpressionId(),0,!0)}var a;return{shouldShow:!1,isSpb:o}}}var ee=$,te=o(3634);let oe=function(e){return e.Search="search",e.Category="category",e.Offers="offers",e.SearchInPane="searchpane",e.SearchInPaneMain="searchpaneMain",e.CategoryInPane="categorypane",e.OnShorelineOpen="onShorelineOpen",e.Contextual="contextual",e}({});class ae{constructor(){(0,a.Z)(this,"displayCategory",void 0),(0,a.Z)(this,"image",void 0),(0,a.Z)(this,"price",void 0),(0,a.Z)(this,"productId",void 0),(0,a.Z)(this,"retailerIdentifier",void 0),(0,a.Z)(this,"title",void 0),(0,a.Z)(this,"upc",void 0),(0,a.Z)(this,"url",void 0),(0,a.Z)(this,"discountedPrice",void 0),(0,a.Z)(this,"productReviewsCount",void 0),(0,a.Z)(this,"productRatings",void 0),(0,a.Z)(this,"productShortTitle",void 0),(0,a.Z)(this,"variation",void 0)}static Create(e){const t=new ae;return t.displayCategory=e.displayCategory,t.image=e.image,t.price=e.price,t.productId=e.productId,t.retailerIdentifier=e.retailerIdentifier,t.title=e.title,t.productShortTitle=e.productShortTitle,t.upc=e.upc,t.url=e.url,t.productRatings=e.productRatings,t.productReviewsCount=e.productReviewsCount,t.variation=e.variation,t}static CreateFromGroceryApi(e){const t=new ae;return t.displayCategory=e.productDisplayCategory,t.image=e.productImage,t.price=e.productPrice,t.productId=e.productGTIN,t.productShortTitle=e.productShortTitle,t.retailerIdentifier=e.retailerIdentifier,t.title=e.productTitle,t.upc=e.productUPC,t.url=e.productURL,t.productRatings=e.prodcutRatings,t.productReviewsCount=e.productReviewsCount,t.variation=e.variation,t}static CreateFromUAPI(e){const t=new ae;return t.displayCategory=e.displayCategory,t.image=e.image,t.price=e.price,t.productId=e.productId,t.retailerIdentifier="",t.title=e.title,t.productShortTitle=e.productShortTitle,t.upc=e.upc,t.url=e.url,t.productRatings=e.productRatings,t.productReviewsCount=e.productReviewsCount,t.productReviewsCount=e.variation,t}static CreateOneItemOffer(e){const t=ae.CreateFromUAPI(e),o=new ne;return o.cashbackProducts.push(t),o}static CreateFromAdsOffer(e,t){const o=new ae;return o.displayCategory="",o.image=t,o.price=`$${e.price}`,o.productId="",o.retailerIdentifier="",o.title=e.name??"",o.upc="",o.url=e.url??"",o.discountedPrice=e.discountedPrice?`$${e.discountedPrice.toFixed(2)}`:"",o}}var ie=ae;class re{static Create(e){const t=new re;if(t.cashbackProducts=[],e.cashbackProducts)for(const o of e.cashbackProducts)t.cashbackProducts.push(ie.Create(o));return t.imageUrl=e.imageUrl,t.offerValue=e.value,t.id=e.id,t.description=e.description,t.brand=e.brand,t.disclaimer=e.disclaimer,t.expiryDate=e.expiryDate,t.minQty=e.minQty,t.source=e.source,t}static CreateFromGroceryApi(e){const t=new re;return t.imageUrl=e.offerImage.offerImage1,t.offerValue=e.offerValue,t.id=e.offerId,t.description=e.offerDescription,t.brand=e.brandName,t.disclaimer=e.offerDisclaimer,t.expiryDate=e.offerExpiryDate,t.minQty=e.requirements.minQty,t.cashbackProducts=e.edgeRebateOfferProducts.map((e=>ie.CreateFromGroceryApi(e))),t}static CreateFromUAPI(e){const t=new re;return t.imageUrl=e.imageUrl,t.offerValue=e.value,t.id=e.id,t.description=e.description,t.brand=e.brand,t.disclaimer="",t.expiryDate=e.expiryDate,t.minQty=e.minQty,t.source=e.source,t.cashbackProducts=e.cashbackProducts.map((e=>ie.CreateFromUAPI(e))),t}static CreateFromUAPIList(e){const t=[];return e.forEach((e=>{const o=new re;o.imageUrl=e.imageUrl,o.offerValue=e.value,o.id=e.id,o.description=e.description,o.brand=e.brand,o.disclaimer="",o.expiryDate=e.expiryDate,o.minQty=e.minQty,o.source=e.source,o.cashbackProducts=e.cashbackProducts.map((e=>ie.CreateFromUAPI(e))),t.push(o)})),t}constructor(){(0,a.Z)(this,"imageUrl",void 0),(0,a.Z)(this,"offerValue",void 0),(0,a.Z)(this,"id",void 0),(0,a.Z)(this,"description",void 0),(0,a.Z)(this,"brand",void 0),(0,a.Z)(this,"disclaimer",void 0),(0,a.Z)(this,"expiryDate",void 0),(0,a.Z)(this,"minQty",void 0),(0,a.Z)(this,"source",void 0),(0,a.Z)(this,"cashbackProducts",void 0),(0,a.Z)(this,"addedTimestamp",void 0),(0,a.Z)(this,"expAfterActivatingDate",void 0),(0,a.Z)(this,"quotientTimestamp",void 0),this.cashbackProducts=[]}}var ne=re,se=class{constructor(e){(0,a.Z)(this,"ShownOffers",void 0),(0,a.Z)(this,"ImpressionId",void 0),e?(this.ShownOffers=e.ShownOffers??[],this.ImpressionId=e.ImpressionId):(this.ShownOffers=[],this.ImpressionId="")}},ce=o(9448),le=class{constructor(){(0,a.Z)(this,"AutoShowTimestampsMap",void 0),this.AutoShowTimestampsMap={}}},de=o(7550),ue=o(2315),he=o(1094),pe=o(2801);class me extends q.Z{constructor(...e){super(...e),(0,a.Z)(this,"localDataService",void 0),(0,a.Z)(this,"validationMessageService",void 0),(0,a.Z)(this,"cashBackResponseStr","")}async Init(){this.localDataService=qe.GetLocalDataService(),this.validationMessageService=qe.GetValidationMessageService()}async PostValidation(){}GetPopupOriginationList(){return[V.sR.AUTO_SHOW_SPB_CASHBACK_LANDING,V.sR.AUTO_SHOW_GROCERY_ITEMIZED_CASHBACK_LANDING]}CanAutoOpen(){const{shouldSendMessage:e}=this.ProcessCashBackResponse(this.cashBackResponseStr);return this.saveLatency(),e&&(U.Q.triggerExperiment(L.H.closeOnClickAnywhere),this.RegisterOnClickEvent()),e}SetCashbackResponseStr(e){this.cashBackResponseStr=e}ProcessCashBackResponse(e){let t=!1,o=!1,a=!1;const i={sentTimeMs:this.localDataService.GetSearchApiRequestSentTimestamp(),receivedTimeMs:(new Date).getTime()};try{if(e){const r=JSON.parse(e),n=this.localDataService.GetDomainName(),s={domain:n,offersCount:r?.itemizedCashBackResponse?.offers?.length??0,latency:i.receivedTimeMs-i.sentTimeMs};r?.itemizedCashBackResponse?.queryType===oe.Contextual&&this.LogSPBTelemetry(h.xu.ICContextualCashbackResponse,"Contextual offers received",r,s);let c=this.localDataService.GetICNotificationType();if(this.HasCashbackOffers(r)){const e=this.GetOffersType(r)===H.Quotient,l={};l.query=this.localDataService.GetData("query");let d="";if(e){const e=this.GetQtShouldShow(r,n);e.categoryName&&(l.categoryName=e.categoryName),e.addressBarTemplate&&(d=e.addressBarTemplate),e.notificationType&&e.shouldSendMessage&&(c=e.notificationType,o=e.shouldSendMessage)}else{const e=this.GetSpbShouldShow(r,s);e.notificationType&&e.shouldSendMessage&&(c=e.notificationType,o=e.shouldSendMessage,a=!0)}if(l.cashbackData=r,l.currentUrl=(0,T.Ek)(),l.type=c,l.latencyData=i,F.R.isExperimentActive(L.H.spbCheckoutAutoActivation)&&"amazon.com"===n&&this.IsCheckoutPage()){const e=new CustomEvent(te.fU,{detail:{jsonResponse:l}});window.dispatchEvent(e),o=!1,a=!1}this.validationMessageService.SendStringStorageMessage(W.Q.ICCurrentPageInfo,JSON.stringify(l)),this.validationMessageService.SendMessage(ce.H.UpdateAddressBar,[JSON.stringify({type:d})]),t=!0,this.validationMessageService.SendMessage(ce.H.UpdateLoadTimeData,[this.localDataService.GetTraceId()])}}}catch(e){}return t||this.validationMessageService.SendStringStorageMessage(W.Q.ICCurrentPageInfo,""),{shouldSendMessage:o,isSpbNotification:a}}saveLatency(){try{const e=new Map,t=(new Date).getTime();e.spbSearch=new pe.Z(pe.e,pe.e,t,pe.e),this.validationMessageService.SendStringStorageMessage(W.Q.NotificationLatency+":spbSearch",JSON.stringify({value:e}))}catch(e){const t=new j.Z(h.xu.UnifiedCashBackNotificationLatency);t.Metadata=JSON.stringify({exceptionMessage:e.message}),v.Z.SendLogEventMessage(t,h.R.EdgeFlyoutStatus,"","Failed to log latency for spb search",h.in.Error)}}LogSPBTelemetry(e,t,o,a={}){const i=this.localDataService.GetImpressionId(),r=this.localDataService.GetUserInfo();J.Z.LogSPBTelemetry(e,t,o,r,i,a)}GetSecondsSince(e){return(Date.now()-e)/1e3}IsCheckoutPage(){const e=ue.Z.getApiResponse(),t=he.Z.CreateCheckoutPageData(e).retailerData.getCurrentCheckoutPage(location.pathname);return t&&t.pageType===h.GV.CheckoutPage}GetQtShouldShow(e,t){let o,a=!1,i="",r="";const n=this.GetActivatedOfferIds(t),s=this.GetShownOffers(t),c=this.GetSubmittedOffersSet(),l=e.itemizedCashBackResponse.queryType;if(l===oe.Search){const t=ne.CreateFromUAPIList(e.itemizedCashBackResponse.offers);i="SearchGeneric",this.ShouldAutoshow(e)&&this.ContainsOffersNotShownNonActivatedNotSubmitted(t,s,n,c)&&(this.validationMessageService.SendStringStorageMessage(W.Q.ICNotificationType,K.c.Search),a=!0,o=K.c.Search)}else if(l===oe.Category){const n=ne.CreateFromUAPIList(e.itemizedCashBackResponse.offers);i="CategoryGeneric",n[0].cashbackProducts&&n[0].cashbackProducts.length>0&&(r=n[0].cashbackProducts[0].displayCategory);const s=J.Z.GetTotalCashback(n),c=this.localDataService.GetData("categoryCooldown");if(c&&s&&s>0){const e=_.Q.GroceryCategoryAutoShowData?(0,T.BQ)(_.Q.GroceryCategoryAutoShowData):new le,i=e.AutoShowTimestampsMap;(!i[t]||this.GetSecondsSince(i[t])>Number(c))&&(e.AutoShowTimestampsMap[t]=Date.now(),this.validationMessageService.SendStringStorageMessage(W.Q.GroceryCategoryAutoShowData,JSON.stringify(e)),this.localDataService.SetICNotificationType(K.c.CategoryAutoshow),this.validationMessageService.SendStringStorageMessage(W.Q.ICNotificationType,K.c.CategoryAutoshow),a=!0,o=K.c.CategoryAutoshow)}}else if(l===oe.Offers){const i=_.Q.GroceryCashbackActivated;let r={};i&&(r=(0,T.BQ)(_.Q.GroceryCashbackActivated)),(!r[t]||r[t]&&!r[t].fullItems)&&(r[t]={fullItems:{}});const n=ne.CreateFromUAPIList(e.itemizedCashBackResponse.offers),s={};n.filter((e=>e.cashbackProducts.length>0)).reverse().forEach((e=>{const t=e.id;s[t]=e})),Object.keys(r[t].fullItems).forEach((e=>{const o=r[t].fullItems[e],a=o.id;s[a]=o})),r[t].fullItems=s;let c=0;const l=[];Object.keys(s).forEach((e=>{const t=s[e],o=parseFloat(t.offerValue);l.length<3&&t.cashbackProducts?.length>0&&t.cashbackProducts[0].title&&l.push({imageUrl:t.imageUrl,title:t.cashbackProducts[0].title}),c+=o})),this.validationMessageService.SendStringStorageMessage(W.Q.ICActivatedCashbackTotal,c.toFixed(2)),this.validationMessageService.SendStringStorageMessage(W.Q.ICActivatedCashbackImages,JSON.stringify({images:l})),this.validationMessageService.SendStringStorageMessage(W.Q.GroceryCashbackActivated,JSON.stringify(r)),this.validationMessageService.SendStringStorageMessage(W.Q.ICNotificationType,K.c.ActivatedOffers),this.validationMessageService.SendBoolStorageMessage(W.Q.ICActivationMigrationPending,!0),a=!0,o=K.c.ActivatedOffers}return{shouldSendMessage:a,notificationType:o,addressBarTemplate:i,categoryName:r}}GetSpbShouldShow(e,t){let o,a=!1;if(F.R.isExperimentActive(L.H.disableSPBNotification))return this.LogSPBTelemetry(h.xu.ICSPBOffersNoShow,"SPB notification disabled by experiment disableSPBNotification",e),{notificationType:o,shouldSendMessage:a};const i=(0,de.Sq)(e);let r=i.find((e=>e.source===H.SPB));if(e?.itemizedCashBackResponse?.offersType!==H.SPB||r||(r=i.length>0?i[0]:void 0),r){const t=e?.itemizedCashBackResponse?.shouldAutoshow??!1,n=this.localDataService.GetPersonalizedAdsResponse(),s=(0,de.rP)(i,n),c=(0,de.wu)(e),l=this.containsOfferToAutoShow(i);r.visibilityFeedbackUrlBase=c,t&&l&&s?.length>0?(this.validationMessageService.SendStringStorageMessage(W.Q.ICNotificationType,K.c.SearchSPB),this.localDataService.SetICNotificationType(K.c.SearchSPB),a=!0,o=K.c.SearchSPB,this.LogSPBTelemetry(h.xu.ICSPBOffersCanShow,"","")):this.LogSPBTelemetry(h.xu.ICSPBOffersNoShow,t?"Non-activated items are not there":`Should autoshow is falsecontainOfferToAutoShow ${l}`,e)}else this.LogSPBTelemetry(h.xu.ICSPBOffersNoShow,"No SPB offers, check again",e);return{notificationType:o,shouldSendMessage:a}}containsOfferToAutoShow(e){for(const t of e){if(void 0===t.shouldAutoshow||null===t.shouldAutoshow)return!0;if((0,p.Nx)(t.shouldAutoshow))return!0}return!1}GetSubmittedOffersSet(){try{const e=this.localDataService.GetSubmittedIds();if(e&&e.length>0)return new Set(e)}catch(e){}return new Set}HasCashbackOffers(e){return!!(e&&e.itemizedCashBackResponse&&e.itemizedCashBackResponse.offers&&e.itemizedCashBackResponse.offers.length>0)}GetOffersType(e){return e?.itemizedCashBackResponse?.offersType??""}ShouldAutoshow(e){return e&&e.itemizedCashBackResponse&&e.itemizedCashBackResponse.shouldAutoshow}ContainsOffersNotShownNonActivatedNotSubmitted(e,t,o,a){let i=!1;const r=this.localDataService.GetDomainName(),n=this.localDataService.GetData("variations"),s=n?JSON.parse(n):{},c=!!s.searchIgnoreAlreadyShown&&"enabled"===s.searchIgnoreAlreadyShown;try{let n="";for(const r of e)if((c||!t.has(r.id))&&!o.has(r.id)&&!a.has(r.id)){i=!0,n=r.id;break}if(i){t.add(n);const e={},o=new se(void 0);o.ShownOffers=Array.from(t),o.ImpressionId=this.localDataService.GetImpressionId(),e[r]=o,this.validationMessageService.SendStringStorageMessage(W.Q.ICAutoShownOffers,JSON.stringify(e))}}catch(e){i=!1}return i}GetActivatedOfferIds(e){const t=_.Q?.GroceryCashbackActivated,o=((0,T.BQ)(t)??{})[e]??void 0;return o?.fullItems?new Set(Object.keys(o.fullItems)):new Set}GetShownOffers(e){const t=(0,T.BQ)(_.Q?.ICAutoShownOffers)??{},o=this.localDataService.GetImpressionId();t&&t[e]&&t[e].ImpressionId!==o&&delete t[e];const a=new se(t[e]).ShownOffers;return new Set(a)}RegisterOnClickEvent(){const e=(new Date).getTime();v.Z.AddOnClickEventWithCallback((()=>{const t=F.R.isExperimentActive(L.H.closeOnClickAnywhere);t&&w.f.postMessageToHost("dismissPopup",[]);const o=(new Date).getTime(),a=this.localDataService?.GetImpressionId()??"",i={domain:this.localDataService.GetDomainName(),isClickToDismissExperimentActive:t,startTime:e,endTime:o,duration:o-e,impressionId:a,navigationGuid:this.localDataService.GetTraceId()},r=this.cashBackResponseStr?JSON.parse(this.cashBackResponseStr):null;this.LogSPBTelemetry(h.xu.CanvasClickedWithFlyoutOpen,"Document was clicked while a search notification was triggered",r,i)}))}}var ge=me;class Ce{constructor(){(0,a.Z)(this,"isOffTheRecord",void 0),(0,a.Z)(this,"buildVersion",void 0)}static Create(e){const t=new Ce;return t.isOffTheRecord=e?.clientInfo?.isOffTheRecord??void 0,t.buildVersion=e?.clientInfo?.buildVersion,t}}var Se=Ce,fe=o(5457),ve=o(7594),Ae=o(1488),ye=class{constructor(e,t,o){(0,a.Z)(this,"AutoShowType",void 0),(0,a.Z)(this,"AutoShowTimestamp",void 0),(0,a.Z)(this,"CooldownInSeconds",void 0),this.AutoShowTimestamp=t,this.AutoShowType=e,this.CooldownInSeconds=o}},Pe=class{constructor(){(0,a.Z)(this,"AutoShowEventsMap",void 0),(0,a.Z)(this,"ActiveAutoShowType",void 0),(0,a.Z)(this,"TotalCashbackAmount",0),this.AutoShowEventsMap={},this.ActiveAutoShowType=null}};class be extends q.Z{constructor(...e){super(...e),(0,a.Z)(this,"localDataService",void 0),(0,a.Z)(this,"validationMessageService",void 0),(0,a.Z)(this,"domainData",void 0),(0,a.Z)(this,"apiResponse",void 0)}async Init(){this.apiResponse=ue.Z.getApiResponse(),this.localDataService=qe.GetLocalDataService(),this.validationMessageService=qe.GetValidationMessageService();const e=Se.Create(this.apiResponse),t=Ae.Z.Create(this.apiResponse);this.domainData=fe.Z.Create(this.apiResponse?.itemLevelCashBack?.domainData||""),this.localDataService.SetUserInfo(t),this.localDataService.SetClientInfo(e),this.localDataService.SetSubmittedIds(this.apiResponse?.itemLevelCashBack?.submittedOfferIds||[]),this.localDataService.SetPersonalizedAdsResponse(this.apiResponse?.personalizedAdsResponse?.personalizedCashback),this.localDataService.SetData("variations",JSON.stringify(this.apiResponse?.itemLevelCashBack?.variations));const o=_.Q?.ICIsPendingTransactionPresent??!1;this.localDataService.SetIsPendingTransactionPresent(o),this.apiResponse?.itemLevelCashBack?.isCashBackEnabled&&this.localDataService.SetItemLevelCashbackData(this.apiResponse.itemLevelCashBack)}CanAutoOpen(e){const t=this.localDataService.GetItemLevelCashbackData();if(!t?.isCashBackEnabled)return!1;e===V.sR.AUTO_SHOW_SPB_CASHBACK_LANDING&&this.HandleHomePage();let o=this.ValidateGroceryCashback(e);if(o)if(this.localDataService.GetICNotificationType()===K.c.Search||this.localDataService.GetICNotificationType()===K.c.Category||this.localDataService.GetICNotificationType()===K.c.ActivatedOffers){let e=!1;const t=this.apiResponse.retailerData.getCurrentCheckoutPage();if(t){const a=he.Z.GetInitialFields(this.apiResponse);(t?.orderTotalDataElementSelector||a.length>0)&&(e=!0,o=!1)}if(!e)return!1}else this.localDataService.GetICNotificationType()!==K.c.GroceryAutoShow&&this.localDataService.GetICNotificationType()!==K.c.AddedToCartPDP||J.Z.IsVariationString(this.localDataService,`gcbAutoshow-${this.localDataService.GetICNotificationType()}`,"disabled")&&(v.Z.SendStringStorageMessage(W.Q.ICNotificationType,""),o=!1);return o}PostValidation(){return Promise.resolve()}GetPopupOriginationList(){return[V.sR.AUTO_SHOW_SPB_CASHBACK_LANDING,V.sR.AUTO_SHOW_GROCERY_ITEMIZED_CASHBACK_LANDING,V.sR.AUTO_SHOW_GROCERY_ITEMIZED_CASHBACK]}IsSearchPage(e,t){const o={isSerp:!1,searchKey:""};if(t&&t.SearchData){const a=J.Z.IsUrlMatchAll(e,t.SearchData);o.isSerp=a.isMatch,o.searchKey=a.matchKey}return o}IsCategoryPage(e,t){const o={isCategory:!1,categoryId:""};if(t&&t.CategoryData){const a=J.Z.IsUrlMatchAll(e,t.CategoryData);o.isCategory=a.isMatch,o.categoryId=a.matchKey}return o}SendGetCashbackMessage(e,t,o,a){const i=[];o===oe.Search?i.push({keyword:t}):o===oe.Category?i.push({category:t}):o===oe.Offers&&t.split(",").forEach((e=>{i.push({offerId:e})}));const r=this.localDataService.GetUserInfo(),n=this.localDataService.GetClientInfo(),s=this.localDataService.IsrebatesEnabled(),c=this.localDataService.IsP13nEnabled(),l=this.localDataService.IsEdgeProfileRebatesUser(),d=this.localDataService.ConsentCanPrompt(),u=this.localDataService.GetIsPendingTransactionPresent(),h={ageGroup:r.ageGroup,clientContext:a,consentCanPrompt:d,domainName:e,isAADSignedIn:r.isAADSignedIn,isAnonymousFlowEnabled:r.isAnonymousFlowEnabled,isPendingTransaction:u,isEdgeProfileRebatesUser:l,isOffTheRecord:n.isOffTheRecord,isPersonalizationDataConsentChanged:r.isPersonalizationDataConsentChanged,isPersonalizationDataConsentEnabled:r.isPersonalizationDataConsentEnabled,isPersonalizationDataConsentEnabledV2:c,isRebatesEnabled:s,isRebatesUser:r.isRebatesUser,jsVersion:b.W1,pageUrl:(0,T.Ek)(),queries:i,queryType:o};this.localDataService.SetSearchApiRequestSentTimestamp((new Date).getTime()),this.validationMessageService.SendMessage(ce.H.GetCashBack,[JSON.stringify(h)])}ValidateGroceryCashback(e){try{const t=new URL((0,T.Ek)()),o=this.localDataService.GetItemLevelCashbackData(),a=this.localDataService.GetCheckoutPageData(),i=this.localDataService.GetClientInfo(),r=this.localDataService.GetUserInfo(),n=this.domainData;if(this.validationMessageService.SendStringStorageMessage(W.Q.ICCurrentPageInfo,""),!this.IsAddedToCartPage(t,n)&&_.Q.ICRelatedPDPOffer){const e=JSON.parse(_.Q.ICRelatedPDPOffer),o=new URL(e.RelatedOfferShownURL);t&&o&&t.hostname===o.hostname&&t.pathname===o.pathname||this.validationMessageService.SendStringStorageMessage(W.Q.ICRelatedPDPOffer,"")}if(this.HandleActivatedAutoNotification()){const e=_.Q?.GroceryInstantAddToCart;return!e}const s=a?.retailerData?.domainName??"",c={appName:E.Z.GetClientName(),buildVersion:i.buildVersion,enabledfeatures:F.R.GetExpRawData(),enabledServiceFeaturesv2:F.R.GetServerSideExperiments()},l=t.searchParams.get("activatedOffers");if(null!==l)return this.HandleActivatedOffers(l,s,c),!0;if(null!==t.searchParams.get("showCashbackOffers")){this.localDataService.SetICNotificationType(K.c.GroceryAutoShow);const e=_.Q?.GroceryAutoShowData?(0,T.BQ)(_.Q.GroceryAutoShowData):new Pe;return e.ActiveAutoShowType="ShowCashbackOffers",this.validationMessageService.SendStringStorageMessage(W.Q.GroceryAutoShowData,JSON.stringify(e)),this.validationMessageService.SendStringStorageMessage(W.Q.ICNotificationType,K.c.GroceryAutoShow),!0}if(o?.isSearchEnabled){const a=this.IsApplicableForSearchAndCategoryScenario(e),i=this.IsSearchPage(t,n);if(i.isSerp&&a&&this.HandleSearchPage(i.searchKey,s,c))return!0;const l=this.IsCategoryPage(t,n);if(l.isCategory&&a&&this.HandleCategoryPage(l.categoryId,s,c,n.categoryAutoShowCooldownInSeconds))return!0;if(r.isRebatesUser){const e=this.IsCustomAutoShowPage(t,n);if(e.isMatch&&this.HandleCustomAutoShowPage(s,e.autoShowType,e.cooldownInSeconds,o))return!0}}if(this.IsAddedToCartPage(t,n)&&_.Q.ICRelatedPDPOffer)return this.localDataService.SetICNotificationType(K.c.AddedToCartPDP),this.validationMessageService.SendStringStorageMessage(W.Q.ICNotificationType,K.c.AddedToCartPDP),!0;if(a?.retailerData?.getCurrentCheckoutPage()?.pageType===h.GV.HomePage){const e=o.spbHomePageOffers,t=e?.find((e=>e.shouldAutoshow&&e.offersType===H.SPB&&e.offers?.length>0));if(e&&t){const e=_.Q.ICSpbHomePageShownTimestamp||"0",t=Number(e),o=isNaN(t)?0:t,a=(new Date).getTime(),i=a-o,r=216e5;if(F.R.isTestFlagActive(ve.t.msShoppingTestExp11)||0===o||i>r)return this.localDataService.SetICNotificationType(K.c.SpbHomePage),this.validationMessageService.SendStringStorageMessage(W.Q.ICNotificationType,K.c.SpbHomePage),this.validationMessageService.SendStringStorageMessage(W.Q.ICSpbHomePageShownTimestamp,`${a}`),!0}}}catch(e){return!1}return!1}IsAddedToCartPage(e,t){return!!(t&&t.AddedToCartData&&J.Z.IsUrlMatchAll(e,t.AddedToCartData).isMatch)}IsApplicableForSearchAndCategoryScenario(e){return!e||e==V.sR.AUTO_SHOW_SPB_CASHBACK_LANDING}IsCustomAutoShowPage(e,t){const o={isMatch:!1,autoShowType:"",cooldownInSeconds:0};if(t&&t.CustomAutoShowData)for(const a of t.CustomAutoShowData){const t=J.Z.IsUrlMatchAll(e,a.matchData);if(t?.isMatch)return o.isMatch=t.isMatch,o.autoShowType=a.autoShowType,o.cooldownInSeconds=a.coolDownInSeconds,o}return o}HandleActivatedAutoNotification(){return!(!_.Q?.GroceryCashbackItem||!_.Q?.ICActivatedPending||(this.localDataService.SetICNotificationType(K.c.Activated),this.validationMessageService.SendStringStorageMessage(W.Q.ICNotificationType,K.c.Activated),this.validationMessageService.SendBoolStorageMessage(W.Q.ICActivatedPending,!1),0))}HandleHomePage(){const e=this.localDataService.GetCheckoutPageData(),t=e?.retailerData?.domainName??"",o=new URL((0,T.Ek)()),a=(0,M.C$)(o.href,t,""),i=F.R.isExperimentActive(L.H.contextualCashback);if(a&&i){const e=this.localDataService.GetClientInfo(),o={appName:E.Z.GetClientName(),buildVersion:e.buildVersion,enabledfeatures:F.R.GetExpRawData(),enabledServiceFeaturesv2:F.R.GetServerSideExperiments()};this.SendGetCashbackMessage(t,"",oe.Contextual,o)}}HandleSearchPage(e,t,o){return!!e&&(this.SendGetCashbackMessage(t,e,oe.Search,o),this.localDataService.SetICNotificationType(K.c.Search),this.localDataService.SetData("query",e),!0)}HandleCategoryPage(e,t,o,a){return!!e&&(this.SendGetCashbackMessage(t,e,oe.Category,o),this.localDataService.SetICNotificationType(K.c.Category),a&&this.localDataService.SetData("categoryCooldown",a.toString()),!0)}HandleCustomAutoShowPage(e,t,o,a){try{const i=_.Q?.GroceryAutoShowData?(0,T.BQ)(_.Q.GroceryAutoShowData):new Pe,r=i?.AutoShowEventsMap[e]?i.AutoShowEventsMap[e]:[],n=r?.filter((e=>e.AutoShowType===t));n?.sort(((e,t)=>e.AutoShowTimestamp-t.AutoShowTimestamp));const s=J.Z.GetTotalCashbackFromOffers(a?.itemizedCashback);if(s&&s>0&&(0===n?.length||this.GetSecondsSince(n[0].AutoShowTimestamp)>o)){const a=r?.filter((e=>e.AutoShowType!==t));return a?.push(new ye(t,Date.now(),o)),i.AutoShowEventsMap[e]=a,i.ActiveAutoShowType=t,i.TotalCashbackAmount=s,this.validationMessageService.SendStringStorageMessage(W.Q.GroceryAutoShowData,JSON.stringify(i)),this.validationMessageService.SendStringStorageMessage(W.Q.ICNotificationType,K.c.GroceryAutoShow),this.localDataService.SetICNotificationType(K.c.GroceryAutoShow),!0}return!1}catch(e){return!1}}GetSecondsSince(e){return(Date.now()-e)/1e3}HandleActivatedOffers(e,t,o){this.localDataService.SetICNotificationType(K.c.ActivatedOffers),this.localDataService.SetData("domain",t),this.SendGetCashbackMessage(t,e,oe.Category,o)}}var Ee=be;class Te{constructor(){(0,a.Z)(this,"pageVisitId",void 0),(0,a.Z)(this,"retailerSessionId",void 0),(0,a.Z)(this,"sessionId",void 0)}static Create(e){const t=new Te;return t.pageVisitId=e?.pageVisitId,t.retailerSessionId=e?.retailerSessionId,t.sessionId=e?.sessionId,t}}var Ie=Te,Oe=o(1906);function De(e){const t=e?.confirmationDetails;return!!(t&&t.transactionId&&t.purchaseTotal&&t.productNames)}var ke=o(1775),Re=o(4865),we=o(4802),Ne=o(978);function xe(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,a)}return o}function _e(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?xe(Object(o),!0).forEach((function(t){(0,a.Z)(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):xe(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}var Ue=class{constructor(){(0,a.Z)(this,"isPersonalizationDataConsentEnabled",void 0),(0,a.Z)(this,"cartExtractionSuccessful",void 0),(0,a.Z)(this,"mutationObserver",void 0)}async Init(){const e=qe.GetLocalDataService(),t=e.GetCheckoutPageData(),o=e.GetImpressionId(),a=e.GetDomainName();if(!t.retailerData)return;this.isPersonalizationDataConsentEnabled=t.userInfo?.isPersonalizationDataConsentEnabled??e.IsP13nEnabled()??!1;const i=t.retailerData.getAutomatedSelectorsPageByRegex(location.href);i&&(i?.type!==h.u3.Checkout&&i?.type!==h.u3.Cart||(this.AddPersonalizedPromotionsButtonListeners(a,o,i),this.TryCheckAndCollectPersonalizedPromotionsRawInformation(a,o,i)))}async PostValidation(){}GetLastPersonalizedPromotionsCartData(){const e=(0,g.Mw)(Ne.Vj);return e&&!(0,Re.TF)(e)?JSON.parse(e):null}async TryCheckAndCollectPersonalizedPromotionsRawInformation(e,t,o,a){o&&this.CollectPersonalizedPromotionsCartData(e,t,o,a).catch((o=>{const a={domain:e,cartUrl:location.pathname};this.LogCartExtractionEvent(a,h.R.PersonalizedPromotionsExtractionError,o?.message,h.in.Error,t)}))}async ShouldCollectPersonalizedPromotionsCartData(e,t){const o=Date.now();return!(e&&!(0,Re.TF)(t)&&t===e.OrderTotal&&!(0,Re.TF)(e.RandomId)&&e.PageUrl===(0,T.Ek)()&&o-e.CartDataCreationTime<=C.l$)}async CollectPersonalizedPromotionsCartData(e,t,o,a){if(!o?.details)return;const i=new we.Z;i.domain=e,i.pageType=o.type,i.pageUrl=(0,T.Ek)(),i.orderId=v.Z.GetBoxValue(o.details.orderId),i.randomId=u.Z.uuidv4();const r=o.details.orderTotalPrice;let n="";p.ZP.IsValidDataField(r)&&(n=await p.ZP.WaitForCondition((async()=>O.Z.RunQuerySelectorAll(r).length>0),5e3).then((async()=>v.Z.GetBoxValue(r))).catch((o=>{const a={cartId:i.randomId??"",cartUrl:location.pathname,domain:e};return this.LogCartExtractionEvent(a,h.R.PersonalizedPromotionsExtractionError,o?.message,h.in.Error,t),""})));const s=this.GetLastPersonalizedPromotionsCartData();if(!s||this.ShouldCollectPersonalizedPromotionsCartData(s,n)){try{const i=new URL(window.location.href);this.AddPageMonitor(e,t,i,o,a)}catch(e){}try{if(i.orderTotal=n,i.orderSubtotal=v.Z.GetBoxValue(o.details.orderSubTotalPrice),i.productName=await this.GetItemizedProductData(o.details.productName),i.productItemPrice=await this.GetItemizedProductData(o.details.productItemPrice),i.productTotalPrice=await this.GetItemizedProductData(o.details.productTotalPrice),i.productPrice=await this.GetItemizedProductData(o.details.productPrice),i.productQuantity=await this.GetItemizedProductData(o.details.productQuantity),i.productId=await this.GetItemizedProductData(o.details.productId),p.ZP.IsValidDataField(o.details.productImgSelector)){const e=O.Z.RunQuerySelectorAll(o.details.productImgSelector);let t="";for(const o of e){const e=o?.getAttribute("alt");e&&(t+=e+"<SEP>")}i.productNameFromImg=t}this.LogPersonalizedPromotionsCartInfo(i,e,t)}catch(e){}}}LogPersonalizedPromotionsCartInfo(e,t,o){const a=u.Z.uuidv4();this.LogCartExtractionEvent(e,h.R.ShoppingPersonalizedPromotionsRawTable,"Successfully extracted Personalized Promotions Cart Information",h.in.Information,o,a,!0);const i=new Ne.JR;i.Domain=e.domain,i.OrderTotal=e.orderTotal,i.PageType=e.pageType,i.PageUrl=e.pageUrl,i.OrderId=e.orderId,i.OrderSubtotal=e.orderSubtotal,i.ProductName=e.productName,i.ProductTotalPrice=e.productTotalPrice,i.ProductItemPrice=e.productItemPrice,i.ProductQuantity=e.productQuantity,i.ProductId=e.productId,i.ExtractionId=u.Z.uuidv4(),i.CartDataCreationTime=Date.now(),i.ProductPrice=e.productPrice,i.ProductNameFromImg=e.productNameFromImg,i.RandomId=e.randomId,(0,g.NN)()||this.LogCartExtractionEvent(e,h.R.PersonalizedPromotionsExtractionError,"No access to local storage",h.in.Error,o),(0,g.Xo)(Ne.Vj,JSON.stringify(i)),this.SendPersistentPersonalizedPromotionsCartMessage(t,i,o)}async GetItemizedProductData(e,t=5e3){if(!e||(0,Re.TF)(e))return"";let o;return await p.ZP.WaitForCondition((async()=>(o=O.Z.GetFirstVisibleElement(e??""),void 0!==o)),t),O.Z.GetItemizedData(e??"","<SEP>")}async AddPageMonitor(e,t,o,a,i){const r="true"===a.details?.addCartMonitor,n=a.details?.cartMonitorSelector;if(r){const o={attributes:!0,characterData:!0,childList:!0,subtree:!0};this.mutationObserver||(this.mutationObserver=new MutationObserver((async o=>{this.TryCheckAndCollectPersonalizedPromotionsRawInformation(e,t,a,i)})));const r=n??a?.details?.orderTotalPrice;if(r){await p.ZP.WaitForCondition((async()=>void 0!==O.Z.GetFirstVisibleElement(r)),5e3);const e=O.Z.GetFirstVisibleElement(r);e&&(this.mutationObserver?.disconnect(),this.mutationObserver?.observe(e,o))}}else this.mutationObserver?.disconnect()}SendPersistentPersonalizedPromotionsCartMessage(e,t,o){try{const o=_.Q?.PersonalizedPromotionsCartData??"",a=(0,T.BQ)(o)??{};a[e]={cartDataStorageInfo:t,timestamp:new Date};const i=JSON.stringify({value:JSON.stringify(a)});v.Z.SendStorageMessage("PersonalizedPromotionsCartData",i)}catch(e){this.LogCartExtractionEvent(t,h.R.PersonalizedPromotionsExtractionError,"Could not send cart data to storage:  "+e?.message,h.in.Error,o)}}async AddPersonalizedPromotionsButtonListeners(e,t,o){if(o?.details?.addToCartButton){const a=o.details.addToCartButton,i=await p.ZP.WaitForCondition((async()=>O.Z.HasVisibleElement(a)),5e3).then((async()=>O.Z.GetFirstVisibleElement(a)));i?.addEventListener("click",(async()=>{this.TryCheckAndCollectPersonalizedPromotionsRawInformation(e,t,o,!0)}))}else if(o?.details?.placeOrderButton){const a=o.details.placeOrderButton,i=await p.ZP.WaitForCondition((async()=>O.Z.HasVisibleElement(a)),5e3).then((async()=>O.Z.GetFirstVisibleElement(a)));i?.addEventListener("click",(async()=>{this.TryCheckAndCollectPersonalizedPromotionsRawInformation(e,t,o,!1)}))}}ShouldSendTelemetryData(e){return this.isPersonalizationDataConsentEnabled||e!==h.R.CartExtraction&&e!==h.R.TravelCheckoutExtraction&&e!==h.R.ShoppingPersonalizedPromotionsRawTable}LogCartExtractionEvent(e,t,o,a,i,r,n){let s={};this.ShouldSendTelemetryData(t)&&(s=e),n||(void 0===this.cartExtractionSuccessful&&(t===h.R.CartExtraction?this.cartExtractionSuccessful=!0:this.cartExtractionSuccessful=!1),s=_e(_e({},s),{},{isPersonalizationDataConsentEnabled:this.isPersonalizationDataConsentEnabled,extractionId:r??null})),v.Z.SendLogEventMessage(s,t,i,o,a)}},Be=o(7355),Me=o(7176),Le=o(5794),Fe=class{constructor(){(0,a.Z)(this,"noMatchYet",void 0),(0,a.Z)(this,"passedStorageValues",void 0),(0,a.Z)(this,"supportedPlatforms",[{checkoutPages:[{selectors:["[name='reductions'],#Form0 > div:nth-child(1) > div > button,#checkout_clear_discount + button","div > aside > div > div > div > div > section:nth-child(5)>div>div>div>div>div>strong"],url:"/checkouts/c"},{selectors:["#checkout_reduction_code,.field__input-btn,#checkout_clear_discount + button,.order-summary__toggle-discount","SPAN.payment-due__price"],url:"/checkouts"},{selectors:["#checkout_reduction_code,.field__input-btn,#checkout_clear_discount + button,.order-summary__toggle-discount","SPAN.payment-due__price"],url:"/securecheckout"}],name:"Shopify"},{checkoutPages:[{selectors:["INPUT[name='couponcode'],INPUT[name='couponcode'] + .button,INPUT[name='couponcode'] + .btn,.CouponCode .button,[class*='coupon'] .button,A[href*='removecoupon'],[class*='coupon-code-add']","[class*='cart-total-grand'],tr.SubTotal:nth-last-child(1) SPAN.ProductPrice"],url:"/cart.php"},{selectors:["INPUT[name='redeemableCode'],#applyRedeemableButton,A[data-test='cart-price-callback'],A.redeemable-label","DIV.cart-priceItem--total SPAN[data-test='cart-price-value']"],url:"/checkout"},{selectors:["#couponcode,#apply_code","TR.SubTotal:nth-last-child(1) .ProductPrice"],url:"/checkout.php"}],name:"BigCommerce"},{checkoutPages:[{selectors:["#coupon_code,#discount-coupon-form BUTTON.apply,#discount-coupon-form BUTTON.cancel",".grand.totals .amount SPAN.price"],url:"/checkout/cart"},{selectors:["#discount-code,#discount-form BUTTON.action-apply,#discount-form BUTTON.action-cancel",".grand.totals .amount SPAN.price"],url:"/checkout/"}],name:"Magento"},{checkoutPages:[{selectors:["#coupon_code,#discount-coupon-form BUTTON.apply,#discount-coupon-form BUTTON.cancel,[class*='showcoupon']","#shopping-cart-totals-table tfoot .price"],url:"/checkout/cart"}],name:"Magent2"},{checkoutPages:[{selectors:["#coupon_code,#discount-coupon-form BUTTON.apply,#discount-coupon-form BUTTON.cancel,#block-discount",".grand.totals .amount SPAN.price"],url:"/checkout/cart"},{selectors:["#discount-code,#discount-form > div > button,#discount-coupon-form BUTTON.cancel,#discount-accordion",".grand.totals .amount SPAN.price"],url:"/checkout/"}],name:"Magneto1"}])}TryCheckIfPlatformDomain(e){try{this.passedStorageValues=e,this.noMatchYet=!0,this.CheckIfPlatformDomain()}catch(e){this.LogError(e)}}CheckIfPlatformDomain(){for(const e of this.supportedPlatforms)for(const t of e.checkoutPages)p.ZP.IsOnPage(t.url,location.pathname)&&p.ZP.WaitForSyncCondition((()=>this.CheckIfRequiredSelectorsExist(t.selectors)),1e4).then((t=>this.LogPlatformMatch(e.name,t)))}CheckIfRequiredSelectorsExist(e){for(const t of e)if(!O.Z.GetFirstMatchingElement(t))return!1;return this.noMatchYet&&(this.noMatchYet=!1,this.TriggerSuggestedCouponService(),this.TriggerCouponSavingsService(e)),!0}LogPlatformMatch(e,t){t?this.SendPlatformFoundMessage(e):this.SendPlatformFoundMessage("Not"+e)}LogError(e){const t={Domain:(0,T.S8)(),PageUrl:"",Status:"Error"};v.Z.SendLogEventMessage(t,h.R.PlatformDetection,"",e?.message??"Error detecting platform",h.in.Information)}SendPlatformFoundMessage(e){v.Z.SendMessage(ce.H.PlatformExpansionDomain,[e])}TriggerSuggestedCouponService(){this.passedStorageValues&&(qe.GetSuggestedCouponService(!0).Init(),qe.GetSuggestedCouponService(!0).Update(Me.s3.CheckoutPage,[]))}TriggerCouponSavingsService(e){const t=[...e[0].split(","),e[1]],o=this.CreateCheckoutPageUrlData(t);qe.GetCouponSavingsService().TryListenForCoupon(o,[],"","",!0)}CreateCheckoutPageUrlData(e){const t=new Le.Z;return t.inputBoxSelector=e[0],t.orderTotalDataElementSelector=e[e.length-1],t.applyButtonSelector=e.length>=3?e[1]:"",t}},Ze=o(1951),Ge=o(6261),He=o(650),Ve=o(7869),We=o(25),Ke=o(5182),ze=o(5822),je=class{constructor(e,t){(0,a.Z)(this,"validator",void 0),(0,a.Z)(this,"CEService",void 0),(0,a.Z)(this,"domainName",void 0),this.validator=e,this.CEService=t}async SetUpPurchaseConfirmation(e,t,o,a){try{this.domainName=o;const i=await this.IsFinalCheckoutPage(e),r=e.retailerData.getCurrentFinalCheckoutPage(),n=(0,T.uf)(e?.market,e.retailerData?.exclusiveMarket);let s=await he.Z.GetOrderTotal(r,n,t,o);We.ZP.sendFinalCheckoutValidationLog(this.domainName,i,t,"",s);const c=this.CEService.GetLastCartData();i?this.ListenForPurchaseConfirmation(e,s,t,c?.CartId??"",a):r?.domMutationEnabled&&p.ZP.ObserveUntil((()=>O.Z.HasVisibleElement(r.finalCheckoutButtonSelector)),(async()=>{s=await he.Z.GetOrderTotal(r,n,t,o),We.ZP.sendFinalCheckoutValidationLog(this.domainName,!0,t,"",s),this.ListenForPurchaseConfirmation(e,s,t,c?.CartId??"",a)}))}catch(e){const o=e?.message??"checkoutpage purchase confirmation error.";v.Z.SendPurchaseConfirmationLog(this.domainName,t,o,"error","",void 0)}}async IsFinalCheckoutPage(e){const t=e.retailerData.getCurrentFinalCheckoutPage();return!(!t||(0,Re.TF)(t.finalCheckoutButtonSelector))&&(await p.ZP.WaitForCondition((async()=>O.Z.HasVisibleElement(t.finalCheckoutButtonSelector)),5e3),O.Z.HasVisibleElement(t.finalCheckoutButtonSelector))}ListenForPurchaseConfirmation(e,t,o,a,i){const r=e.retailerData.getCurrentFinalCheckoutPage();if(r&&!(0,Re.TF)(r.finalCheckoutButtonSelector)){const n=O.Z.GetAllVisibleElements(r.finalCheckoutButtonSelector);for(const s of n)s.addEventListener("click",(async()=>{this.validator.SendPurchaseConfirmationMessage(),v.Z.SendPurchaseConfirmationLog(this.domainName,o,"User completed purchase","completed",a,t);try{const t=Ke.Z.getInitializedFactory()?.getDynamicTransactionId(),o=(0,ze.h)(e);if(t&&!o){const o=t?.isEnabledDynamicTransactionId(e?.retailerData?.settings);o&&t.setDynamicTransactionId()}}catch{}this.ConfirmPurchase(r,a,o,t);try{const t=(0,T.uf)(e?.market,e.retailerData?.exclusiveMarket),a=e.retailerData?.getCurrentAutomatedSelectorsPage(location.href);this.CEService.TryCheckAndCollectCartInformation(e.retailerData.domainName,o,r,t,a,i)}catch{}try{F.R.isExperimentActive(L.H.injectConfirmationScriptUponPurchaseCompletion)&&v.Z.SendStorageMessage("CompletedPurchase",JSON.stringify({value:!0})),v.Z.SendStorageMessage("CompletedPurchaseConf",JSON.stringify({value:!0}))}catch(e){}}))}}async ConfirmPurchase(e,t,o,a){const i=new Ge.GA;i.CheckoutButtonClicked=!0,i.CheckoutTime=Date.now(),i.CartId=t,i.CartValue=a,(0,g.Xo)(Ge.Wi,JSON.stringify(i)),await p.ZP.Sleep(5e3);let r=new Ve.L;p.ZP.WaitForCondition((async()=>(r=this.DidPurchaseSucceed(e),r.indicators.length>0)),5e3).then((()=>{this.LogPurchaseStatusAndCleanUp(r.purchaseFailed,o,t,a,r.indicators),r.purchaseFailed||(0,g.UZ)(C.OY)})).catch((e=>{v.Z.SendPurchaseConfirmationLog(this.domainName,o,e?.message??"Error evaluating purchase status on checkout script","error",t,a)}))}DidPurchaseSucceed(e){const t=new Ve.L;if(t.indicators=[],t.purchaseFailed=!1,O.Z.GetAllVisibleElements(e.finalCheckoutButtonSelector).length>0)return t.purchaseFailed=!0,t.indicators.push(Ve.c.finalCheckoutButtonVisible),t;const o=O.Z.GetFirstVisibleElement("body");return He.ZP.PageIncludesPaymentKeyWords(o?.innerText.toLocaleLowerCase(),He.lD)?(t.indicators.push(Ve.c.successfulPaymentKeywordsFound),t.purchaseFailed=!1,t):(He.ZP.PageIncludesPaymentKeyWords(o?.innerText.toLocaleLowerCase(),He.si)&&(t.purchaseFailed=!0,t.indicators.push(Ve.c.failurePaymentKeywordsFound)),O.Z.GetAllVisibleElements("input").length>0&&(t.purchaseFailed=!0,t.indicators.push(Ve.c.inputFieldsFound)),t)}LogPurchaseStatusAndCleanUp(e,t,o,a,i){(0,g.UZ)(Ge.Wi),e||(0,g.Mw)(Ze.y$.autoApplyStorageKey)===Ze.M4.ActionDetected&&(v.Z.SendStringStorageMessage(Ze.y$.completedPurchaseStorageKey,Ze.M4.ActionDetected),(0,g.Xo)(Ze.y$.completedPurchaseStorageKey,Ze.M4.ActionDetected));const r=e?"Failed":"Succeeded";v.Z.SendPurchaseConfirmationLog(this.domainName,t,JSON.stringify(i),r,o,a)}};class Qe{async QueryWebAssistUrls(e,t){return Qe.waiting=!0,Qe.mojomResponse=void 0,N.p.postMessageToHost("QueryWebAssistUrls",[e,...t]),await p.ZP.WaitForCondition((async()=>!Qe.waiting),7e3),Qe.mojomResponse}ProcessWebAssistResponse(e){try{Qe.mojomResponse=JSON.parse(e)}catch(e){Qe.mojomResponse=void 0}finally{Qe.waiting=!1}}}(0,a.Z)(Qe,"waiting",void 0),(0,a.Z)(Qe,"mojomResponse",void 0);var Je=Qe,Ye=o(9442);class Xe{static GetValidatorModule(){return this.validator}static GetGroceryCBService(){return this.groceryCBService||(this.groceryCBService=new l.Z),this.groceryCBService}static GetZipCardService(){return this.zipCardService||(this.zipCardService=new Ye.Z),this.zipCardService}static GetCartExtractionService(){return(0,k.X)()}static GetPersonalizedPromotionsCartExtractionService(){return this.personalizedPromotionsCartExtractionService||(this.personalizedPromotionsCartExtractionService=new Ue),this.personalizedPromotionsCartExtractionService}static GetPinterestService(){return this.pinterestService||(this.pinterestService=new Be.Z),this.pinterestService}static GetCatalogExtractionService(){return this.catalogExtractionServie||(this.catalogExtractionServie=new R.Z),this.catalogExtractionServie}static GetPlatformDetectionService(){return this.platformDetectionService||(this.platformDetectionService=new Fe),this.platformDetectionService}static GetAutoApplyService(){return this.autoApplyService||(this.autoApplyService=new s.Z),this.autoApplyService}static GetHtmlFragmentCollectionService(){return this.htmlFragmentCollectionService||(this.htmlFragmentCollectionService=new G),this.htmlFragmentCollectionService}static GetCancellationPageDataExtractionService(){return this.cancellationPageDataExtractionService||(this.cancellationPageDataExtractionService=new D),this.cancellationPageDataExtractionService}static GetCouponSavingsService(){return this.couponSavingsService||(this.couponSavingsService=new x.Z),this.couponSavingsService}static GetAutomaticCartExtractionService(){return this.automaticCartExtractionService||(this.automaticCartExtractionService=new P(Xe.GetWebAssistQueryService())),this.automaticCartExtractionService}static GetPurchaseDetectionService(){return this.purchaseDetectionService||(this.purchaseDetectionService=new je(Xe.GetValidatorModule(),Xe.GetCartExtractionService())),this.purchaseDetectionService}static GetICValidatorService(){return this.icValidatorService}static GetIcSearchProcessorService(){return this.icSearchProcessorService}static GetIcPDPProcessorService(){return this.icPDPProcessorService}static GetLocalDataService(){return this.localDataService}static GetValidationMessageService(){return this.validationMessageService}static GetWebAssistQueryService(){return this.webAssistQueryService||(this.webAssistQueryService=new Je),this.webAssistQueryService}static GetSuggestedCouponService(e=!1){return this.suggestedCouponsService||(this.suggestedCouponsService=new i.Z(v.Z.SendStorageMessage.bind(v.Z),e)),this.suggestedCouponsService}static GetOtherSellersService(){return this.otherSellersService}static GetAAConsentService(){return this.aaConsentService}static GetClientRequestsService(){return this.clientRequestsService}static GetPageDetectionService(){return this.pageDetectionService}static GetBackgroundAAService(){return this.backgroundAAService}static GetCartProcessingClient(){return this.cartProcessingClient||(this.cartProcessingClient=new r.Z),this.cartProcessingClient}}(0,a.Z)(Xe,"localDataService",new class{constructor(){(0,a.Z)(this,"impressionId",void 0),(0,a.Z)(this,"icNotificationType",void 0),(0,a.Z)(this,"mapData",void 0),(0,a.Z)(this,"userInfo",void 0),(0,a.Z)(this,"clientInfo",void 0),(0,a.Z)(this,"isRebatesEnabled",void 0),(0,a.Z)(this,"isP13nEnabled",void 0),(0,a.Z)(this,"isEdgeProfileRebatesUser",void 0),(0,a.Z)(this,"consentCanPrompt",void 0),(0,a.Z)(this,"itemLevelCashBackDta",void 0),(0,a.Z)(this,"domainName",void 0),(0,a.Z)(this,"traceId",void 0),(0,a.Z)(this,"isClippingSent",void 0),(0,a.Z)(this,"submittedIds",void 0),(0,a.Z)(this,"personalizedCashbackData",void 0),(0,a.Z)(this,"isPendingTransactionPresent",!1),(0,a.Z)(this,"searchApiRequestSentTimestamp",0),(0,a.Z)(this,"merchantData",void 0),(0,a.Z)(this,"coupons",void 0),(0,a.Z)(this,"isFinalCheckoutPage",void 0),(0,a.Z)(this,"market",void 0),(0,a.Z)(this,"isExpressCheckoutPage",void 0),(0,a.Z)(this,"muid",void 0),(0,a.Z)(this,"params",void 0),(0,a.Z)(this,"isAADSignedIn",void 0),(0,a.Z)(this,"hasValidLinkedAccount",void 0),(0,a.Z)(this,"sessionIds",void 0),(0,a.Z)(this,"ConfirmationPageData",void 0),(0,a.Z)(this,"autoApplyStatus",!1),(0,a.Z)(this,"bingNavChain",void 0),(0,a.Z)(this,"userSettingsData",void 0),(0,a.Z)(this,"featureConfigs",void 0),this.mapData=new Map,this.userInfo=new Ae.Z,this.clientInfo=new Se,this.isExpressCheckoutPage=!1}SetBingNavChain(e){this.bingNavChain=e}SetParams(e){this.params=e}SetImpressionId(e){this.impressionId=e}SetDomainName(e){this.domainName=e}EarlyFetchConfirmationPageData(e){this.ConfirmationPageData=async function(e,t){if(!e||!t||!function(e,t){return!(!e||!t)&&new RegExp(e,"i").test(t)}(e.orderConfirmationPageUrl,t))return Promise.resolve(void 0);const o=await(0,Oe._p)(e.confirmationPageTelemetry,e.domainName);return o?.confirmationDetails?{confirmationDetails:o.confirmationDetails,canNotifyOnConfirmationPage:De(o)}:void 0}(e,(0,T.Ek)())}async GetConfirmationPageData(e){return this.ConfirmationPageData||this.EarlyFetchConfirmationPageData(e),await this.ConfirmationPageData}SetMarket(e){this.market=e}SetICNotificationType(e){this.icNotificationType=e}SetTraceId(e){this.traceId=e}SetIsClippingSent(e){this.isClippingSent=e}SetCheckoutPageData(e){this.merchantData=e}SetCoupons(e){this.coupons=e}SetIsFinalCheckoutPage(e){this.isFinalCheckoutPage=e}GetBingNavChain(){return this.bingNavChain??""}GetParams(){return this.params}GetIsFinalCheckoutPage(){return this.isFinalCheckoutPage}GetCheckoutPageData(){return this.merchantData}GetCoupons(){return this.coupons}GetIsClippingSent(){return this.isClippingSent}GetTraceId(){return this.traceId}GetMarket(){return this.market}GetICNotificationType(){return this.icNotificationType}GetImpressionId(){return this.impressionId??""}GetDomainName(){return this.domainName??""}SetIsExpressCheckoutPage(e){this.isExpressCheckoutPage=e}IsExpressCheckoutPage(){return this.isExpressCheckoutPage}SetItemLevelCashbackData(e){this.itemLevelCashBackDta=e}SetClientInfo(e){this.clientInfo=e}GetClientInfo(){return this.clientInfo}SetSubmittedIds(e){this.submittedIds=e}GetSubmittedIds(){return this.submittedIds}SetIsRebatesEnabled(e){this.isRebatesEnabled=e}IsrebatesEnabled(){return this.isRebatesEnabled}SetIsP13nEnabled(e){this.isP13nEnabled=e}IsP13nEnabled(){return this.isP13nEnabled}SetIsEdgeProfileRebatesUser(e){this.isEdgeProfileRebatesUser=e}IsEdgeProfileRebatesUser(){return this.isEdgeProfileRebatesUser}SetConsentCanPrompt(e){this.consentCanPrompt=e}ConsentCanPrompt(){return this.consentCanPrompt}SetIsAADSignedIn(e){this.isAADSignedIn=e}IsAADSignedIn(){return this.isAADSignedIn}SetHasValidLinkedAccount(e){this.hasValidLinkedAccount=e}HasValidLinkedAccount(){return this.hasValidLinkedAccount}GetItemLevelCashbackData(){return this.itemLevelCashBackDta}SetUserInfo(e){this.userInfo=e}GetUserInfo(){return this.userInfo}GetData(e){return this.mapData.get(e)}SetData(e,t){return this.mapData.set(e,t)}SetAutoApplyStatus(e){this.autoApplyStatus=e||this.autoApplyStatus}GetAutoApplyStatus(){return this.autoApplyStatus}SetPersonalizedAdsResponse(e){this.personalizedCashbackData=e}GetPersonalizedAdsResponse(){return this.personalizedCashbackData}SetIsPendingTransactionPresent(e){this.isPendingTransactionPresent=e}GetIsPendingTransactionPresent(){return this.isPendingTransactionPresent}SetSearchApiRequestSentTimestamp(e){this.searchApiRequestSentTimestamp=e}GetSearchApiRequestSentTimestamp(){return this.searchApiRequestSentTimestamp}SetSessionIds(e){this.sessionIds=Ie.Create(e)}SetUserSettingsData(e,t,o){if(o&&!(e.length<=t))try{this.userSettingsData=JSON.parse(e[t]),this.userSettingsData?.featureConfigs&&(this.featureConfigs=JSON.parse(this.userSettingsData.featureConfigs))}catch(e){}}GetUserSettingsData(){return this.userSettingsData}GetFeatureConfigs(){return this.featureConfigs}GetLogBlockConfig(){return this.featureConfigs?.logBlockConfig??(0,ke.JL)()}GetSessionIds(){return this.sessionIds}SetMuidFromUHId(e){if(e)try{const t=window.atob(e);t&&(this.muid=t)}catch(e){}}GetMuid(){return this.muid}}),(0,a.Z)(Xe,"validationMessageService",new class{SendMessage(e,t){v.Z.SendMessage(e,t)}SendStringStorageMessage(e,t){v.Z.SendStringStorageMessage(e,t)}SendBoolStorageMessage(e,t){v.Z.SendStorageMessage(e,JSON.stringify({value:t}))}}),(0,a.Z)(Xe,"validator",new We.ZP(Xe.GetLocalDataService())),(0,a.Z)(Xe,"personalizedPromotionsCartExtractionService",new Ue),(0,a.Z)(Xe,"zipCardService",new Ye.Z),(0,a.Z)(Xe,"groceryCBService",void 0),(0,a.Z)(Xe,"catalogExtractionServie",new R.Z),(0,a.Z)(Xe,"automaticCartExtractionService",void 0),(0,a.Z)(Xe,"purchaseDetectionService",new je(Xe.GetValidatorModule(),Xe.GetCartExtractionService())),(0,a.Z)(Xe,"platformDetectionService",new Fe),(0,a.Z)(Xe,"htmlFragmentCollectionService",void 0),(0,a.Z)(Xe,"cancellationPageDataExtractionService",new D),(0,a.Z)(Xe,"couponSavingsService",new x.Z),(0,a.Z)(Xe,"icValidatorService",new Ee),(0,a.Z)(Xe,"autoApplyService",new s.Z),(0,a.Z)(Xe,"icSearchProcessorService",new ge),(0,a.Z)(Xe,"icPDPProcessorService",new ee),(0,a.Z)(Xe,"suggestedCouponsService",void 0),(0,a.Z)(Xe,"webAssistQueryService",void 0),(0,a.Z)(Xe,"otherSellersService",new d.Z),(0,a.Z)(Xe,"aaConsentService",new n.Z),(0,a.Z)(Xe,"pinterestService",void 0),(0,a.Z)(Xe,"clientRequestsService",new class{constructor(){(0,a.Z)(this,"MaxWaitTime",7e3),(0,a.Z)(this,"responseMap",{})}async Init(){}async PostValidation(){}async SendRequest(e,t,o){const a=u.Z.uuidv4(),i=JSON.stringify({serviceName:e,methodName:t,requestBody:JSON.stringify(o)});this.responseMap[a]=void 0,w.f.postMessageToHost("FireGenericDealsRequest",[a,i]),N.p.postMessageToHost("FireGenericDealsRequest",[a,i]),await(0,p.dz)((async()=>void 0!==this.responseMap[a]),this.MaxWaitTime);const r=this.responseMap[a];if(delete this.responseMap[a],void 0!==r&&r.length>=3&&"200"===r[2]){const e=JSON.parse(r[1]);if("OK"===e?.errorCode&&e?.responseBody)return e.responseBody}return null}async SendRequestWithTimeout(e,t,o,a=this.MaxWaitTime){const i=u.Z.uuidv4(),r=JSON.stringify({serviceName:e,methodName:t,requestBody:JSON.stringify(o)});this.responseMap[i]=void 0,w.f.postMessageToHost("FireGenericDealsRequest",[i,r]),N.p.postMessageToHost("FireGenericDealsRequest",[i,r]);const n=await(0,p.V5)((async()=>void 0!==this.responseMap[i]),a);if(n?.status===p.wS.Timeout)throw new Error(`${e} ${t} was aborted after ${a} miliseconds`);const s=this.responseMap[i];if(delete this.responseMap[i],void 0!==s&&s.length>=3&&"200"===s[2]){const e=JSON.parse(s[1]);if("OK"===e?.errorCode&&e?.responseBody)return e.responseBody}return null}ProcessClientRequestResponse(e){if(e.length>=3){const t=e[0];Object.keys(this.responseMap).includes(t)&&void 0===this.responseMap[t]&&(this.responseMap[t]=e)}}}),(0,a.Z)(Xe,"pageDetectionService",new class{constructor(){(0,a.Z)(this,"regexList",void 0),this.regexList=[/^(?!.*setting).*(\bcheckout|\bpayment\b)/i,/^(?!.*add).*(\bcart\b|\bbasket\b)/i]}async Init(){}async PostValidation(){}CheckAndLogUrl(e){const t=window.location.href;if(this.UrlNotInRetailerData(e,t))for(const o of this.regexList)if(o.test(t))return void this.LogUrlAndMatchedRegex(t,o,e)}UrlNotInRetailerData(e,t){const o=e.retailerData?.getCurrentCheckoutPage(t);return!o||"/"===o.checkoutPageUrl}LogUrlAndMatchedRegex(e,t,o){const a={Domain:o.retailerData?.domainName,PageUrl:e,Regex:t.source};v.Z.SendLogEventMessage(a,h.R.PageDetectionRegexMatched,o.impressionId,"Url not in retailer data matched regex",h.in.Information)}}),(0,a.Z)(Xe,"backgroundAAService",new c.Z),(0,a.Z)(Xe,"cartProcessingClient",new r.Z);var qe=Xe},25:function(e,t,o){o.d(t,{EI:function(){return Y},OE:function(){return Q},J6:function(){return J},ZP:function(){return q}});var a=o(2370),i=o(4872),r=o(1656),n=o(3209),s=o(9645),c=o(843),l=o(7609),d=o(5144),u=o(8767),h=o(7689),p=o(4901),m=o(6764),g=o(7605),C=o(1687),S=o(9710);const f="var(--colorNeutralForeground1Static)",v="var(--colorNeutralBackground1Selected)",A="var(--colorNeutralStroke3)",y="var(--borderRadiusMedium)",P="var(--fontSizeBase200)",b="var(--fontSizeBase300)",E="var(--fontWeightRegular)",T="var(--fontWeightSemibold)",I="var(--lineHeightBase200)",O="var(--lineHeightBase300)",D="var(--spacingHorizontalM)",k="var(--spacingVerticalSNudge)";var R=class{getStyles(){return`\n        .productTrackingViewContainer {\n            width: 100%;\n            padding: 0;\n            box-sizing: border-box;\n        }\n        .subContainer {\n            display: flex;\n            padding-top: 12px;\n            padding-bottom: 16px;\n        }\n        .iconContainer {\n            position: static;\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            width: 36px;\n            height: 36px;\n            border-radius: 50%;\n            background: #F3F3F3;\n            box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.08);\n        }\n        .trackedStateIcon {\n            max-width: 20px;\n        }\n        .textContainer {\n            flex: 1;\n            text-align: left;\n            padding: 0 12px 0 8px;\n        }\n        .trackedPriceNotifText {\n            font-weight: 600;\n        }\n        fluent-switch {\n            --design-unit: 4;\n        }\n        ::part(switch) {\n            border: 1px solid #616161;\n        }\n        .checked::part(switch) {\n            border: 1px solid transparent;\n            background: #0F6CBD;\n        }\n        ::part(checked-indicator) {\n            --design-unit: 4;\n            background: #616161;\n            border: 2px solid transparent;\n            top: 2px;\n            left: 2px;\n        }\n        .checked::part(checked-indicator) {\n            background: #FFFFFF;\n            left: 22px;\n        }\n        hr {\n            border: none;\n            height: 1px;\n            background: #F5F5F5;\n        }\n        .trackedProductText {\n            color: var(--accent-fill-rest);\n            font-weight: 400;\n            background: inherit;\n        }\n        .retailerContainer {\n            position: relative;\n            left: 4px;\n            top: 2px;\n        }\n        .subtitleContainer {\n            color: var(--neutral-foreground-hint);\n            font-size: 12px;\n            max-width: 160px;\n            display: -webkit-box;\n            -webkit-box-orient: vertical;\n            -webkit-line-clamp: 2;\n            overflow: hidden;\n            text-align: left;\n        }\n        .settingsContainer {\n            width: 302px;\n            padding: 10px;\n            font-size: 14px;\n            border-radius: 4px;\n            background: white;\n            position: absolute;\n            top: 0px;\n            left: 36px;\n            z-index: 5;\n            box-shadow: 0px 0px 8px rgba(0, 0, 0, 0.12), 0px 8px 16px rgba(0, 0, 0, 0.14);\n            backdrop-filter: blur(30px);\n            cursor: default;\n        }\n        @media (forced-colors: active) {\n            .settingsContainer {\n                border: 1px solid black;\n            }\n            .inlineCard {\n                border: 1px solid black;\n            }\n        }\n        .settingsHeader {\n            height: 40px;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n        }\n        .ptSettingsTitle {\n            font-family: var(--fontFamilyBase);\n            font-size: 14px;\n            font-weight: 600;\n            line-height: ${O};\n            text-align: left;\n            width: 240px;\n        }\n        .settingsLeftChevron svg {\n            rotate: 90deg;\n            width: 9px;\n            height: 9px;\n            margin-bottom: 2px;\n        }\n        .settingsBody {\n            margin-left: 8px;\n            margin-right: 8px;\n            gap: 12px;\n            opacity: 0px;\n        }\n        .settingsText {\n            font-size: ${P};\n            font-weight: ${T};\n            line-height: ${I};\n            color: ${f};\n            margin-top: 4px;\n            margin-bottom: 4px;\n        }\n        .settingsOptionContainer {\n            display: flex;\n            flex-wrap: nowrap;\n            gap: 8px;\n            margin-bottom: 8px;\n            margin-top: 0;\n            padding: 0;\n            list-style-type: none;\n        }\n            \n        .settingsOptionContainer li {\n            position: relative;\n            height: 30px;\n        }\n\n        .settingsOptionContainer input[type="radio"] {\n            position: absolute;\n            opacity: 0;\n            height: 100%;\n            width: 100%;\n            margin: 0;\n            cursor: pointer;\n        }\n\n        .settingsOptionContainer label {\n            display: inline-flex;\n            align-items: center;\n            justify-content: center;\n            padding: 4px 8px;\n            border: 1px solid var(--colorNeutralStroke2);\n            border-radius: ${y};\n            font-size: ${b};\n            font-weight: ${T};\n            line-height: ${O};\n            white-space: nowrap;\n            text-align: center;\n            background: ${v}; \n            transition: background 0.2s, border-color 0.2s;\n        }\n   \n        .settingsOptionButton {\n            border-radius: ${y};\n            background: var(--colorStrokeFocus1);\n            padding-inline-start ${D};\n            padding-inline-end ${D};\n            padding-block-start ${k};\n            padding-block-end ${k};\n            column-gap: var(--spacingHorizontalSNudge);\n            font-size: ${b};\n            font-weight: ${T};\n            line-height: ${O};\n            color: ${f};\n        }\n        .settingsOptionSelected input[type="radio"]:checked + label {\n            background: ${v};\n            border-color: var(--colorNeutralStrokeAccessiblePressed);\n        }\n        .settingsSaveButton {\n            width: 100%;\n            font-weight: 600;\n            margin-top: 8px;\n        }\n        .settingsSaveMuted::part(control) {\n            background: ${A};\n            color: #00000042;\n        }\n        .checkMarkCircle {\n            margin-top: 5px;\n        }\n        .checkMarkCircle svg path {\n            fill: var(--colorPaletteGreenForeground3);\n        }\n        .inlineCard {\n            background: var(--colorBrandBackground2);\n            padding: 12px;\n            border-radius: 4px;\n            cursor: pointer;\n        }\n        .inlineCard:hover {\n            background: var(--colorBrandBackground2Hover)\n        }\n        .notifyConditionText span {\n            display: inline;\n            white-space: nowrap;\n            white-space: normal;\n        }\n        .boldText {\n            font-weight: bold;\n        }\n        .manageNotificationsContainer {\n            display: flex;\n            margin-top: 4px;\n            width: fit-content;\n        }\n        .manageNotificationsContainer:hover {\n            cursor: pointer;\n        }\n        .manageNotificationText {\n            font-size: ${P};\n            font-weight: ${E};\n            line-height: ${I};\n            color: #0000009E;\n        }\n        .settingsRightChevron svg {\n            margin-left: 4px;\n            margin-bottom: 1.25px;\n            rotate: 270deg;\n            width: 9px;\n            height: 9px;\n            color: #0000009E;\n        }\n        .viewTrackedProducts {\n            font-size: ${P};\n            font-weight: ${E};\n            line-height: ${I};\n            color: var(--colorBrandForegroundLink);\n            width: fit-content;\n            margin-top: 12px;\n            margin-bottom: 2px;\n        }\n        .viewTrackedProducts:hover {\n            cursor: pointer;\n        }\n        `}getConciseStyles(){return"\n        .productTrackingViewContainer {\n            width: 100%;\n            padding: 0;\n            box-sizing: border-box;\n        }\n        .subContainer {\n            display: flex;\n            padding-top: 12px;\n            padding-bottom: 16px;\n        }\n        .iconContainer {\n            position: static;\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            width: 36px;\n            height: 36px;\n            border-radius: 50%;\n            background: #F3F3F3;\n            box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.08);\n        }\n        .textContainer {\n            flex: 1;\n            text-align: left;\n            padding: 0 12px 0 8px;\n        }\n        .trackedPriceNotifText {\n            font-weight: 600;\n        }\n        fluent-switch {\n            --design-unit: 4;\n        }\n        ::part(switch) {\n            border: 1px solid #616161;\n        }\n        .checked::part(switch) {\n            border: 1px solid transparent;\n            background: #0F6CBD;\n        }\n        ::part(checked-indicator) {\n            --design-unit: 4;\n            background: #616161;\n            border: 1px solid transparent;\n            top: 1.5px;\n            left: 1px;\n        }\n        .checked::part(checked-indicator) {\n            background: #FFFFFF;\n            left: 16px;\n        }\n        .trackingToggleContainer {\n            display: flex;\n            align-items: center;\n        }\n        .trackedProductTextContainer {\n            line-height: 20px;\n            height: 20px;\n            display: flex;\n        }\n        .trackedProductText {\n            color: var(--accent-fill-rest);\n            font-weight: 400;\n            background: inherit;\n            font-size: 12px;\n            line-height: 16px;\n            height: 16px;\n        }\n        .trackedProductText::part(control) {\n            line-height: 20px;\n            height: 20px;\n        }\n        .retailerContainer {\n            position: relative;\n            left: 4px;\n            top: 2px;\n        }\n        .subtitleContainer {\n            color: var(--neutral-foreground-hint);\n            font-size: 12px;\n            max-width: 160px;\n            display: -webkit-box;\n            -webkit-box-orient: vertical;\n            -webkit-line-clamp: 2;\n            overflow: hidden;\n            text-align: left;\n        }\n        "}getNotificationStyles(){return"\n        .productTrackingViewContainer {\n            padding-bottom: 4px;\n        }\n        .subContainer {\n            display: flex;\n            align-items: center;\n            padding-top: 12px;\n            padding-bottom: 0px;\n        }\n        .iconContainer {\n            position: static;\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            width: 36px;\n            height: 36px;\n            border-radius: 50%;\n            background: #F3F3F3;\n            box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.08);\n        }\n        .trackedPriceNotifText {\n            font-weight: 600;\n        }\n       "}getDarkModeStyles(){return`\n        ::part(switch) {\n            border: 1px solid #ADADAD;\n        }\n        .checked::part(switch) {\n            background: #479EF5;\n        }\n        ::part(checked-indicator) {\n            background: #ADADAD;\n        }\n        .checked::part(checked-indicator) {\n            background: #3B3B3B;\n        }\n        hr {\n            background: #555555;\n        }\n        .trackedProductText {\n            color: #63ADE5;\n        }\n        .settingsContainer {\n            background: #292929;\n            color: white;\n        }\n        .settingsText {\n            color: white;\n        }\n        .settingsOptionButton {\n            background: #3B3B3B;\n            color: white;\n        }\n        .settingsSaveButton::part(control) {\n            background: #235CCF;\n            color: white;\n        }\n        .settingsSaveMuted::part(control) {\n            background: ${A};\n            color: #FFFFFF3D;\n        }\n        .manageNotificationText {\n            color: #FFFFFFAD;\n        }\n        .settingsRightChevron svg {\n            color: #FFFFFFAD;\n        }\n        .overlayCloseButton::part(control) {\n            background: #292929;\n        }\n        .settingsLeftChevron::part(control) {\n            background: #292929;\n        }\n        `}},w=o(8533),N=o(1714);let x=function(e){return e.ShoppingTab="shoppingTab",e.Contextual="tabContexual",e.Home="tabHome",e.Cashback="tabCashback",e.GenExperiences="GenExperiences",e}({});function _(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,a)}return o}function U(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?_(Object(o),!0).forEach((function(t){(0,a.Z)(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):_(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}class B extends w.ZP{constructor(...e){super(...e),(0,a.Z)(this,"abandonedCartNotificationTrackingEnabled",void 0),(0,a.Z)(this,"isOutOfStock",void 0),(0,a.Z)(this,"productDetails",void 0),(0,a.Z)(this,"assets",new R),(0,a.Z)(this,"isPriceTracked",void 0),(0,a.Z)(this,"priceTrackingSectionId","price-tracking-section"),(0,a.Z)(this,"settingsOverlay",void 0),(0,a.Z)(this,"trackingOverlay",void 0),(0,a.Z)(this,"handleClickOutsideSettings",(e=>{this.settingsOverlay&&"hidden"!==this.settingsOverlay.style.visibility&&!e.composedPath().includes(this.settingsOverlay)&&this.closeOverlaysCleanListeners()})),(0,a.Z)(this,"handleClickOutsideTracking",(e=>{this.trackingOverlay&&"hidden"!==this.trackingOverlay.style.visibility&&!e.composedPath().includes(this.trackingOverlay)&&this.closeOverlaysCleanListeners()}))}async createTrackingToggleSection(e,t,o,a=!1){const{strings:n,common:c}=this.flyoutData;if(this.isOutOfStock=t,e&&e.ProductUrl&&e.title&&(e.price||t))try{const s=r.R.isExperimentActive(i.H.ptConciseUi),l=r.R.isExperimentActive(i.H.PCOutOfStock),d=r.R.isExperimentActive(i.H.ptNotifications)&&r.R.getServiceExperimentValue(i.H.ptNotifications)==N.cO.NewDesign,h=c.openedWith===u.Te.Auto;this.productDetails=e,h||this.logContentViewed(t);const p=await this.isTrackedProduct(e?.ProductUrl),m=(0,S.Ux)("div",{className:"productTrackingViewContainer lateralMargin",id:this.priceTrackingSectionId}),g=d?(0,S.Ux)("div",{className:"subContainer",style:"display: flex; align-items: center; justify-content: space-between; padding-bottom: 12px; padding-top: 6px;"}):(0,S.Ux)("div",{className:"subContainer"}),C=d?(0,S.Ux)("div",{className:"iconContainerV2",style:"display: flex; align-items: center;"}):(0,S.Ux)("div",{className:"iconContainer"}),f=(0,S.Ux)("img",{className:"trackedStateIcon"});let v="";v=d?p?c.resourcesEndpoint+"productTracking/trackProductActiveWhiteBlack.svg":c.resourcesEndpoint+"productTracking/trackProductInactiveWhiteBlack.svg":p?c.resourcesEndpoint+"productTracking/trackProductActiveBlack.svg":c.resourcesEndpoint+"productTracking/trackProductInactiveBlack.svg",s?f.height=17:d?(f.width=18,f.height=18):f.width=p?19:15,f.src=v,f.setAttribute("aria-hidden","true");const A=(0,S.Ux)("div",{className:"textContainer"}),y=(0,S.Ux)("div",{className:"trackedPriceNotifText"+(d?"":" txtMedium"),textContent:d?"Tracking product":t?n.productTrackingTitleAvailability:n.productTrackingTitlePrice,style:d?"font-size: 14px line-height: 20px; font-weight: 400;":""}),P=this.getSubtitleText(p,t,a),b=(0,S.Ux)("span",{className:"subtitleContainer",title:P}),E=(0,S.Ux)("span",{className:"subtitleTextContainer",textContent:P}),T=(0,S.Ux)("div",{className:"trackingToggleContainer"}),I=(0,S.Ux)("fluent-switch",{id:"ptvuTrackingToggle"});if(I.checked=p??!1,I.name="Tracking toggle",I.title="Tracking toggle",b.textContent&&I.setAttribute("aria-label",b.textContent),I.addEventListener("change",(i=>this.trackingToggleChangeCallback(i,e,t,o,a))),!s&&!l){const e=(0,S.Ux)("hr");m.appendChild(e)}if(b.appendChild(E),T.appendChild(I),C.appendChild(f),A.appendChild(y),d||A.appendChild(b),g.appendChild(C),g.appendChild(A),g.appendChild(T),m.appendChild(g),h||m.appendChild(this.createTrackedProductsText(o,s)),a&&h){const e=(0,S.Ux)("span",{className:"retailerContainer"}),t=(0,S.Ux)("IMG",{className:"retailerLogo"});this.utilities.addFavIconSrc(t,e,c.domain),b.appendChild(e)}return s?this.utilities.applyStyles(m,this.assets.getConciseStyles(),void 0,this.assets.getDarkModeStyles()):this.utilities.applyStyles(m,this.assets.getStyles(),voiINDX( 	 øÍcG#           (     è       t                     o/    ¨      l%   6 ,{P#ÖM3Q#ÖêØ¤öÅÛk`ä¾Û       W         o  ) C o n t a c t s . t a r g e t s i z e - 1 6 _ c o n t r a s t - w h i t e . p n g     t/    ¨      l%   6 ,{P#ÖM3Q#ÖêØ¤öÅÛk`ä¾Û       Z         o  ) C o n t a c t s . t a r g e t s i z e - 2 0 _ c o n t r a s t - w h i t e . p n g     y/    ¨      l%   6 ,{P#ÖM3Q#ÖêØ¤öÅÛ:ôm`ä¾Û       k         o  ) C o n t a c t s . t a r g e  s i z e - 2 4 _ c o n t r a s t - w h i t e . p n g     }/    ¨      l%   6 ,{P#ÖM3Q#ÖêØ¤öÅÛ:ôm`ä¾Û                o  ) C o n t a c t s . t a r g e t s i z e - 3 2 _ c o n t r a s t - w h i t e . p n g     /    ¨      l%   6 ,{P#ÖM3Q#ÖêØ¤öÅÛ:ôm`ä¾Û                o  ) C o n t a c t s . t a r g e t s i z e - 6 4 _ c o n t r a s t - w h i t e . p n g                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  